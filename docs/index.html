<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Johan Hidding, Ben van Werkhoven, Netherlands eScience Center" />
  <title>FFT Synthesis for OpenCL on FPGA</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="css/bootstrap.css" />
  <link rel="stylesheet" href="css/mods.css" />
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  
  <!-- pandoc-eqnos: equation style -->
  <style>
    .eqnos { display: inline-block; position: relative; width: 100%; }
    .eqnos br { display: none; }
    .eqnos-number { position: absolute; right: 0em; top: 50%; line-height: 0; }
  </style>
<!-- <script data-main="scripts/main" src="js/require.js"></script> -->
  <!-- Load React. -->
  <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
<!--  <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script> -->


</head>
<body class="d-flex flex-column">

<nav id="TOC" class="navbar navbar-dark bg-dark">
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a href="#" class="ml-5 mr-auto navbar-brand">FFT Synthesis for OpenCL on FPGA<br><span style="font-size: smaller"> by <i>Johan Hidding, Ben van Werkhoven, Netherlands eScience Center</i></span></a>
<div class="collapse navbar-collapse" id="navbarSupportedContent">
<ul>
<li><a href="#about">About</a></li>
<li><a href="#cooley-tukey-algorithm">Cooley-Tukey algorithm</a></li>
<li><a href="#parity-splitting">Parity splitting</a></li>
<li><a href="#fused-multiply-add-codelets">Fused-Multiply-Add codelets</a></li>
<li><a href="#code-generator">Code generator</a></li>
</ul>
</div>
</nav>

<!-- <nav class="navbar navbar-dark navbar-expand-md bg-dark mb-4">
<p class="author">Johan Hidding, Ben van Werkhoven, Netherlands eScience Center</p>
</nav>
 -->

<main role="main" class="flex-fill"><div class="container my-5">
<h1 id="about">About</h1>
<h2 id="license">License</h2>
<p>Copyright 2020 Johan Hidding, Ben van Werkhoven, Netherlands eScience Center</p>
<blockquote>
<p>This template is licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>; you may not use this file except in compliance with the License. You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0</code></pre>
<p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an “AS IS” BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</p>
</blockquote>
<h2 id="version">Version</h2>
<div class="annotated-code">
<p><span><em>«fftsynth/__init__.py»=</em></span></p>
<div class="sourceCode" id="cb2" data-file="fftsynth/__init__.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>__version__ <span class="op">=</span> <span class="st">&quot;0.1.0&quot;</span></span></code></pre></div>
</div>
<h1 id="cooley-tukey-algorithm">Cooley-Tukey algorithm</h1>
<p>(sampled from Frigo 1999. I changed array indices to <span class="math inline">\(k, l, m\)</span>, <span class="math inline">\(n\)</span> denoting the length of the array.)</p>
<p>The (forward) discrete Fourier transform of <span class="math inline">\(X\)</span> is the array <span class="math inline">\(Y\)</span> given by</p>
<p><span id="eq:dft" class="eqnos"><span class="math display">\[Y[l] = \sum_{k=0}^{n-1} X[k] w_n^{-kl},\]</span><span class="eqnos-number">(1)</span></span> </p>
<p>where</p>
<p><span id="eq:wn" class="eqnos"><span class="math display">\[w_n = \exp\left(\frac{2\pi i}{n}\right).\]</span><span class="eqnos-number">(2)</span></span> </p>
<p>So <span class="math inline">\(w_n^{-kl}\)</span> denotes <span class="math inline">\(w_n\)</span> <em>to the power of</em> <span class="math inline">\(-kl\)</span>.</p>
<p>In the case that <span class="math inline">\(X\)</span> is real valued, <span class="math inline">\(Y\)</span> will have <em>hermitian symmetry</em></p>
<p><span id="eq:hermitian-symmetry" class="eqnos"><span class="math display">\[Y[n - k] = Y^*[k].\]</span><span class="eqnos-number">(3)</span></span> </p>
<p>The backward DFT flips the sign at the exponent of <span class="math inline">\(w_n\)</span>, giving</p>
<p><span id="eq:idft" class="eqnos"><span class="math display">\[Y[l] = \sum_{k=0}^{n-1} X[k] w_n^{kl}.\]</span><span class="eqnos-number">(4)</span></span> </p>
<p>Now suppose that <span class="math inline">\(n\)</span> can be factored into <span class="math inline">\(n = n_1 n_2\)</span>. We may now view the arrays <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> in a rectangular shape, where</p>
<p><span class="math display">\[X[k] = X[k_1 n_2 + k_2] = X[k_1, k_2].\]</span></p>
<p>Also, let <span class="math inline">\(Y\)</span> take the transposed shape of <span class="math inline">\(X\)</span>,</p>
<p><span class="math display">\[Y[l] = Y[l_1 + l_2 n_1] = Y[l_1, l_2].\]</span></p>
<p>Then eq. <a href="#eq:dft">1</a> can be written as</p>
<!-- $$Y[l_1, l_2] = \sum_{k_2 = 0}^{n_2 - 1} \left[\left(\sum_{k_1 = 0}^{n_1-1} X[k_1, k_2] w_{n_1}^{-k_1 l_1}\right) w_n^{l_1 k_2}\right] w_{n_2}^{-l_2 k_2}.$$ -->
<p><span class="math display">\[Y[l_2, l_1] = \sum_{k_2 = 0}^{n_2 - 1} \left[\underbrace{\left(\sum_{k_1 = 0}^{n_1-1} X[k_1, k_2] w_{n_1}^{-k_1 l_1}\right)}_{n_1\text{-point DFT}} \overbrace{\ w_n^{l_1 k_2}\ }^\text{twiddles}\right] w_{n_2}^{-l_2 k_2}.\]</span></p>
<p>Also known as the <strong>Cooley-Tukey fast Fourier transform</strong>.</p>
<p>This separates the DFT in an inner and outer transform, of sizes <span class="math inline">\(n_1\)</span> and <span class="math inline">\(n_2\)</span>. The output of the inner transform is multiplied by <strong>twiddle factors</strong> <span class="math inline">\(w_n^{-l_1 k_2}\)</span>, before the outer transform is done.</p>
<p>We approach the FFT algorithm by casting the array to an multi-dimensional array, where each dimension represents one step in the FFT.</p>
<div id="fig:cooley-tukey" class="fignos">
<figure>
<img src="img/cooley-tukey-20.svg" alt="" /><figcaption><span>Figure 1:</span> A <span class="math inline">\(N=20\)</span> Fourier transform is broken up into an <span class="math inline">\(5 \times 2 \times 2\)</span> fast Fourier transform.</figcaption>
</figure>
</div>
<p>Another way to illustrate the FFT algorithm is by visualising the data flow.</p>
<div id="fig:fft-dataflow" class="fignos">
<figure>
<img src="img/dataflow.svg" alt="" /><figcaption><span>Figure 2:</span> Data flow in a radix-2 FFT</figcaption>
</figure>
</div>
<p>We will refer to the smallest Fourier transform inside an FFT as a <strong>butterfly</strong> operation. In the case of a radix-2 FFT, as illustrated in Figure <a href="#fig:fft-dataflow">2</a>, this is the operation of performing a 2-FT on any two elements within the array, commonly including the multiplication with a twiddle factor.</p>
<h1 id="parity-splitting">Parity splitting</h1>
<h2 id="radix-n-data-streamlining">Radix-n data streamlining</h2>
<p>For a radix-2 FFT, it is possible to divide input data in such a way that every butterfly operation reads and writes to two different arrays in memory. This could be advantageous for an implementation on the FPGA. The trick is to separate data locations based on the parity of their index.</p>
<h3 id="parity">Parity</h3>
<p>The index of each element in the array can be written in binary. In the case of a radix-2 FFT, we can see the array being reshaped in a <span class="math inline">\([2, 2, 2, \dots]\)</span> shape. Every stage of the <span class="math inline">\(n=2^k\)</span> sized radix-2 FFT is being performed in a different dimension of the <span class="math inline">\(k\)</span>-dimensional reshaped array. The indexing in this multi-dimensional array is the same as the binary notation for the linear index. That means that each time the 2-FFT is performed, the multi-index of the elements involved will differ by one bit in the linear index. Separating the array based on the parity of the index will guarantee that each 2-FFT operation reads and writes one (complex) number from each set. The parity is the sum of all the individual bits, modulo 2.</p>
<p><span class="math display">\[P_2(i) = \left(\sum_k b_k\right) \mod 2,\quad {\rm where}\, i := \sum_k b_k 2^k\]</span></p>
<p>We can extend this concept to the radix-4 FFT, on 4 data channels.</p>
<h3 id="parity-1">4-parity</h3>
<p>In the radix-4 FFT we can view the array as being reshaped to a <span class="math inline">\([4, 4, 4, \dots]\)</span> shape. The multi-index into this array is equivalent to the quarternary number notation of the linear index. Similar to the radix-2 parity, we can define the radix-4 parity as the sum of each quarternary digit in the index, modulo 4.</p>
<p><span class="math display">\[P_4(i) = \left(\sum_k q_k\right) \mod 4,\quad {\rm where}\, i := \sum_k q_k 4^k\]</span></p>
<p>This would ensure that each 4-FFT reads its data from the 4 different input channels. We define the <code>parity</code> function to work with any radix:</p>
<div class="annotated-code">
<p><span><em>«fftsynth/parity.py»=</em></span></p>
<div class="sourceCode" id="cb3" data-file="fftsynth/parity.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="im">from</span> numba <span class="im">import</span> jit, vectorize</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="im">import</span> numpy <span class="im">as</span> np                  <span class="co"># type: ignore</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="im">import</span> math</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="im">from</span> itertools <span class="im">import</span> groupby</span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="im">from</span> typing <span class="im">import</span> List, Iterator, Sequence, Generator, Tuple</span>
<span id="cb3-10"><a href="#cb3-10"></a></span>
<span id="cb3-11"><a href="#cb3-11"></a></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="at">@jit</span>(nopython<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="kw">def</span> digits(n: <span class="bu">int</span>, i: <span class="bu">int</span>) <span class="op">-&gt;</span> Generator[<span class="bu">int</span>, <span class="va">None</span>, <span class="va">None</span>]:</span>
<span id="cb3-14"><a href="#cb3-14"></a>    <span class="co">&quot;&quot;&quot;Generates the n-numbered digits of i, in reverse order.&quot;&quot;&quot;</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb3-16"><a href="#cb3-16"></a>        <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb3-17"><a href="#cb3-17"></a>            <span class="cf">return</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>        <span class="cf">else</span>:</span>
<span id="cb3-19"><a href="#cb3-19"></a>            i, q <span class="op">=</span> <span class="bu">divmod</span>(i, n)</span>
<span id="cb3-20"><a href="#cb3-20"></a>            <span class="cf">yield</span> q</span>
<span id="cb3-21"><a href="#cb3-21"></a></span>
<span id="cb3-22"><a href="#cb3-22"></a></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="at">@vectorize</span>(nopython<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-24"><a href="#cb3-24"></a><span class="kw">def</span> parity(n: <span class="bu">int</span>, i: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb3-25"><a href="#cb3-25"></a>    <span class="co">&quot;&quot;&quot;Computes the n-parity of a number i.&quot;&quot;&quot;</span></span>
<span id="cb3-26"><a href="#cb3-26"></a>    x <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-27"><a href="#cb3-27"></a>    <span class="cf">for</span> j <span class="kw">in</span> digits(n, i):</span>
<span id="cb3-28"><a href="#cb3-28"></a>        x <span class="op">+=</span> j</span>
<span id="cb3-29"><a href="#cb3-29"></a>    <span class="cf">return</span> x <span class="op">%</span> n</span>
<span id="cb3-30"><a href="#cb3-30"></a></span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="op">&lt;&lt;</span>parity<span class="op">-</span>channels<span class="op">&gt;&gt;</span></span>
<span id="cb3-32"><a href="#cb3-32"></a><span class="op">&lt;&lt;</span>parity<span class="op">-</span>index<span class="op">-</span>functions<span class="op">&gt;&gt;</span></span>
<span id="cb3-33"><a href="#cb3-33"></a><span class="op">&lt;&lt;</span>parity<span class="op">-</span>splitting<span class="op">-</span>interface<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<p>Using the parity function we can determine which index belongs to which channel</p>
<div class="annotated-code">
<p><span><em>«parity-channels»=</em></span></p>
<div class="sourceCode" id="parity-channels"><pre class="sourceCode python"><code class="sourceCode python"><span id="parity-channels-1"><a href="#parity-channels-1"></a><span class="kw">def</span> channels(N: <span class="bu">int</span>, radix: <span class="bu">int</span>) <span class="op">-&gt;</span> Iterator[Tuple[<span class="bu">int</span>, Iterator[<span class="bu">int</span>]]]:</span>
<span id="parity-channels-2"><a href="#parity-channels-2"></a>    <span class="co">&quot;&quot;&quot;Given a 1-d contiguous array of size N, and a FFT of given radix,</span></span>
<span id="parity-channels-3"><a href="#parity-channels-3"></a><span class="co">    this returns a map of iterators of the different memory channels.&quot;&quot;&quot;</span></span>
<span id="parity-channels-4"><a href="#parity-channels-4"></a>    parity_r <span class="op">=</span> partial(parity, radix)</span>
<span id="parity-channels-5"><a href="#parity-channels-5"></a>    <span class="cf">return</span> groupby(<span class="bu">sorted</span>(<span class="bu">range</span>(N), key<span class="op">=</span>parity_r), parity_r)</span></code></pre></div>
</div>
<p>For instance, for radix-2, size 16, this creates the following channels</p>
<div class="annotated-code">
<p><span><em>«parity»=</em></span></p>
<div class="doctest" data-status="SUCCESS">
<div class="doctestInput">
<div class="sourceCode" id="parity"><pre class="sourceCode python eval"><code class="sourceCode python"><span id="parity-1"><a href="#parity-1"></a><span class="im">from</span> fftsynth.parity <span class="im">import</span> channels</span>
<span id="parity-2"><a href="#parity-2"></a></span>
<span id="parity-3"><a href="#parity-3"></a><span class="cf">for</span> (g, i) <span class="kw">in</span> channels(<span class="dv">16</span>, <span class="dv">2</span>):</span>
<span id="parity-4"><a href="#parity-4"></a>    <span class="bu">print</span>(g, <span class="bu">list</span>(i))</span></code></pre></div>
</div>
<div class="doctestResult">
<div class="sourceCode" id="cb4"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb4-1"><a href="#cb4-1"></a>0 [0, 3, 5, 6, 9, 10, 12, 15]</span>
<span id="cb4-2"><a href="#cb4-2"></a>1 [1, 2, 4, 7, 8, 11, 13, 14]</span></code></pre></div>
</div>
</div>
</div>
<p>and for a radix-4, size 64 fft, this creates the following channels</p>
<div class="annotated-code">
<p><span><em>«parity»+</em></span></p>
<div class="doctest" data-status="SUCCESS">
<div class="doctestInput">
<div class="sourceCode" id="parity"><pre class="sourceCode python eval"><code class="sourceCode python"><span id="parity-1"><a href="#parity-1"></a><span class="cf">for</span> (g, i) <span class="kw">in</span> channels(<span class="dv">64</span>, <span class="dv">4</span>):</span>
<span id="parity-2"><a href="#parity-2"></a>    <span class="bu">print</span>(g, <span class="bu">list</span>(i))</span></code></pre></div>
</div>
<div class="doctestResult">
<div class="sourceCode" id="cb5"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb5-1"><a href="#cb5-1"></a>0 [0, 7, 10, 13, 19, 22, 25, 28, 34, 37, 40, 47, 49, 52, 59, 62]</span>
<span id="cb5-2"><a href="#cb5-2"></a>1 [1, 4, 11, 14, 16, 23, 26, 29, 35, 38, 41, 44, 50, 53, 56, 63]</span>
<span id="cb5-3"><a href="#cb5-3"></a>2 [2, 5, 8, 15, 17, 20, 27, 30, 32, 39, 42, 45, 51, 54, 57, 60]</span>
<span id="cb5-4"><a href="#cb5-4"></a>3 [3, 6, 9, 12, 18, 21, 24, 31, 33, 36, 43, 46, 48, 55, 58, 61]</span></code></pre></div>
</div>
</div>
</div>
<h2 id="twiddles">Twiddles</h2>
<div class="annotated-code">
<p><span><em>«fftsynth/twiddle.py»=</em></span></p>
<div class="sourceCode" id="cb6" data-file="fftsynth/twiddle.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="op">&lt;&lt;</span>make<span class="op">-</span>twiddle<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«make-twiddle»=</em></span></p>
<div class="sourceCode" id="make-twiddle"><pre class="sourceCode python"><code class="sourceCode python"><span id="make-twiddle-1"><a href="#make-twiddle-1"></a><span class="kw">def</span> make_twiddle(n1, n2):</span>
<span id="make-twiddle-2"><a href="#make-twiddle-2"></a>    <span class="kw">def</span> w(k, n):</span>
<span id="make-twiddle-3"><a href="#make-twiddle-3"></a>        <span class="cf">return</span> np.exp(2j <span class="op">*</span> np.pi <span class="op">*</span> k <span class="op">/</span> n)</span>
<span id="make-twiddle-4"><a href="#make-twiddle-4"></a></span>
<span id="make-twiddle-5"><a href="#make-twiddle-5"></a>    I1 <span class="op">=</span> np.arange(n1)</span>
<span id="make-twiddle-6"><a href="#make-twiddle-6"></a>    I2 <span class="op">=</span> np.arange(n2)</span>
<span id="make-twiddle-7"><a href="#make-twiddle-7"></a>    <span class="cf">return</span> w(I1[:,<span class="va">None</span>] <span class="op">*</span> I2[<span class="va">None</span>,:], n1<span class="op">*</span>n2).astype(<span class="st">&#39;complex64&#39;</span>)</span></code></pre></div>
</div>
<h2 id="radix-4-fft-example">Radix-4 FFT example</h2>
<p>The radix-4 FFT, takes four elements in every butterfly operation, along with four weights.</p>
<div class="annotated-code">
<p><span><em>«fft-ps-4»=</em></span></p>
<div class="sourceCode" id="fft-ps-4"><pre class="sourceCode python"><code class="sourceCode python"><span id="fft-ps-4-1"><a href="#fft-ps-4-1"></a><span class="kw">def</span> fft4(x0, x1, x2, x3, w0<span class="op">=</span><span class="dv">1</span>, w1<span class="op">=</span><span class="dv">1</span>, w2<span class="op">=</span><span class="dv">1</span>, w3<span class="op">=</span><span class="dv">1</span>):</span>
<span id="fft-ps-4-2"><a href="#fft-ps-4-2"></a>    a <span class="op">=</span> w0<span class="op">*</span>x0 <span class="op">+</span> w2<span class="op">*</span>x2</span>
<span id="fft-ps-4-3"><a href="#fft-ps-4-3"></a>    b <span class="op">=</span> w1<span class="op">*</span>x1 <span class="op">+</span> w3<span class="op">*</span>x3</span>
<span id="fft-ps-4-4"><a href="#fft-ps-4-4"></a>    c <span class="op">=</span> w0<span class="op">*</span>x0 <span class="op">-</span> w2<span class="op">*</span>x2</span>
<span id="fft-ps-4-5"><a href="#fft-ps-4-5"></a>    d <span class="op">=</span> w1<span class="op">*</span>x1 <span class="op">-</span> w3<span class="op">*</span>x3</span>
<span id="fft-ps-4-6"><a href="#fft-ps-4-6"></a>    x0[:] <span class="op">=</span> a <span class="op">+</span> b</span>
<span id="fft-ps-4-7"><a href="#fft-ps-4-7"></a>    x1[:] <span class="op">=</span> c <span class="op">-</span><span class="ot"> 1j</span><span class="op">*</span>d</span>
<span id="fft-ps-4-8"><a href="#fft-ps-4-8"></a>    x2[:] <span class="op">=</span> a <span class="op">-</span> b</span>
<span id="fft-ps-4-9"><a href="#fft-ps-4-9"></a>    x3[:] <span class="op">=</span> c <span class="op">+</span><span class="ot"> 1j</span><span class="op">*</span>d</span></code></pre></div>
</div>
<p>We’ll perform a <span class="math inline">\(N=64\)</span> FFT,</p>
<div class="annotated-code">
<p><span><em>«fft-ps-4»+</em></span></p>
<div class="sourceCode" id="fft-ps-4"><pre class="sourceCode python"><code class="sourceCode python"><span id="fft-ps-4-1"><a href="#fft-ps-4-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="fft-ps-4-2"><a href="#fft-ps-4-2"></a>np.set_printoptions(precision<span class="op">=</span><span class="dv">4</span>)</span>
<span id="fft-ps-4-3"><a href="#fft-ps-4-3"></a></span>
<span id="fft-ps-4-4"><a href="#fft-ps-4-4"></a><span class="im">from</span> fftsynth.parity <span class="im">import</span> ParitySplitting</span>
<span id="fft-ps-4-5"><a href="#fft-ps-4-5"></a><span class="im">from</span> fftsynth.twiddle <span class="im">import</span> make_twiddle</span>
<span id="fft-ps-4-6"><a href="#fft-ps-4-6"></a></span>
<span id="fft-ps-4-7"><a href="#fft-ps-4-7"></a>PS <span class="op">=</span> ParitySplitting(<span class="dv">64</span>, <span class="dv">4</span>)</span>
<span id="fft-ps-4-8"><a href="#fft-ps-4-8"></a>x <span class="op">=</span> np.fft.ifft(np.arange(<span class="dv">0</span>, PS.N, dtype<span class="op">=</span><span class="st">&#39;complex64&#39;</span>))</span></code></pre></div>
</div>
<p>We reshape the input data, and transpose the result</p>
<div class="annotated-code">
<p><span><em>«fft-ps-4»+</em></span></p>
<div class="sourceCode" id="fft-ps-4"><pre class="sourceCode python"><code class="sourceCode python"><span id="fft-ps-4-1"><a href="#fft-ps-4-1"></a>s <span class="op">=</span> x.copy().reshape(PS.factors).transpose()</span></code></pre></div>
</div>
<p>Then the transform looks like</p>
<div class="annotated-code">
<p><span><em>«fft-ps-4»+</em></span></p>
<div class="sourceCode" id="fft-ps-4"><pre class="sourceCode python"><code class="sourceCode python"><span id="fft-ps-4-1"><a href="#fft-ps-4-1"></a><span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(PS.factors)):</span>
<span id="fft-ps-4-2"><a href="#fft-ps-4-2"></a>    w <span class="op">=</span> make_twiddle(<span class="dv">4</span>, <span class="dv">4</span><span class="op">**</span>k).conj()[:,:]</span>
<span id="fft-ps-4-3"><a href="#fft-ps-4-3"></a>    z <span class="op">=</span> s.reshape([<span class="op">-</span><span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">4</span><span class="op">**</span>k])</span>
<span id="fft-ps-4-4"><a href="#fft-ps-4-4"></a>    z <span class="op">*=</span> w</span>
<span id="fft-ps-4-5"><a href="#fft-ps-4-5"></a>    fft4(<span class="op">*</span>(z[..., l, :] <span class="cf">for</span> l <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>)))</span>
<span id="fft-ps-4-6"><a href="#fft-ps-4-6"></a>    s <span class="op">=</span> z</span></code></pre></div>
</div>
<p>In every step, we multiply with twiddles, select a dimension to transform over and perform the butterfly.</p>
<div class="annotated-code">
<p><span><em>«fft-ps-4»+</em></span></p>
<div class="doctest" data-status="SUCCESS">
<div class="doctestInput">
<div class="sourceCode" id="fft-ps-4"><pre class="sourceCode python eval"><code class="sourceCode python"><span id="fft-ps-4-1"><a href="#fft-ps-4-1"></a><span class="bu">print</span>(s.flatten().real)</span></code></pre></div>
</div>
<div class="doctestResult">
<div class="sourceCode" id="cb7"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb7-1"><a href="#cb7-1"></a>[ 0.  1.  2.  3.  4.  5.  6.  7.  8.  9. 10. 11. 12. 13. 14. 15. 16. 17.</span>
<span id="cb7-2"><a href="#cb7-2"></a> 18. 19. 20. 21. 22. 23. 24. 25. 26. 27. 28. 29. 30. 31. 32. 33. 34. 35.</span>
<span id="cb7-3"><a href="#cb7-3"></a> 36. 37. 38. 39. 40. 41. 42. 43. 44. 45. 46. 47. 48. 49. 50. 51. 52. 53.</span>
<span id="cb7-4"><a href="#cb7-4"></a> 54. 55. 56. 57. 58. 59. 60. 61. 62. 63.]</span></code></pre></div>
</div>
</div>
</div>
<h2 id="index-functions">Index functions</h2>
<div class="annotated-code">
<p><span><em>«parity-index-functions»=</em></span></p>
<div class="sourceCode" id="parity-index-functions"><pre class="sourceCode python"><code class="sourceCode python"><span id="parity-index-functions-1"><a href="#parity-index-functions-1"></a><span class="kw">def</span> comp_idx(radix: <span class="bu">int</span>, i: <span class="bu">int</span>, j: <span class="bu">int</span>, k: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="parity-index-functions-2"><a href="#parity-index-functions-2"></a>    base <span class="op">=</span> (i <span class="op">&amp;</span> <span class="op">~</span>(radix<span class="op">**</span>k <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="parity-index-functions-3"><a href="#parity-index-functions-3"></a>    rem  <span class="op">=</span> (i <span class="op">&amp;</span>  (radix<span class="op">**</span>k <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="parity-index-functions-4"><a href="#parity-index-functions-4"></a>    <span class="cf">return</span> rem <span class="op">+</span> j <span class="op">*</span> radix<span class="op">**</span>k <span class="op">+</span> base <span class="op">*</span> radix</span>
<span id="parity-index-functions-5"><a href="#parity-index-functions-5"></a></span>
<span id="parity-index-functions-6"><a href="#parity-index-functions-6"></a></span>
<span id="parity-index-functions-7"><a href="#parity-index-functions-7"></a><span class="kw">def</span> comp_perm(radix: <span class="bu">int</span>, i: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="parity-index-functions-8"><a href="#parity-index-functions-8"></a>    base <span class="op">=</span> (i <span class="op">&amp;</span> <span class="op">~</span>(radix <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="parity-index-functions-9"><a href="#parity-index-functions-9"></a>    rem <span class="op">=</span> (i <span class="op">&amp;</span> (radix <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="parity-index-functions-10"><a href="#parity-index-functions-10"></a>    p <span class="op">=</span> parity(radix, base)</span>
<span id="parity-index-functions-11"><a href="#parity-index-functions-11"></a>    <span class="cf">return</span> base <span class="op">|</span> ((rem <span class="op">-</span> p) <span class="op">%</span> radix)</span></code></pre></div>
</div>
<h2 id="properties">Properties</h2>
<p>This interface should ease the implementation of the parity-splitting FFT.</p>
<div class="fold-block">
<button class="btn btn-outline-primary btn-sm fold-toggle" type="button" data-toggle="collapse" data-target="#parity-splitting-interface-container" aria-controls="parity-splitting-interface-container">&lt;&lt;parity-splitting-interface&gt;&gt;=</button>
<div id="parity-splitting-interface-container" class="collapse">
<div class="sourceCode" id="parity-splitting-interface" style="max-height: 50vh"><pre class="sourceCode python bootstrap-fold overflow-auto"><code class="sourceCode python"><span id="parity-splitting-interface-1"><a href="#parity-splitting-interface-1"></a><span class="at">@dataclass</span></span>
<span id="parity-splitting-interface-2"><a href="#parity-splitting-interface-2"></a><span class="kw">class</span> ParitySplitting:</span>
<span id="parity-splitting-interface-3"><a href="#parity-splitting-interface-3"></a>    <span class="co">&quot;&quot;&quot;Collects a lot of properties on the parity-splitting FFT algorithm.</span></span>
<span id="parity-splitting-interface-4"><a href="#parity-splitting-interface-4"></a><span class="co">    This algorithm splits memory access for radix-n algorithms into n</span></span>
<span id="parity-splitting-interface-5"><a href="#parity-splitting-interface-5"></a><span class="co">    chunks, such that each chunk is only accessed once for each butterfly</span></span>
<span id="parity-splitting-interface-6"><a href="#parity-splitting-interface-6"></a><span class="co">    operation. Pseudo code:</span></span>
<span id="parity-splitting-interface-7"><a href="#parity-splitting-interface-7"></a></span>
<span id="parity-splitting-interface-8"><a href="#parity-splitting-interface-8"></a><span class="co">        for k in range(depth):</span></span>
<span id="parity-splitting-interface-9"><a href="#parity-splitting-interface-9"></a><span class="co">            for i in range(L):</span></span>
<span id="parity-splitting-interface-10"><a href="#parity-splitting-interface-10"></a><span class="co">                for j in range(radix):</span></span>
<span id="parity-splitting-interface-11"><a href="#parity-splitting-interface-11"></a><span class="co">                    fft(*permute(chunks), W)</span></span>
<span id="parity-splitting-interface-12"><a href="#parity-splitting-interface-12"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="parity-splitting-interface-13"><a href="#parity-splitting-interface-13"></a>    N: <span class="bu">int</span></span>
<span id="parity-splitting-interface-14"><a href="#parity-splitting-interface-14"></a>    radix: <span class="bu">int</span></span>
<span id="parity-splitting-interface-15"><a href="#parity-splitting-interface-15"></a></span>
<span id="parity-splitting-interface-16"><a href="#parity-splitting-interface-16"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-17"><a href="#parity-splitting-interface-17"></a>    <span class="kw">def</span> depth(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="parity-splitting-interface-18"><a href="#parity-splitting-interface-18"></a>        <span class="co">&quot;&quot;&quot;radix-log of FFT size&quot;&quot;&quot;</span></span>
<span id="parity-splitting-interface-19"><a href="#parity-splitting-interface-19"></a>        <span class="cf">return</span> <span class="bu">int</span>(math.log(<span class="va">self</span>.N, <span class="va">self</span>.radix))</span>
<span id="parity-splitting-interface-20"><a href="#parity-splitting-interface-20"></a></span>
<span id="parity-splitting-interface-21"><a href="#parity-splitting-interface-21"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-22"><a href="#parity-splitting-interface-22"></a>    <span class="kw">def</span> M(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="parity-splitting-interface-23"><a href="#parity-splitting-interface-23"></a>        <span class="co">&quot;&quot;&quot;N // radix&quot;&quot;&quot;</span></span>
<span id="parity-splitting-interface-24"><a href="#parity-splitting-interface-24"></a>        <span class="cf">return</span> <span class="va">self</span>.N<span class="op">//</span><span class="va">self</span>.radix</span>
<span id="parity-splitting-interface-25"><a href="#parity-splitting-interface-25"></a></span>
<span id="parity-splitting-interface-26"><a href="#parity-splitting-interface-26"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-27"><a href="#parity-splitting-interface-27"></a>    <span class="kw">def</span> L(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="parity-splitting-interface-28"><a href="#parity-splitting-interface-28"></a>        <span class="co">&quot;&quot;&quot;N // radix**2&quot;&quot;&quot;</span></span>
<span id="parity-splitting-interface-29"><a href="#parity-splitting-interface-29"></a>        <span class="cf">return</span> <span class="va">self</span>.M<span class="op">//</span><span class="va">self</span>.radix</span>
<span id="parity-splitting-interface-30"><a href="#parity-splitting-interface-30"></a></span>
<span id="parity-splitting-interface-31"><a href="#parity-splitting-interface-31"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-32"><a href="#parity-splitting-interface-32"></a>    <span class="kw">def</span> factors(<span class="va">self</span>) <span class="op">-&gt;</span> List[<span class="bu">int</span>]:</span>
<span id="parity-splitting-interface-33"><a href="#parity-splitting-interface-33"></a>        <span class="co">&quot;&quot;&quot;Shape of FFT&quot;&quot;&quot;</span></span>
<span id="parity-splitting-interface-34"><a href="#parity-splitting-interface-34"></a>        <span class="cf">return</span> [<span class="va">self</span>.radix] <span class="op">*</span> <span class="va">self</span>.depth</span>
<span id="parity-splitting-interface-35"><a href="#parity-splitting-interface-35"></a></span>
<span id="parity-splitting-interface-36"><a href="#parity-splitting-interface-36"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-37"><a href="#parity-splitting-interface-37"></a>    <span class="kw">def</span> channels(<span class="va">self</span>) <span class="op">-&gt;</span> Iterator[Tuple[<span class="bu">int</span>, Iterator[<span class="bu">int</span>]]]:</span>
<span id="parity-splitting-interface-38"><a href="#parity-splitting-interface-38"></a>        <span class="co">&quot;&quot;&quot;Pattern for memory chunks&quot;&quot;&quot;</span></span>
<span id="parity-splitting-interface-39"><a href="#parity-splitting-interface-39"></a>        <span class="cf">return</span> channels(<span class="va">self</span>.N, <span class="va">self</span>.radix)</span>
<span id="parity-splitting-interface-40"><a href="#parity-splitting-interface-40"></a></span>
<span id="parity-splitting-interface-41"><a href="#parity-splitting-interface-41"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-42"><a href="#parity-splitting-interface-42"></a>    <span class="kw">def</span> channel_loc(<span class="va">self</span>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="parity-splitting-interface-43"><a href="#parity-splitting-interface-43"></a>        x <span class="op">=</span> np.zeros(shape<span class="op">=</span>(<span class="va">self</span>.N,), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="parity-splitting-interface-44"><a href="#parity-splitting-interface-44"></a>        <span class="cf">for</span> g, i <span class="kw">in</span> <span class="va">self</span>.channels:</span>
<span id="parity-splitting-interface-45"><a href="#parity-splitting-interface-45"></a>            x[<span class="bu">list</span>(i)] <span class="op">=</span> g</span>
<span id="parity-splitting-interface-46"><a href="#parity-splitting-interface-46"></a>        <span class="cf">return</span> x.reshape(<span class="va">self</span>.factors)</span>
<span id="parity-splitting-interface-47"><a href="#parity-splitting-interface-47"></a></span>
<span id="parity-splitting-interface-48"><a href="#parity-splitting-interface-48"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-49"><a href="#parity-splitting-interface-49"></a>    <span class="kw">def</span> index_loc(<span class="va">self</span>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="parity-splitting-interface-50"><a href="#parity-splitting-interface-50"></a>        x <span class="op">=</span> np.zeros(shape<span class="op">=</span>(<span class="va">self</span>.N,), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="parity-splitting-interface-51"><a href="#parity-splitting-interface-51"></a>        <span class="cf">for</span> g, i <span class="kw">in</span> <span class="va">self</span>.channels:</span>
<span id="parity-splitting-interface-52"><a href="#parity-splitting-interface-52"></a>            x[<span class="bu">list</span>(i)] <span class="op">=</span> np.arange(<span class="va">self</span>.M, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="parity-splitting-interface-53"><a href="#parity-splitting-interface-53"></a>        <span class="cf">return</span> x.reshape(<span class="va">self</span>.factors)</span>
<span id="parity-splitting-interface-54"><a href="#parity-splitting-interface-54"></a></span>
<span id="parity-splitting-interface-55"><a href="#parity-splitting-interface-55"></a>    <span class="kw">def</span> mix(<span class="va">self</span>, x: np.ndarray) <span class="op">-&gt;</span> List[np.ndarray]:</span>
<span id="parity-splitting-interface-56"><a href="#parity-splitting-interface-56"></a>        <span class="cf">return</span> [x[<span class="bu">list</span>(i)].copy() <span class="cf">for</span> g, i <span class="kw">in</span> <span class="va">self</span>.channels]</span>
<span id="parity-splitting-interface-57"><a href="#parity-splitting-interface-57"></a></span>
<span id="parity-splitting-interface-58"><a href="#parity-splitting-interface-58"></a>    <span class="kw">def</span> unmix(<span class="va">self</span>, s: Sequence[np.ndarray]) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="parity-splitting-interface-59"><a href="#parity-splitting-interface-59"></a>        x <span class="op">=</span> np.zeros(shape<span class="op">=</span>(<span class="va">self</span>.N,), dtype<span class="op">=</span><span class="st">&#39;complex64&#39;</span>)</span>
<span id="parity-splitting-interface-60"><a href="#parity-splitting-interface-60"></a>        <span class="cf">for</span> g, i <span class="kw">in</span> <span class="va">self</span>.channels:</span>
<span id="parity-splitting-interface-61"><a href="#parity-splitting-interface-61"></a>            x[<span class="bu">list</span>(i)] <span class="op">=</span> s[g]</span>
<span id="parity-splitting-interface-62"><a href="#parity-splitting-interface-62"></a>        <span class="cf">return</span> x</span></code></pre></div>
</div>
</div>
<h2 id="testing">Testing</h2>
<div class="fold-block">
<button class="btn btn-outline-primary btn-sm fold-toggle" type="button" data-toggle="collapse" data-target="#test-slash-test_radix_4_ps-dot-py-container" aria-controls="test-slash-test_radix_4_ps-dot-py-container">&lt;&lt;test/test_radix_4_ps.py&gt;&gt;=</button>
<div id="test-slash-test_radix_4_ps-dot-py-container" class="collapse">
<div class="sourceCode" id="cb8" data-file="test/test_radix_4_ps.py" style="max-height: 50vh"><pre class="sourceCode python bootstrap-fold overflow-auto"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="im">import</span> pytest               <span class="co"># type: ignore</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="im">import</span> pyopencl <span class="im">as</span> cl       <span class="co"># type: ignore</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="im">import</span> pyopencl.cltypes     <span class="co"># type: ignore</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="im">import</span> numpy <span class="im">as</span> np          <span class="co"># type: ignore</span></span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="im">from</span> fftsynth.parity <span class="im">import</span> parity</span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="im">from</span> fftsynth.parity <span class="im">import</span> ParitySplitting, comp_idx, comp_perm</span>
<span id="cb8-8"><a href="#cb8-8"></a></span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a>N <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>radix <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>mc <span class="op">=</span> ParitySplitting(N, radix)</span>
<span id="cb8-13"><a href="#cb8-13"></a>mf <span class="op">=</span> cl.mem_flags</span>
<span id="cb8-14"><a href="#cb8-14"></a></span>
<span id="cb8-15"><a href="#cb8-15"></a></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="at">@pytest.fixture</span></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="kw">def</span> program(cl_context):</span>
<span id="cb8-18"><a href="#cb8-18"></a>    kernel <span class="op">=</span> <span class="bu">open</span>(<span class="st">&quot;test/fft1024.cl&quot;</span>, <span class="st">&quot;r&quot;</span>).read()</span>
<span id="cb8-19"><a href="#cb8-19"></a>    prog <span class="op">=</span> cl.Program(cl_context, kernel).build([<span class="st">&quot;-DTESTING&quot;</span>])</span>
<span id="cb8-20"><a href="#cb8-20"></a>    <span class="cf">return</span> prog</span>
<span id="cb8-21"><a href="#cb8-21"></a></span>
<span id="cb8-22"><a href="#cb8-22"></a></span>
<span id="cb8-23"><a href="#cb8-23"></a><span class="kw">def</span> test_parity_4(cl_context, program):</span>
<span id="cb8-24"><a href="#cb8-24"></a>    queue <span class="op">=</span> cl.CommandQueue(cl_context)</span>
<span id="cb8-25"><a href="#cb8-25"></a>    x <span class="op">=</span> np.arange(N, dtype<span class="op">=</span>cl.cltypes.<span class="bu">int</span>)</span>
<span id="cb8-26"><a href="#cb8-26"></a>    y <span class="op">=</span> np.zeros_like(x)</span>
<span id="cb8-27"><a href="#cb8-27"></a>    x_g <span class="op">=</span> cl.Buffer(cl_context, mf.READ_ONLY <span class="op">|</span> mf.COPY_HOST_PTR, hostbuf<span class="op">=</span>x)</span>
<span id="cb8-28"><a href="#cb8-28"></a>    y_g <span class="op">=</span> cl.Buffer(cl_context, mf.WRITE_ONLY, x.nbytes)</span>
<span id="cb8-29"><a href="#cb8-29"></a>    program.test_parity_4(queue, (N,), <span class="va">None</span>, x_g, y_g)</span>
<span id="cb8-30"><a href="#cb8-30"></a>    cl.enqueue_copy(queue, y, y_g)</span>
<span id="cb8-31"><a href="#cb8-31"></a></span>
<span id="cb8-32"><a href="#cb8-32"></a>    y_ref <span class="op">=</span> np.array([parity(radix, i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N)]) </span>
<span id="cb8-33"><a href="#cb8-33"></a>    <span class="cf">assert</span> np.<span class="bu">all</span>(y <span class="op">==</span> y_ref)</span>
<span id="cb8-34"><a href="#cb8-34"></a></span>
<span id="cb8-35"><a href="#cb8-35"></a></span>
<span id="cb8-36"><a href="#cb8-36"></a><span class="kw">def</span> test_comp_idx_4(cl_context, program):</span>
<span id="cb8-37"><a href="#cb8-37"></a>    queue <span class="op">=</span> cl.CommandQueue(cl_context)</span>
<span id="cb8-38"><a href="#cb8-38"></a>    x <span class="op">=</span> np.arange(mc.L, dtype<span class="op">=</span>cl.cltypes.<span class="bu">int</span>)</span>
<span id="cb8-39"><a href="#cb8-39"></a>    y <span class="op">=</span> np.zeros_like(x)</span>
<span id="cb8-40"><a href="#cb8-40"></a>    x_g <span class="op">=</span> cl.Buffer(cl_context, mf.READ_ONLY <span class="op">|</span> mf.COPY_HOST_PTR, hostbuf<span class="op">=</span>x)</span>
<span id="cb8-41"><a href="#cb8-41"></a>    y_g <span class="op">=</span> cl.Buffer(cl_context, mf.WRITE_ONLY, x.nbytes)</span>
<span id="cb8-42"><a href="#cb8-42"></a></span>
<span id="cb8-43"><a href="#cb8-43"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">5</span>):</span>
<span id="cb8-44"><a href="#cb8-44"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb8-45"><a href="#cb8-45"></a>            program.test_comp_idx_4(</span>
<span id="cb8-46"><a href="#cb8-46"></a>                queue, (mc.L,), <span class="va">None</span>,</span>
<span id="cb8-47"><a href="#cb8-47"></a>                cl.cltypes.<span class="bu">int</span>(k), cl.cltypes.<span class="bu">int</span>(j), x_g, y_g)</span>
<span id="cb8-48"><a href="#cb8-48"></a>            cl.enqueue_copy(queue, y, y_g)</span>
<span id="cb8-49"><a href="#cb8-49"></a></span>
<span id="cb8-50"><a href="#cb8-50"></a>            y_ref <span class="op">=</span> mc.index_loc <span class="op">\</span></span>
<span id="cb8-51"><a href="#cb8-51"></a>                .reshape([<span class="op">-</span><span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">4</span><span class="op">**</span>k]) <span class="op">\</span></span>
<span id="cb8-52"><a href="#cb8-52"></a>                .transpose([<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>]) <span class="op">\</span></span>
<span id="cb8-53"><a href="#cb8-53"></a>                .reshape([<span class="op">-</span><span class="dv">1</span>, <span class="dv">4</span>])[::<span class="dv">4</span>, j]</span>
<span id="cb8-54"><a href="#cb8-54"></a>            y_ref_2 <span class="op">=</span> np.array([comp_idx(<span class="dv">4</span>, i, j, k<span class="dv">-1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(mc.L)])</span>
<span id="cb8-55"><a href="#cb8-55"></a>            <span class="cf">assert</span> np.<span class="bu">all</span>(y <span class="op">==</span> y_ref)</span>
<span id="cb8-56"><a href="#cb8-56"></a>            <span class="cf">assert</span> np.<span class="bu">all</span>(y <span class="op">==</span> y_ref_2)</span>
<span id="cb8-57"><a href="#cb8-57"></a></span>
<span id="cb8-58"><a href="#cb8-58"></a></span>
<span id="cb8-59"><a href="#cb8-59"></a><span class="kw">def</span> test_comp_perm_4(cl_context, program):</span>
<span id="cb8-60"><a href="#cb8-60"></a>    queue <span class="op">=</span> cl.CommandQueue(cl_context)</span>
<span id="cb8-61"><a href="#cb8-61"></a>    x <span class="op">=</span> np.arange(mc.L, dtype<span class="op">=</span>cl.cltypes.<span class="bu">int</span>)</span>
<span id="cb8-62"><a href="#cb8-62"></a>    y <span class="op">=</span> np.zeros_like(x)</span>
<span id="cb8-63"><a href="#cb8-63"></a>    x_g <span class="op">=</span> cl.Buffer(cl_context, mf.READ_ONLY <span class="op">|</span> mf.COPY_HOST_PTR, hostbuf<span class="op">=</span>x)</span>
<span id="cb8-64"><a href="#cb8-64"></a>    y_g <span class="op">=</span> cl.Buffer(cl_context, mf.WRITE_ONLY, x.nbytes)</span>
<span id="cb8-65"><a href="#cb8-65"></a></span>
<span id="cb8-66"><a href="#cb8-66"></a>    <span class="cf">for</span> r <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb8-67"><a href="#cb8-67"></a>        program.test_comp_perm_4(queue, (mc.L,), <span class="va">None</span>, cl.cltypes.<span class="bu">int</span>(r), x_g, y_g)</span>
<span id="cb8-68"><a href="#cb8-68"></a>        cl.enqueue_copy(queue, y, y_g)</span>
<span id="cb8-69"><a href="#cb8-69"></a></span>
<span id="cb8-70"><a href="#cb8-70"></a>        y_ref <span class="op">=</span> np.array([comp_perm(radix, i<span class="op">*</span>radix <span class="op">+</span> r) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(mc.L)])</span>
<span id="cb8-71"><a href="#cb8-71"></a>        <span class="cf">assert</span> np.<span class="bu">all</span>(y <span class="op">==</span> y_ref)</span>
<span id="cb8-72"><a href="#cb8-72"></a></span>
<span id="cb8-73"><a href="#cb8-73"></a></span>
<span id="cb8-74"><a href="#cb8-74"></a><span class="kw">def</span> test_transpose_4(cl_context, program):</span>
<span id="cb8-75"><a href="#cb8-75"></a>    queue <span class="op">=</span> cl.CommandQueue(cl_context)</span>
<span id="cb8-76"><a href="#cb8-76"></a>    x <span class="op">=</span> np.arange(N, dtype<span class="op">=</span>cl.cltypes.<span class="bu">int</span>)</span>
<span id="cb8-77"><a href="#cb8-77"></a>    y <span class="op">=</span> np.zeros_like(x)</span>
<span id="cb8-78"><a href="#cb8-78"></a>    x_g <span class="op">=</span> cl.Buffer(cl_context, mf.READ_ONLY <span class="op">|</span> mf.COPY_HOST_PTR, hostbuf<span class="op">=</span>x)</span>
<span id="cb8-79"><a href="#cb8-79"></a>    y_g <span class="op">=</span> cl.Buffer(cl_context, mf.WRITE_ONLY, x.nbytes)</span>
<span id="cb8-80"><a href="#cb8-80"></a>    program.test_transpose_4(queue, (N,), <span class="va">None</span>, x_g, y_g)</span>
<span id="cb8-81"><a href="#cb8-81"></a>    cl.enqueue_copy(queue, y, y_g)</span>
<span id="cb8-82"><a href="#cb8-82"></a></span>
<span id="cb8-83"><a href="#cb8-83"></a>    y_ref <span class="op">=</span> x.reshape(mc.factors).T.flatten()</span>
<span id="cb8-84"><a href="#cb8-84"></a>    <span class="cf">assert</span> np.<span class="bu">all</span>(y <span class="op">==</span> y_ref)</span>
<span id="cb8-85"><a href="#cb8-85"></a></span>
<span id="cb8-86"><a href="#cb8-86"></a></span>
<span id="cb8-87"><a href="#cb8-87"></a><span class="kw">def</span> test_fft4_4(cl_context, program):</span>
<span id="cb8-88"><a href="#cb8-88"></a>    queue <span class="op">=</span> cl.CommandQueue(cl_context)</span>
<span id="cb8-89"><a href="#cb8-89"></a>    x <span class="op">=</span> np.random.normal(size<span class="op">=</span>(<span class="dv">1024</span>, <span class="dv">4</span>, <span class="dv">2</span>)).astype(cl.cltypes.<span class="bu">float</span>)</span>
<span id="cb8-90"><a href="#cb8-90"></a>    y <span class="op">=</span> np.zeros_like(x)</span>
<span id="cb8-91"><a href="#cb8-91"></a>    x_g <span class="op">=</span> cl.Buffer(cl_context, mf.READ_ONLY <span class="op">|</span> mf.COPY_HOST_PTR, hostbuf<span class="op">=</span>x)</span>
<span id="cb8-92"><a href="#cb8-92"></a>    y_g <span class="op">=</span> cl.Buffer(cl_context, mf.WRITE_ONLY, x.nbytes)</span>
<span id="cb8-93"><a href="#cb8-93"></a></span>
<span id="cb8-94"><a href="#cb8-94"></a>    <span class="cf">for</span> cycle <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb8-95"><a href="#cb8-95"></a>        y_ref <span class="op">=</span> np.fft.fft(np.roll(x[...,<span class="dv">0</span>]<span class="op">+</span>1j<span class="op">*</span>x[...,<span class="dv">1</span>], <span class="op">-</span>cycle, axis<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb8-96"><a href="#cb8-96"></a>        program.test_fft_4(queue, (N,), <span class="va">None</span>, cl.cltypes.<span class="bu">int</span>(cycle), x_g, y_g)</span>
<span id="cb8-97"><a href="#cb8-97"></a>        cl.enqueue_copy(queue, y, y_g)</span>
<span id="cb8-98"><a href="#cb8-98"></a>        y_Z <span class="op">=</span> np.roll(y[...,<span class="dv">0</span>]<span class="op">+</span>1j<span class="op">*</span>y[...,<span class="dv">1</span>], <span class="op">-</span>cycle, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-99"><a href="#cb8-99"></a></span>
<span id="cb8-100"><a href="#cb8-100"></a>        <span class="cf">assert</span> <span class="bu">abs</span>(y_Z <span class="op">-</span> y_ref).<span class="bu">max</span>() <span class="op">&lt;</span> <span class="fl">1e-4</span></span>
<span id="cb8-101"><a href="#cb8-101"></a></span>
<span id="cb8-102"><a href="#cb8-102"></a></span>
<span id="cb8-103"><a href="#cb8-103"></a><span class="kw">def</span> test_fft_1024(cl_context, program):</span>
<span id="cb8-104"><a href="#cb8-104"></a>    queue <span class="op">=</span> cl.CommandQueue(cl_context)</span>
<span id="cb8-105"><a href="#cb8-105"></a></span>
<span id="cb8-106"><a href="#cb8-106"></a>    x <span class="op">=</span> np.random.normal(size<span class="op">=</span>(<span class="dv">1024</span>, <span class="dv">2</span>)).astype(cl.cltypes.<span class="bu">float</span>)</span>
<span id="cb8-107"><a href="#cb8-107"></a>    y <span class="op">=</span> np.zeros_like(x)</span>
<span id="cb8-108"><a href="#cb8-108"></a>    x_g <span class="op">=</span> cl.Buffer(cl_context, mf.READ_ONLY <span class="op">|</span> mf.COPY_HOST_PTR, hostbuf<span class="op">=</span>x)</span>
<span id="cb8-109"><a href="#cb8-109"></a>    y_g <span class="op">=</span> cl.Buffer(cl_context, mf.WRITE_ONLY, x.nbytes)</span>
<span id="cb8-110"><a href="#cb8-110"></a>    program.fft_1024(queue, (<span class="dv">1</span>,), <span class="va">None</span>, x_g, y_g)</span>
<span id="cb8-111"><a href="#cb8-111"></a>    cl.enqueue_copy(queue, y, y_g)</span>
<span id="cb8-112"><a href="#cb8-112"></a></span>
<span id="cb8-113"><a href="#cb8-113"></a>    y_Z <span class="op">=</span> y[...,<span class="dv">0</span>]<span class="op">+</span>1j<span class="op">*</span>y[...,<span class="dv">1</span>]</span>
<span id="cb8-114"><a href="#cb8-114"></a>    y_ref <span class="op">=</span> np.fft.fft(x[...,<span class="dv">0</span>]<span class="op">+</span>1j<span class="op">*</span>x[...,<span class="dv">1</span>])</span>
<span id="cb8-115"><a href="#cb8-115"></a>    <span class="cf">assert</span> <span class="bu">abs</span>(y_Z <span class="op">-</span> y_ref).<span class="bu">max</span>() <span class="op">&lt;</span> <span class="fl">1e-3</span></span></code></pre></div>
</div>
</div>
<h1 id="fused-multiply-add-codelets">Fused-Multiply-Add codelets</h1>
<p>Rewriting FFT codelets to contain <strong>more</strong> floating-point operations, but increase the fraction of FP operations inside an FMA operation can increase the efficiency on some architectures.</p>
<h2 id="twiddle-factors">Twiddle factors</h2>
<p>Only half of the twiddle factors are used.</p>
<h2 id="radix-2">Radix 2</h2>
<p>A normal implementation of the radix-2 butterfly</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb9-1"><a href="#cb9-1"></a><span class="dt">void</span> radix2(<span class="dt">float2</span> e, <span class="dt">float2</span> o, <span class="dt">float2</span> w, <span class="dt">float2</span>* xa, <span class="dt">float2</span>* xb)</span>
<span id="cb9-2"><a href="#cb9-2"></a>{</span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="dt">float2</span> t = w * o;</span>
<span id="cb9-4"><a href="#cb9-4"></a>    *xa = e + t;</span>
<span id="cb9-5"><a href="#cb9-5"></a>    *xb = e - t;</span>
<span id="cb9-6"><a href="#cb9-6"></a>}</span></code></pre></div>
<p>This contains one complex multiplication and two complex additions, totaling four floating point multiplications and six additions.</p>
<div class="annotated-code">
<p><span><em>«fma-radix2»=</em></span></p>
<div class="sourceCode" id="fma-radix2"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="fma-radix2-1"><a href="#fma-radix2-1"></a><span class="dt">void</span> radix2_fma(<span class="dt">float2</span> e, <span class="dt">float2</span> o, <span class="dt">float2</span> w, <span class="dt">float2</span>* xa, <span class="dt">float2</span>* xb)</span>
<span id="fma-radix2-2"><a href="#fma-radix2-2"></a>{</span>
<span id="fma-radix2-3"><a href="#fma-radix2-3"></a>    <span class="dt">float2</span> a = (<span class="dt">float2</span>) (-w.y * o.y + e.x, w.y * o.x + e.y);</span>
<span id="fma-radix2-4"><a href="#fma-radix2-4"></a>    a += (<span class="dt">float2</span>) (w.x * o.x, w.x * o.y);</span>
<span id="fma-radix2-5"><a href="#fma-radix2-5"></a>    <span class="dt">float2</span> b = <span class="dv">2</span> * e - a;</span>
<span id="fma-radix2-6"><a href="#fma-radix2-6"></a></span>
<span id="fma-radix2-7"><a href="#fma-radix2-7"></a>    *xa = a;</span>
<span id="fma-radix2-8"><a href="#fma-radix2-8"></a>    *xb = b;</span>
<span id="fma-radix2-9"><a href="#fma-radix2-9"></a>}</span></code></pre></div>
</div>
<p>Now we have six multiplications and six additions, but they are completely contained in six FMA operations.</p>
<h2 id="higher-radix">Higher radix</h2>
<div class="fold-block">
<button class="btn btn-outline-primary btn-sm fold-toggle" type="button" data-toggle="collapse" data-target="#fftsynth-slash-opencl-slash-fma-codelets-dot-cl-container" aria-controls="fftsynth-slash-opencl-slash-fma-codelets-dot-cl-container">&lt;&lt;fftsynth/opencl/fma-codelets.cl&gt;&gt;=</button>
<div id="fftsynth-slash-opencl-slash-fma-codelets-dot-cl-container" class="collapse">
<div class="sourceCode" id="cb10" data-file="fftsynth/opencl/fma-codelets.cl" style="max-height: 50vh"><pre class="sourceCode opencl bootstrap-fold overflow-auto"><code class="sourceCode opencl"><span id="cb10-1"><a href="#cb10-1"></a>&lt;&lt;fma-radix2&gt;&gt;</span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="dt">void</span> radix3_fma(<span class="dt">float2</span> t0, <span class="dt">float2</span> t1, <span class="dt">float2</span> t2, <span class="dt">float2</span> w0, <span class="dt">float2</span> w1, <span class="dt">float2</span>* xa, <span class="dt">float2</span>* xb, <span class="dt">float2</span>* xc) {</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a>    <span class="dt">float2</span> z1, s1, s2, s3, s4, s5, s6;</span>
<span id="cb10-7"><a href="#cb10-7"></a>    <span class="dt">const</span> <span class="dt">float</span> c1 = <span class="fl">-0.5</span>;</span>
<span id="cb10-8"><a href="#cb10-8"></a>    <span class="dt">const</span> <span class="dt">float</span> c2 = <span class="fl">-0.8660254037844386</span>;</span>
<span id="cb10-9"><a href="#cb10-9"></a></span>
<span id="cb10-10"><a href="#cb10-10"></a>    <span class="co">//z1 = w0 * t1</span></span>
<span id="cb10-11"><a href="#cb10-11"></a>    z1 = (<span class="dt">float2</span>) (w0.x * t1.x - w0.y * t1.y,</span>
<span id="cb10-12"><a href="#cb10-12"></a>                   w0.x * t1.y + w0.y * t1.x);</span>
<span id="cb10-13"><a href="#cb10-13"></a></span>
<span id="cb10-14"><a href="#cb10-14"></a>    <span class="co">//s1 = z1 - w1 * t2</span></span>
<span id="cb10-15"><a href="#cb10-15"></a>    s1 = (<span class="dt">float2</span>) (z1.x - w1.x * t2.x + w1.y * t2.y,</span>
<span id="cb10-16"><a href="#cb10-16"></a>                   z1.y - w1.x * t2.y - w1.y * t2.x);</span>
<span id="cb10-17"><a href="#cb10-17"></a></span>
<span id="cb10-18"><a href="#cb10-18"></a>    <span class="co">//s2 = 2*z1 - s1</span></span>
<span id="cb10-19"><a href="#cb10-19"></a>    s2 = (<span class="dt">float2</span>) (<span class="dv">2</span>*z1.x - s1.x,</span>
<span id="cb10-20"><a href="#cb10-20"></a>                   <span class="dv">2</span>*z1.y - s1.y);</span>
<span id="cb10-21"><a href="#cb10-21"></a></span>
<span id="cb10-22"><a href="#cb10-22"></a>    <span class="co">//s3 = s2 + t0</span></span>
<span id="cb10-23"><a href="#cb10-23"></a>    s3 = (<span class="dt">float2</span>) (s2.x + t0.x,</span>
<span id="cb10-24"><a href="#cb10-24"></a>                   s2.y + t0.y);</span>
<span id="cb10-25"><a href="#cb10-25"></a></span>
<span id="cb10-26"><a href="#cb10-26"></a>    <span class="co">//s4 = t0 + c1*s2</span></span>
<span id="cb10-27"><a href="#cb10-27"></a>    s4 = (<span class="dt">float2</span>) (t0.x + c1*s2.x,</span>
<span id="cb10-28"><a href="#cb10-28"></a>                   t0.y + c1*s2.y);</span>
<span id="cb10-29"><a href="#cb10-29"></a></span>
<span id="cb10-30"><a href="#cb10-30"></a>    <span class="co">//s5 = s4-i*c2*s1</span></span>
<span id="cb10-31"><a href="#cb10-31"></a>    s5 = (<span class="dt">float2</span>) (s4.x - c2*s1.y,</span>
<span id="cb10-32"><a href="#cb10-32"></a>                   s4.y + c2*s1.x);</span>
<span id="cb10-33"><a href="#cb10-33"></a></span>
<span id="cb10-34"><a href="#cb10-34"></a>    <span class="co">//s6 = 2*s4-s5</span></span>
<span id="cb10-35"><a href="#cb10-35"></a>    s6 = (<span class="dt">float2</span>) (<span class="dv">2</span>*s4.x - s5.x,</span>
<span id="cb10-36"><a href="#cb10-36"></a>                   <span class="dv">2</span>*s4.y - s5.y);</span>
<span id="cb10-37"><a href="#cb10-37"></a></span>
<span id="cb10-38"><a href="#cb10-38"></a>    *xa = s3;</span>
<span id="cb10-39"><a href="#cb10-39"></a>    *xb = s5; <span class="co">//pseudo code in paper says s6</span></span>
<span id="cb10-40"><a href="#cb10-40"></a>    *xc = s6; <span class="co">//pseudo code in paper says s5</span></span>
<span id="cb10-41"><a href="#cb10-41"></a>}</span>
<span id="cb10-42"><a href="#cb10-42"></a></span>
<span id="cb10-43"><a href="#cb10-43"></a></span>
<span id="cb10-44"><a href="#cb10-44"></a><span class="dt">float</span> radix4_fma(<span class="dt">float2</span> t0, <span class="dt">float2</span> t1, <span class="dt">float2</span> t2, <span class="dt">float2</span> t3,</span>
<span id="cb10-45"><a href="#cb10-45"></a>                <span class="dt">float2</span> w0, <span class="dt">float2</span> w1,</span>
<span id="cb10-46"><a href="#cb10-46"></a>                <span class="dt">float2</span>* x0, <span class="dt">float2</span>* x1, <span class="dt">float2</span> *x2, <span class="dt">float2</span>* x3) {</span>
<span id="cb10-47"><a href="#cb10-47"></a></span>
<span id="cb10-48"><a href="#cb10-48"></a>    <span class="dt">float2</span> a, b, c, d;</span>
<span id="cb10-49"><a href="#cb10-49"></a></span>
<span id="cb10-50"><a href="#cb10-50"></a>    a = t0;     b = t2;     c = t1;     d = t3;</span>
<span id="cb10-51"><a href="#cb10-51"></a></span>
<span id="cb10-52"><a href="#cb10-52"></a>    b = (<span class="dt">float2</span>) (a.x - w1.x * b.x + w1.y * b.y,</span>
<span id="cb10-53"><a href="#cb10-53"></a>                  a.y - w1.x * b.y - w1.y * b.x);</span>
<span id="cb10-54"><a href="#cb10-54"></a>    a = (<span class="dt">float2</span>) (<span class="dv">2</span>*a.x - b.x,</span>
<span id="cb10-55"><a href="#cb10-55"></a>                  <span class="dv">2</span>*a.y - b.y);</span>
<span id="cb10-56"><a href="#cb10-56"></a>    d = (<span class="dt">float2</span>) (c.x - w1.x * d.x + w1.y * d.y,</span>
<span id="cb10-57"><a href="#cb10-57"></a>                  c.y - w1.x * d.y - w1.y * d.x);</span>
<span id="cb10-58"><a href="#cb10-58"></a>    c = (<span class="dt">float2</span>) (<span class="dv">2</span>*c.x - d.x,</span>
<span id="cb10-59"><a href="#cb10-59"></a>                  <span class="dv">2</span>*c.y - d.y);</span>
<span id="cb10-60"><a href="#cb10-60"></a></span>
<span id="cb10-61"><a href="#cb10-61"></a>    c = (<span class="dt">float2</span>) (a.x - w0.x * c.x + w0.y * c.y,</span>
<span id="cb10-62"><a href="#cb10-62"></a>                  a.y - w0.x * c.y - w0.y * c.x);</span>
<span id="cb10-63"><a href="#cb10-63"></a>    *x2 = c;</span>
<span id="cb10-64"><a href="#cb10-64"></a>    *x0 = (<span class="dt">float2</span>) (<span class="dv">2</span>*a.x - c.x,</span>
<span id="cb10-65"><a href="#cb10-65"></a>                    <span class="dv">2</span>*a.y - c.y);</span>
<span id="cb10-66"><a href="#cb10-66"></a></span>
<span id="cb10-67"><a href="#cb10-67"></a>    <span class="co">//d = b - i*w0*d</span></span>
<span id="cb10-68"><a href="#cb10-68"></a>    d = (<span class="dt">float2</span>) (b.x + w0.x * d.y + w0.y * d.x,</span>
<span id="cb10-69"><a href="#cb10-69"></a>                  b.y - w0.x * d.x + w0.y * d.y);</span>
<span id="cb10-70"><a href="#cb10-70"></a>    *x1 = d;</span>
<span id="cb10-71"><a href="#cb10-71"></a>    *x3 = (<span class="dt">float2</span>) (<span class="dv">2</span>*b.x - d.x,</span>
<span id="cb10-72"><a href="#cb10-72"></a>                    <span class="dv">2</span>*b.y - d.y);</span>
<span id="cb10-73"><a href="#cb10-73"></a></span>
<span id="cb10-74"><a href="#cb10-74"></a>    <span class="kw">return</span> <span class="fl">0.0</span>;</span>
<span id="cb10-75"><a href="#cb10-75"></a>}</span>
<span id="cb10-76"><a href="#cb10-76"></a></span>
<span id="cb10-77"><a href="#cb10-77"></a></span>
<span id="cb10-78"><a href="#cb10-78"></a></span>
<span id="cb10-79"><a href="#cb10-79"></a><span class="dt">float</span> radix5_fma(<span class="dt">float2</span> t0, <span class="dt">float2</span> t1, <span class="dt">float2</span> t2, <span class="dt">float2</span> t3, <span class="dt">float2</span> t4,</span>
<span id="cb10-80"><a href="#cb10-80"></a>                 <span class="dt">float2</span> w0, <span class="dt">float2</span> w1, <span class="dt">float2</span> w2, <span class="dt">float2</span> w3,</span>
<span id="cb10-81"><a href="#cb10-81"></a>                 <span class="dt">float2</span>* x0, <span class="dt">float2</span>* x1, <span class="dt">float2</span> *x2, <span class="dt">float2</span>* x3, <span class="dt">float2</span> *x4) {</span>
<span id="cb10-82"><a href="#cb10-82"></a></span>
<span id="cb10-83"><a href="#cb10-83"></a>    <span class="dt">const</span> <span class="dt">float</span> c1 = <span class="fl">0.25</span>;                  <span class="co">// 1/4</span></span>
<span id="cb10-84"><a href="#cb10-84"></a>    <span class="dt">const</span> <span class="dt">float</span> c2 = <span class="fl">0.5590169943749475</span>;      <span class="co">// sqrt(5)/4</span></span>
<span id="cb10-85"><a href="#cb10-85"></a>    <span class="dt">const</span> <span class="dt">float</span> c3 = <span class="fl">0.6180339887498949</span>;    <span class="co">// sqrt( (5-sqrt(5))/(5+sqrt(5)) )</span></span>
<span id="cb10-86"><a href="#cb10-86"></a>    <span class="dt">const</span> <span class="dt">float</span> c4 = <span class="fl">0.9510565162951535</span>;    <span class="co">// 1/2 * np.sqrt(5/2 + np.sqrt(5)/2)</span></span>
<span id="cb10-87"><a href="#cb10-87"></a></span>
<span id="cb10-88"><a href="#cb10-88"></a>    <span class="dt">float2</span> z0, z1, z2;</span>
<span id="cb10-89"><a href="#cb10-89"></a>    <span class="dt">float2</span> s1, s2, s3, s4, s5, s6, s7, s8, s9, s10, s11;</span>
<span id="cb10-90"><a href="#cb10-90"></a>    <span class="dt">float2</span> q1, q2;</span>
<span id="cb10-91"><a href="#cb10-91"></a></span>
<span id="cb10-92"><a href="#cb10-92"></a>    <span class="co">//z0 = t0</span></span>
<span id="cb10-93"><a href="#cb10-93"></a>    z0 = t0;</span>
<span id="cb10-94"><a href="#cb10-94"></a></span>
<span id="cb10-95"><a href="#cb10-95"></a>    <span class="co">//z1 = w0*t1</span></span>
<span id="cb10-96"><a href="#cb10-96"></a>    z1 = (<span class="dt">float2</span>) (w0.x * t1.x - w0.y * t1.y,</span>
<span id="cb10-97"><a href="#cb10-97"></a>                   w0.x * t1.y + w0.y * t1.x);</span>
<span id="cb10-98"><a href="#cb10-98"></a></span>
<span id="cb10-99"><a href="#cb10-99"></a>    <span class="co">//z2 = w1*t2</span></span>
<span id="cb10-100"><a href="#cb10-100"></a>    z2 = (<span class="dt">float2</span>) (w1.x * t2.x - w1.y * t2.y,</span>
<span id="cb10-101"><a href="#cb10-101"></a>                   w1.x * t2.y + w1.y * t2.x);</span>
<span id="cb10-102"><a href="#cb10-102"></a></span>
<span id="cb10-103"><a href="#cb10-103"></a>    <span class="co">//s1 = z1 - w3*t4</span></span>
<span id="cb10-104"><a href="#cb10-104"></a>    s1 = (<span class="dt">float2</span>) (z1.x - w3.x * t4.x + w3.y * t4.y,</span>
<span id="cb10-105"><a href="#cb10-105"></a>                   z1.y - w3.x * t4.y - w3.y * t4.x);</span>
<span id="cb10-106"><a href="#cb10-106"></a></span>
<span id="cb10-107"><a href="#cb10-107"></a>    <span class="co">//s2 = 2*z1-s1</span></span>
<span id="cb10-108"><a href="#cb10-108"></a>    s2 = (<span class="dt">float2</span>) (<span class="dv">2</span>*z1.x - s1.x,</span>
<span id="cb10-109"><a href="#cb10-109"></a>                   <span class="dv">2</span>*z1.y - s1.y);</span>
<span id="cb10-110"><a href="#cb10-110"></a></span>
<span id="cb10-111"><a href="#cb10-111"></a>    <span class="co">//s3 = z2 - w2*t3</span></span>
<span id="cb10-112"><a href="#cb10-112"></a>    s3 = (<span class="dt">float2</span>) (z2.x - w2.x * t3.x + w2.y * t3.y,</span>
<span id="cb10-113"><a href="#cb10-113"></a>                   z2.y - w2.x * t3.y - w2.y * t3.x);</span>
<span id="cb10-114"><a href="#cb10-114"></a></span>
<span id="cb10-115"><a href="#cb10-115"></a>    <span class="co">//s4 = 2*z2 - s3</span></span>
<span id="cb10-116"><a href="#cb10-116"></a>    s4 = (<span class="dt">float2</span>) (<span class="dv">2</span>*z2.x - s3.x,</span>
<span id="cb10-117"><a href="#cb10-117"></a>                   <span class="dv">2</span>*z2.y - s3.y);</span>
<span id="cb10-118"><a href="#cb10-118"></a></span>
<span id="cb10-119"><a href="#cb10-119"></a>    <span class="co">//s5 = s2+s4</span></span>
<span id="cb10-120"><a href="#cb10-120"></a>    s5 = (<span class="dt">float2</span>) (s2.x + s4.x,</span>
<span id="cb10-121"><a href="#cb10-121"></a>                   s2.y + s4.y);</span>
<span id="cb10-122"><a href="#cb10-122"></a></span>
<span id="cb10-123"><a href="#cb10-123"></a>    <span class="co">//s6 = s2-s4</span></span>
<span id="cb10-124"><a href="#cb10-124"></a>    s6 = (<span class="dt">float2</span>) (s2.x - s4.x,</span>
<span id="cb10-125"><a href="#cb10-125"></a>                   s2.y - s4.y);</span>
<span id="cb10-126"><a href="#cb10-126"></a></span>
<span id="cb10-127"><a href="#cb10-127"></a>    <span class="co">//s7 = z0 - c1*s5</span></span>
<span id="cb10-128"><a href="#cb10-128"></a>    s7 = (<span class="dt">float2</span>) (z0.x - c1*s5.x,</span>
<span id="cb10-129"><a href="#cb10-129"></a>                   z0.y - c1*s5.y);</span>
<span id="cb10-130"><a href="#cb10-130"></a></span>
<span id="cb10-131"><a href="#cb10-131"></a>    <span class="co">//s8 = s7 - c2*s6</span></span>
<span id="cb10-132"><a href="#cb10-132"></a>    s8 = (<span class="dt">float2</span>) (s7.x - c2*s6.x,</span>
<span id="cb10-133"><a href="#cb10-133"></a>                   s7.y - c2*s6.y);</span>
<span id="cb10-134"><a href="#cb10-134"></a></span>
<span id="cb10-135"><a href="#cb10-135"></a>    <span class="co">//s9 = 2*s7 - s8</span></span>
<span id="cb10-136"><a href="#cb10-136"></a>    s9 = (<span class="dt">float2</span>) (<span class="dv">2</span>*s7.x - s8.x,</span>
<span id="cb10-137"><a href="#cb10-137"></a>                   <span class="dv">2</span>*s7.y - s8.y);</span>
<span id="cb10-138"><a href="#cb10-138"></a></span>
<span id="cb10-139"><a href="#cb10-139"></a>    <span class="co">//s10 = s1 + c3*s3</span></span>
<span id="cb10-140"><a href="#cb10-140"></a>    s10 = (<span class="dt">float2</span>) (s1.x + c3*s3.x,</span>
<span id="cb10-141"><a href="#cb10-141"></a>                    s1.y + c3*s3.y);</span>
<span id="cb10-142"><a href="#cb10-142"></a></span>
<span id="cb10-143"><a href="#cb10-143"></a>    <span class="co">//s11 = c3*s1 - s3</span></span>
<span id="cb10-144"><a href="#cb10-144"></a>    s11 = (<span class="dt">float2</span>) (c3*s1.x - s3.x,</span>
<span id="cb10-145"><a href="#cb10-145"></a>                    c3*s1.y - s3.y);</span>
<span id="cb10-146"><a href="#cb10-146"></a></span>
<span id="cb10-147"><a href="#cb10-147"></a>    <span class="co">// *x0 = z0 + s5</span></span>
<span id="cb10-148"><a href="#cb10-148"></a>    *x0 = (<span class="dt">float2</span>) (z0.x + s5.x,</span>
<span id="cb10-149"><a href="#cb10-149"></a>                    z0.y + s5.y);</span>
<span id="cb10-150"><a href="#cb10-150"></a></span>
<span id="cb10-151"><a href="#cb10-151"></a>    <span class="co">//q1 = s9 - i*c4*s10</span></span>
<span id="cb10-152"><a href="#cb10-152"></a>    q1 = (<span class="dt">float2</span>) (s9.x - c4*s10.y,</span>
<span id="cb10-153"><a href="#cb10-153"></a>                   s9.y + c4*s10.x);</span>
<span id="cb10-154"><a href="#cb10-154"></a></span>
<span id="cb10-155"><a href="#cb10-155"></a>    <span class="co">// *x1 = 2*s9 - q1</span></span>
<span id="cb10-156"><a href="#cb10-156"></a>    *x1 = (<span class="dt">float2</span>) (<span class="dv">2</span>*s9.x - q1.x,</span>
<span id="cb10-157"><a href="#cb10-157"></a>                    <span class="dv">2</span>*s9.y - q1.y);</span>
<span id="cb10-158"><a href="#cb10-158"></a></span>
<span id="cb10-159"><a href="#cb10-159"></a>    <span class="co">//q2 = s8 - i*c4*s11</span></span>
<span id="cb10-160"><a href="#cb10-160"></a>    q2 = (<span class="dt">float2</span>) (s8.x - c4*s11.y,</span>
<span id="cb10-161"><a href="#cb10-161"></a>                   s8.y + c4*s11.x);</span>
<span id="cb10-162"><a href="#cb10-162"></a></span>
<span id="cb10-163"><a href="#cb10-163"></a>    <span class="co">// *x2 = 2*s8-q2</span></span>
<span id="cb10-164"><a href="#cb10-164"></a>    *x2 = (<span class="dt">float2</span>) (<span class="dv">2</span>*s8.x - q2.x,</span>
<span id="cb10-165"><a href="#cb10-165"></a>                    <span class="dv">2</span>*s8.y - q2.y);</span>
<span id="cb10-166"><a href="#cb10-166"></a></span>
<span id="cb10-167"><a href="#cb10-167"></a>    <span class="co">// *x3 = q2</span></span>
<span id="cb10-168"><a href="#cb10-168"></a>    *x3 = q2;</span>
<span id="cb10-169"><a href="#cb10-169"></a></span>
<span id="cb10-170"><a href="#cb10-170"></a>    <span class="co">// *x4 = q1 </span></span>
<span id="cb10-171"><a href="#cb10-171"></a>    *x4 = q1;</span>
<span id="cb10-172"><a href="#cb10-172"></a></span>
<span id="cb10-173"><a href="#cb10-173"></a></span>
<span id="cb10-174"><a href="#cb10-174"></a>}</span>
<span id="cb10-175"><a href="#cb10-175"></a></span>
<span id="cb10-176"><a href="#cb10-176"></a>&lt;&lt;fma-codelet-tests&gt;&gt;</span></code></pre></div>
</div>
</div>
<h2 id="testing-1">Testing</h2>
<div class="fold-block">
<button class="btn btn-outline-primary btn-sm fold-toggle" type="button" data-toggle="collapse" data-target="#fma-codelet-tests-container" aria-controls="fma-codelet-tests-container">&lt;&lt;fma-codelet-tests&gt;&gt;=</button>
<div id="fma-codelet-tests-container" class="collapse">
<div class="sourceCode" id="fma-codelet-tests" style="max-height: 50vh"><pre class="sourceCode opencl bootstrap-fold overflow-auto"><code class="sourceCode opencl"><span id="fma-codelet-tests-1"><a href="#fma-codelet-tests-1"></a><span class="kw">__kernel</span> <span class="dt">void</span> test_radix2(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</span>
<span id="fma-codelet-tests-2"><a href="#fma-codelet-tests-2"></a></span>
<span id="fma-codelet-tests-3"><a href="#fma-codelet-tests-3"></a>    <span class="dt">float2</span> w = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-4"><a href="#fma-codelet-tests-4"></a>    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>)*<span class="dv">2</span>;</span>
<span id="fma-codelet-tests-5"><a href="#fma-codelet-tests-5"></a></span>
<span id="fma-codelet-tests-6"><a href="#fma-codelet-tests-6"></a>    <span class="co">//n is the number of radix2 ffts to perform</span></span>
<span id="fma-codelet-tests-7"><a href="#fma-codelet-tests-7"></a>    <span class="kw">if</span> (i&lt;<span class="dv">2</span>*n) {</span>
<span id="fma-codelet-tests-8"><a href="#fma-codelet-tests-8"></a>        <span class="dt">float2</span> y0, y1;</span>
<span id="fma-codelet-tests-9"><a href="#fma-codelet-tests-9"></a>        radix2_fma(x[i], x[i+<span class="dv">1</span>], w, &amp;y0, &amp;y1);</span>
<span id="fma-codelet-tests-10"><a href="#fma-codelet-tests-10"></a></span>
<span id="fma-codelet-tests-11"><a href="#fma-codelet-tests-11"></a>        y[i] = y0; y[i+<span class="dv">1</span>] = y1;</span>
<span id="fma-codelet-tests-12"><a href="#fma-codelet-tests-12"></a>    }</span>
<span id="fma-codelet-tests-13"><a href="#fma-codelet-tests-13"></a>}</span>
<span id="fma-codelet-tests-14"><a href="#fma-codelet-tests-14"></a></span>
<span id="fma-codelet-tests-15"><a href="#fma-codelet-tests-15"></a></span>
<span id="fma-codelet-tests-16"><a href="#fma-codelet-tests-16"></a><span class="kw">__kernel</span> <span class="dt">void</span> test_radix3(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</span>
<span id="fma-codelet-tests-17"><a href="#fma-codelet-tests-17"></a></span>
<span id="fma-codelet-tests-18"><a href="#fma-codelet-tests-18"></a>    <span class="dt">float2</span> w0 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-19"><a href="#fma-codelet-tests-19"></a>    <span class="dt">float2</span> w1 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-20"><a href="#fma-codelet-tests-20"></a>    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>)*<span class="dv">3</span>;</span>
<span id="fma-codelet-tests-21"><a href="#fma-codelet-tests-21"></a></span>
<span id="fma-codelet-tests-22"><a href="#fma-codelet-tests-22"></a>    <span class="co">//n is the number of radix3 ffts to perform</span></span>
<span id="fma-codelet-tests-23"><a href="#fma-codelet-tests-23"></a>    <span class="kw">if</span> (i&lt;<span class="dv">3</span>*n) {</span>
<span id="fma-codelet-tests-24"><a href="#fma-codelet-tests-24"></a>        <span class="dt">float2</span> y0, y1, y2;</span>
<span id="fma-codelet-tests-25"><a href="#fma-codelet-tests-25"></a></span>
<span id="fma-codelet-tests-26"><a href="#fma-codelet-tests-26"></a>        radix3_fma(x[i], x[i+<span class="dv">1</span>], x[i+<span class="dv">2</span>], w0, w1, &amp;y0, &amp;y1, &amp;y2);</span>
<span id="fma-codelet-tests-27"><a href="#fma-codelet-tests-27"></a></span>
<span id="fma-codelet-tests-28"><a href="#fma-codelet-tests-28"></a>        y[i] = y0;    y[i+<span class="dv">1</span>] = y1;    y[i+<span class="dv">2</span>] = y2;</span>
<span id="fma-codelet-tests-29"><a href="#fma-codelet-tests-29"></a>    }</span>
<span id="fma-codelet-tests-30"><a href="#fma-codelet-tests-30"></a>}</span>
<span id="fma-codelet-tests-31"><a href="#fma-codelet-tests-31"></a></span>
<span id="fma-codelet-tests-32"><a href="#fma-codelet-tests-32"></a></span>
<span id="fma-codelet-tests-33"><a href="#fma-codelet-tests-33"></a><span class="kw">__kernel</span> <span class="dt">void</span> test_radix4(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</span>
<span id="fma-codelet-tests-34"><a href="#fma-codelet-tests-34"></a></span>
<span id="fma-codelet-tests-35"><a href="#fma-codelet-tests-35"></a>    <span class="dt">float2</span> w0 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-36"><a href="#fma-codelet-tests-36"></a>    <span class="dt">float2</span> w1 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-37"><a href="#fma-codelet-tests-37"></a>    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>)*<span class="dv">4</span>;</span>
<span id="fma-codelet-tests-38"><a href="#fma-codelet-tests-38"></a></span>
<span id="fma-codelet-tests-39"><a href="#fma-codelet-tests-39"></a>    <span class="co">//n is the number of radix4 ffts to perform</span></span>
<span id="fma-codelet-tests-40"><a href="#fma-codelet-tests-40"></a>    <span class="kw">if</span> (i&lt;<span class="dv">4</span>*n) {</span>
<span id="fma-codelet-tests-41"><a href="#fma-codelet-tests-41"></a>        <span class="dt">float2</span> y0, y1, y2, y3;</span>
<span id="fma-codelet-tests-42"><a href="#fma-codelet-tests-42"></a></span>
<span id="fma-codelet-tests-43"><a href="#fma-codelet-tests-43"></a>        radix4_fma(x[i], x[i+<span class="dv">1</span>], x[i+<span class="dv">2</span>], x[i+<span class="dv">3</span>], w0, w1, &amp;y0, &amp;y1, &amp;y2, &amp;y3);</span>
<span id="fma-codelet-tests-44"><a href="#fma-codelet-tests-44"></a></span>
<span id="fma-codelet-tests-45"><a href="#fma-codelet-tests-45"></a>        y[i] = y0;    y[i+<span class="dv">1</span>] = y1;    y[i+<span class="dv">2</span>] = y2;    y[i+<span class="dv">3</span>] = y3;</span>
<span id="fma-codelet-tests-46"><a href="#fma-codelet-tests-46"></a>    }</span>
<span id="fma-codelet-tests-47"><a href="#fma-codelet-tests-47"></a>}</span>
<span id="fma-codelet-tests-48"><a href="#fma-codelet-tests-48"></a></span>
<span id="fma-codelet-tests-49"><a href="#fma-codelet-tests-49"></a></span>
<span id="fma-codelet-tests-50"><a href="#fma-codelet-tests-50"></a><span class="kw">__kernel</span> <span class="dt">void</span> test_radix5(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</span>
<span id="fma-codelet-tests-51"><a href="#fma-codelet-tests-51"></a></span>
<span id="fma-codelet-tests-52"><a href="#fma-codelet-tests-52"></a>    <span class="dt">float2</span> w0 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-53"><a href="#fma-codelet-tests-53"></a>    <span class="dt">float2</span> w1 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-54"><a href="#fma-codelet-tests-54"></a>    <span class="dt">float2</span> w2 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-55"><a href="#fma-codelet-tests-55"></a>    <span class="dt">float2</span> w3 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-56"><a href="#fma-codelet-tests-56"></a>    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>)*<span class="dv">5</span>;</span>
<span id="fma-codelet-tests-57"><a href="#fma-codelet-tests-57"></a></span>
<span id="fma-codelet-tests-58"><a href="#fma-codelet-tests-58"></a>    <span class="co">//n is the number of radix5 ffts to perform</span></span>
<span id="fma-codelet-tests-59"><a href="#fma-codelet-tests-59"></a>    <span class="kw">if</span> (i&lt;<span class="dv">5</span>*n) {</span>
<span id="fma-codelet-tests-60"><a href="#fma-codelet-tests-60"></a>        <span class="dt">float2</span> y0, y1, y2, y3, y4;</span>
<span id="fma-codelet-tests-61"><a href="#fma-codelet-tests-61"></a></span>
<span id="fma-codelet-tests-62"><a href="#fma-codelet-tests-62"></a>        radix5_fma(x[i], x[i+<span class="dv">1</span>], x[i+<span class="dv">2</span>], x[i+<span class="dv">3</span>], x[i+<span class="dv">4</span>], w0, w1, w2, w3, &amp;y0, &amp;y1, &amp;y2, &amp;y3, &amp;y4);</span>
<span id="fma-codelet-tests-63"><a href="#fma-codelet-tests-63"></a></span>
<span id="fma-codelet-tests-64"><a href="#fma-codelet-tests-64"></a>        y[i] = y0;    y[i+<span class="dv">1</span>] = y1;    y[i+<span class="dv">2</span>] = y2;    y[i+<span class="dv">3</span>] = y3;    y[i+<span class="dv">4</span>] = y4;</span>
<span id="fma-codelet-tests-65"><a href="#fma-codelet-tests-65"></a>    }</span>
<span id="fma-codelet-tests-66"><a href="#fma-codelet-tests-66"></a>}</span></code></pre></div>
</div>
</div>
<div class="annotated-code">
<p><span><em>«test/test_fma_codelets.py»=</em></span></p>
<div class="sourceCode" id="cb11" data-file="test/test_fma_codelets.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="im">import</span> os</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-3"><a href="#cb11-3"></a></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="im">import</span> pytest</span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="im">from</span> kernel_tuner <span class="im">import</span> run_kernel</span>
<span id="cb11-6"><a href="#cb11-6"></a></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="im">from</span> pkg_resources <span class="im">import</span> resource_filename</span>
<span id="cb11-8"><a href="#cb11-8"></a></span>
<span id="cb11-9"><a href="#cb11-9"></a>filename <span class="op">=</span> resource_filename(<span class="st">&quot;fftsynth&quot;</span>, <span class="st">&quot;opencl/fma-codelets.cl&quot;</span>)</span>
<span id="cb11-10"><a href="#cb11-10"></a></span>
<span id="cb11-11"><a href="#cb11-11"></a></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="at">@pytest.mark.parametrize</span>(<span class="st">&#39;radix&#39;</span>, [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>])</span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="kw">def</span> test_radix(radix):</span>
<span id="cb11-14"><a href="#cb11-14"></a>    <span class="co">#this test runs 256 instances of the radix n function</span></span>
<span id="cb11-15"><a href="#cb11-15"></a>    <span class="co">#it does not use twiddle factors, so as a test</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>    <span class="co">#it&#39;s not to be relied upon fully</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>    n <span class="op">=</span> np.int32(<span class="dv">256</span>)</span>
<span id="cb11-18"><a href="#cb11-18"></a>    x <span class="op">=</span> np.random.normal(size<span class="op">=</span>(n, radix, <span class="dv">2</span>)).astype(np.float32)</span>
<span id="cb11-19"><a href="#cb11-19"></a>    y <span class="op">=</span> np.zeros_like(x)</span>
<span id="cb11-20"><a href="#cb11-20"></a></span>
<span id="cb11-21"><a href="#cb11-21"></a>    y_ref <span class="op">=</span> np.fft.fft(x[...,<span class="dv">0</span>]<span class="op">+</span>1j<span class="op">*</span>x[...,<span class="dv">1</span>])</span>
<span id="cb11-22"><a href="#cb11-22"></a></span>
<span id="cb11-23"><a href="#cb11-23"></a>    args <span class="op">=</span> [x, y, n]</span>
<span id="cb11-24"><a href="#cb11-24"></a>    answer <span class="op">=</span> run_kernel(<span class="st">&quot;test_radix&quot;</span> <span class="op">+</span> <span class="bu">str</span>(radix), filename, <span class="dv">1</span>, args, {})</span>
<span id="cb11-25"><a href="#cb11-25"></a></span>
<span id="cb11-26"><a href="#cb11-26"></a>    <span class="bu">print</span>(answer)</span>
<span id="cb11-27"><a href="#cb11-27"></a>    y <span class="op">=</span> answer[<span class="dv">1</span>]</span>
<span id="cb11-28"><a href="#cb11-28"></a>    y <span class="op">=</span> y[...,<span class="dv">0</span>]<span class="op">+</span>1j<span class="op">*</span>y[...,<span class="dv">1</span>]</span>
<span id="cb11-29"><a href="#cb11-29"></a>    <span class="bu">print</span>(y)</span>
<span id="cb11-30"><a href="#cb11-30"></a>    <span class="bu">print</span>(y_ref)</span>
<span id="cb11-31"><a href="#cb11-31"></a></span>
<span id="cb11-32"><a href="#cb11-32"></a>    <span class="cf">assert</span> <span class="bu">abs</span>(y <span class="op">-</span> y_ref).<span class="bu">max</span>() <span class="op">&lt;</span> <span class="fl">1e-4</span></span></code></pre></div>
</div>
<h1 id="code-generator">Code generator</h1>
<div class="annotated-code">
<p><span><em>«fftsynth/generator.py»=</em></span></p>
<div class="sourceCode" id="cb12" data-file="fftsynth/generator.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>twiddles<span class="op">&gt;&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>transpose<span class="op">&gt;&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4"></a></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>parity<span class="op">&gt;&gt;</span></span>
<span id="cb12-6"><a href="#cb12-6"></a></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>fft<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<h2 id="bit-math">Bit math</h2>
<p>The <code>transpose_{r}</code> function should reverse the digits in a base-n representation of the integer.</p>
<div class="annotated-code">
<p><span><em>«generate-transpose»=</em></span></p>
<div class="sourceCode" id="generate-transpose"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-transpose-1"><a href="#generate-transpose-1"></a><span class="kw">def</span> write_transpose_fn(ps):</span>
<span id="generate-transpose-2"><a href="#generate-transpose-2"></a>    <span class="bu">print</span>(<span class="ss">f&quot;&quot;&quot;</span></span>
<span id="generate-transpose-3"><a href="#generate-transpose-3"></a><span class="ss">inline int transpose_</span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">(int j) </span><span class="ch">{{</span></span>
<span id="generate-transpose-4"><a href="#generate-transpose-4"></a><span class="ss">    int x = 0;</span></span>
<span id="generate-transpose-5"><a href="#generate-transpose-5"></a><span class="ss">    for (int l = 0; l &lt; </span><span class="sc">{ps.</span>depth<span class="sc">}</span><span class="ss">; ++l) </span><span class="ch">{{</span></span>
<span id="generate-transpose-6"><a href="#generate-transpose-6"></a><span class="ss">        x *= </span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">;</span></span>
<span id="generate-transpose-7"><a href="#generate-transpose-7"></a><span class="ss">        x += j % </span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">;</span></span>
<span id="generate-transpose-8"><a href="#generate-transpose-8"></a><span class="ss">        j /= </span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">;</span></span>
<span id="generate-transpose-9"><a href="#generate-transpose-9"></a><span class="ss">    }}</span></span>
<span id="generate-transpose-10"><a href="#generate-transpose-10"></a><span class="ss">    return x;</span></span>
<span id="generate-transpose-11"><a href="#generate-transpose-11"></a><span class="ss">}}&quot;&quot;&quot;</span>)</span></code></pre></div>
</div>
<p>The <code>parity_{r}</code> function should compute the parity of the index.</p>
<div class="annotated-code">
<p><span><em>«generate-parity»=</em></span></p>
<div class="sourceCode" id="generate-parity"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-parity-1"><a href="#generate-parity-1"></a><span class="kw">def</span> write_parity_fn(ps):</span>
<span id="generate-parity-2"><a href="#generate-parity-2"></a>    <span class="bu">print</span>(<span class="ss">f&quot;&quot;&quot;</span></span>
<span id="generate-parity-3"><a href="#generate-parity-3"></a><span class="ss">inline int parity_</span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">(int i) </span><span class="ch">{{</span></span>
<span id="generate-parity-4"><a href="#generate-parity-4"></a><span class="ss">    int x = i % </span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">;</span></span>
<span id="generate-parity-5"><a href="#generate-parity-5"></a><span class="ss">    for (int a = 0; a &lt; </span><span class="sc">{ps.</span>depth<span class="sc">}</span><span class="ss">; ++a) </span><span class="ch">{{</span></span>
<span id="generate-parity-6"><a href="#generate-parity-6"></a><span class="ss">        i /= </span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">;</span></span>
<span id="generate-parity-7"><a href="#generate-parity-7"></a><span class="ss">        x += i % </span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">;</span></span>
<span id="generate-parity-8"><a href="#generate-parity-8"></a><span class="ss">    }}</span></span>
<span id="generate-parity-9"><a href="#generate-parity-9"></a><span class="ss">    return x % </span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">;</span></span>
<span id="generate-parity-10"><a href="#generate-parity-10"></a><span class="ss">}}</span></span></code></pre></div>
</div>
<h2 id="outer-loop">Outer loop</h2>
<div class="annotated-code">
<p><span><em>«generate-fft»=</em></span></p>
<div class="sourceCode" id="generate-fft"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-fft-1"><a href="#generate-fft-1"></a><span class="kw">def</span> write_outer_loop_fn(ps):</span>
<span id="generate-fft-2"><a href="#generate-fft-2"></a>    <span class="bu">print</span>(<span class="ss">f&quot;void fft_</span><span class="sc">{ps.N}</span><span class="ss">_mc(__restrict float2 *s0, __restrict float2 *s1, __restrict float2 *s2, __restrict float2 *s3)&quot;</span>)</span>
<span id="generate-fft-3"><a href="#generate-fft-3"></a>    <span class="bu">print</span>( <span class="st">&quot;{&quot;</span>)</span>
<span id="generate-fft-4"><a href="#generate-fft-4"></a>    <span class="bu">print</span>( <span class="st">&quot;    int wp = 0;&quot;</span>)</span>
<span id="generate-fft-5"><a href="#generate-fft-5"></a>    <span class="bu">print</span>(<span class="ss">f&quot;    for (int k = 0; k &lt; </span><span class="sc">{ps.</span>depth<span class="sc">}</span><span class="ss">; ++k) </span><span class="ch">{{</span><span class="ss">&quot;</span>)</span>
<span id="generate-fft-6"><a href="#generate-fft-6"></a>    <span class="cf">with</span> indent(<span class="st">&quot;         &quot;</span>):</span>
<span id="generate-fft-7"><a href="#generate-fft-7"></a>        <span class="op">&lt;&lt;</span>fft<span class="op">-</span>inner<span class="op">-</span>loop<span class="op">&gt;&gt;</span></span>
<span id="generate-fft-8"><a href="#generate-fft-8"></a>    <span class="bu">print</span>( <span class="st">&quot;    }&quot;</span>)</span>
<span id="generate-fft-9"><a href="#generate-fft-9"></a>    <span class="bu">print</span>( <span class="st">&quot;}&quot;</span>)</span></code></pre></div>
</div>
<h3 id="inner-loop">Inner loop</h3>
<p>Here we have <code>k</code> being the index of the outer loop. We now</p>
<div class="annotated-code">
<p><span><em>«fft-inner-loop»=</em></span></p>
<div class="sourceCode" id="fft-inner-loop"><pre class="sourceCode python"><code class="sourceCode python"><span id="fft-inner-loop-1"><a href="#fft-inner-loop-1"></a><span class="bu">print</span>(<span class="ss">f&quot;int j = (k == 0 ? 0 : ipow(</span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">, k - 1));&quot;</span>)</span>
<span id="fft-inner-loop-2"><a href="#fft-inner-loop-2"></a><span class="bu">print</span>(<span class="ss">f&quot;for (int i = 0; i &lt; </span><span class="sc">{ps.L}</span><span class="ss">; ++i) </span><span class="ch">{{</span><span class="ss">&quot;</span>)</span></code></pre></div>
</div>
<p>The next bit is only still implemented for radix-4.</p>
<div class="annotated-code">
<p><span><em>«fft-inner-loop»+</em></span></p>
<div class="sourceCode" id="fft-inner-loop"><pre class="sourceCode python"><code class="sourceCode python"><span id="fft-inner-loop-1"><a href="#fft-inner-loop-1"></a><span class="bu">print</span>( <span class="st">&quot;if (k != 0) {&quot;</span>)</span>
<span id="fft-inner-loop-2"><a href="#fft-inner-loop-2"></a><span class="bu">print</span>( <span class="st">&quot;    a = comp_idx_4(i &gt;&gt; 2, k-1);&quot;</span>)</span>
<span id="fft-inner-loop-3"><a href="#fft-inner-loop-3"></a><span class="bu">print</span>( <span class="st">&quot;} else {&quot;</span>)</span>
<span id="fft-inner-loop-4"><a href="#fft-inner-loop-4"></a><span class="bu">print</span>( <span class="st">&quot;    a = comp_perm_4(i &gt;&gt; 2, i&amp;3);&quot;</span>)</span>
<span id="fft-inner-loop-5"><a href="#fft-inner-loop-5"></a><span class="bu">print</span>( <span class="st">&quot;}&quot;</span>)</span>
<span id="fft-inner-loop-6"><a href="#fft-inner-loop-6"></a><span class="bu">print</span>( <span class="st">&quot;fft_4(s0, s1, s2, s3, i&amp;3, a, a+j, a+2*j, a+3*j, wp);&quot;</span>)</span>
<span id="fft-inner-loop-7"><a href="#fft-inner-loop-7"></a><span class="bu">print</span>( <span class="st">&quot;if (k != 0) ++wp;&quot;</span>)</span></code></pre></div>
</div>
<h3 id="outer-kernel">Outer kernel</h3>
<p>The outer kernel reads the data, puts it in the correct parity-channel and then calls the respective <code>fft_{n}_mc</code> kernel.</p>
<div class="annotated-code">
<p><span><em>«generate-outer-fft»=</em></span></p>
<div class="sourceCode" id="generate-outer-fft"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-outer-fft-1"><a href="#generate-outer-fft-1"></a>declare_arrays <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(</span>
<span id="generate-outer-fft-2"><a href="#generate-outer-fft-2"></a>    <span class="ss">f&quot;float2 s</span><span class="sc">{i}</span><span class="ss">[</span><span class="sc">{ps.L}</span><span class="ss">];&quot;</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(ps.radix))</span>
<span id="generate-outer-fft-3"><a href="#generate-outer-fft-3"></a>mc_args <span class="op">=</span> <span class="st">&quot;, &quot;</span>.join(</span>
<span id="generate-outer-fft-4"><a href="#generate-outer-fft-4"></a>    <span class="ss">f&quot;s</span><span class="sc">{i}</span><span class="ss">&quot;</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(ps.radix))</span>
<span id="generate-outer-fft-5"><a href="#generate-outer-fft-5"></a>read_cases <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(</span>
<span id="generate-outer-fft-6"><a href="#generate-outer-fft-6"></a>    <span class="ss">f&quot;case </span><span class="sc">{p}</span><span class="ss">: s</span><span class="sc">{p}</span><span class="ss">[i/</span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">] = x[j]; break;&quot;</span> <span class="cf">for</span> p <span class="kw">in</span> <span class="bu">range</span>(ps.radix))</span>
<span id="generate-outer-fft-7"><a href="#generate-outer-fft-7"></a>write_cases <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(</span>
<span id="generate-outer-fft-8"><a href="#generate-outer-fft-8"></a>    <span class="ss">f&quot;case </span><span class="sc">{p}</span><span class="ss">: y[i] = s</span><span class="sc">{p}</span><span class="ss">[i/</span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">]; break;&quot;</span> <span class="cf">for</span> p <span class="kw">in</span> <span class="bu">range</span>(ps.radix))</span>
<span id="generate-outer-fft-9"><a href="#generate-outer-fft-9"></a><span class="bu">print</span>(<span class="ss">f&quot;&quot;&quot;</span></span>
<span id="generate-outer-fft-10"><a href="#generate-outer-fft-10"></a><span class="ss">__kernel void fft_</span><span class="sc">{ps.N}</span><span class="ss">(__global const float2 * restrict x, __global float2 * restrict y)</span></span>
<span id="generate-outer-fft-11"><a href="#generate-outer-fft-11"></a><span class="ch">{{</span></span>
<span id="generate-outer-fft-12"><a href="#generate-outer-fft-12"></a><span class="ss">    </span><span class="sc">{</span>declare_arrays<span class="sc">}</span></span>
<span id="generate-outer-fft-13"><a href="#generate-outer-fft-13"></a><span class="ss">    float2 s</span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">[</span><span class="sc">{ps.L}</span><span class="ss">];</span></span>
<span id="generate-outer-fft-14"><a href="#generate-outer-fft-14"></a></span>
<span id="generate-outer-fft-15"><a href="#generate-outer-fft-15"></a><span class="ss">    for (int j = 0; j &lt; </span><span class="sc">{ps.N}</span><span class="ss">; ++j) </span><span class="ch">{{</span></span>
<span id="generate-outer-fft-16"><a href="#generate-outer-fft-16"></a><span class="ss">        int i = transpose_</span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">(j);</span></span>
<span id="generate-outer-fft-17"><a href="#generate-outer-fft-17"></a><span class="ss">        int p = parity_</span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">(i);</span></span>
<span id="generate-outer-fft-18"><a href="#generate-outer-fft-18"></a><span class="ss">        switch (p) </span><span class="ch">{{</span></span>
<span id="generate-outer-fft-19"><a href="#generate-outer-fft-19"></a><span class="ss">            </span><span class="sc">{</span>read_cases<span class="sc">}</span></span>
<span id="generate-outer-fft-20"><a href="#generate-outer-fft-20"></a><span class="ss">        }}</span></span>
<span id="generate-outer-fft-21"><a href="#generate-outer-fft-21"></a><span class="ss">    }}</span></span>
<span id="generate-outer-fft-22"><a href="#generate-outer-fft-22"></a></span>
<span id="generate-outer-fft-23"><a href="#generate-outer-fft-23"></a><span class="ss">    fft_1024_mc(</span><span class="sc">{</span>mc_args<span class="sc">}</span><span class="ss">);</span></span>
<span id="generate-outer-fft-24"><a href="#generate-outer-fft-24"></a></span>
<span id="generate-outer-fft-25"><a href="#generate-outer-fft-25"></a><span class="ss">    for (int i = 0; i &lt; </span><span class="sc">{ps.N}</span><span class="ss">; ++i) </span><span class="ch">{{</span></span>
<span id="generate-outer-fft-26"><a href="#generate-outer-fft-26"></a><span class="ss">        int p = parity_</span><span class="sc">{ps.</span>radix<span class="sc">}</span><span class="ss">(i);</span></span>
<span id="generate-outer-fft-27"><a href="#generate-outer-fft-27"></a><span class="ss">        switch (p) </span><span class="ch">{{</span></span>
<span id="generate-outer-fft-28"><a href="#generate-outer-fft-28"></a><span class="ss">            </span><span class="sc">{</span>write_cases<span class="sc">}</span></span>
<span id="generate-outer-fft-29"><a href="#generate-outer-fft-29"></a><span class="ss">        }}</span></span>
<span id="generate-outer-fft-30"><a href="#generate-outer-fft-30"></a><span class="ss">    }}</span></span>
<span id="generate-outer-fft-31"><a href="#generate-outer-fft-31"></a><span class="ss">}}&quot;&quot;&quot;</span>)</span></code></pre></div>
</div>
<h2 id="twiddles-1">Twiddles</h2>
<div class="annotated-code">
<p><span><em>«generate-twiddles»=</em></span></p>
<div class="sourceCode" id="generate-twiddles"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-twiddles-1"><a href="#generate-twiddles-1"></a><span class="kw">def</span> write_twiddles(ps, W):</span>
<span id="generate-twiddles-2"><a href="#generate-twiddles-2"></a>    <span class="bu">print</span>(<span class="ss">f&quot;__constant float2 W[</span><span class="sc">{W.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">][</span><span class="sc">{ps.</span>radix<span class="dv">-1</span><span class="sc">}</span><span class="ss">] </span><span class="ch">{{</span><span class="ss">&quot;</span>)</span>
<span id="generate-twiddles-3"><a href="#generate-twiddles-3"></a>    <span class="bu">print</span>( <span class="st">&quot;    {&quot;</span> <span class="op">+</span> <span class="st">&quot;},</span><span class="ch">\n</span><span class="st">    {&quot;</span>.join(<span class="st">&quot;, &quot;</span>.join(</span>
<span id="generate-twiddles-4"><a href="#generate-twiddles-4"></a>                <span class="ss">f&quot;(float2) (</span><span class="sc">{w.</span>real<span class="sc">: f}</span><span class="ss">f, </span><span class="sc">{w.</span>imag<span class="sc">: f}</span><span class="ss">f)&quot;</span></span>
<span id="generate-twiddles-5"><a href="#generate-twiddles-5"></a>                <span class="cf">for</span> w <span class="kw">in</span> ws[<span class="dv">1</span>:])</span>
<span id="generate-twiddles-6"><a href="#generate-twiddles-6"></a>            <span class="cf">for</span> ws <span class="kw">in</span> W) <span class="op">+</span> <span class="st">&quot;</span><span class="sc">}}</span><span class="st">;&quot;</span>)</span></code></pre></div>
</div>
<h2 id="utility">Utility</h2>
<div class="annotated-code">
<p><span><em>«fftsynth/indent.py»=</em></span></p>
<div class="sourceCode" id="cb13" data-file="fftsynth/indent.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="im">from</span> contextlib <span class="im">import</span> (contextmanager, redirect_stdout)</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="im">import</span> io</span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="im">import</span> textwrap</span>
<span id="cb13-4"><a href="#cb13-4"></a></span>
<span id="cb13-5"><a href="#cb13-5"></a></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="at">@contextmanager</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="kw">def</span> indent(prefix: <span class="bu">str</span>):</span>
<span id="cb13-8"><a href="#cb13-8"></a>    f <span class="op">=</span> io.StringIO()</span>
<span id="cb13-9"><a href="#cb13-9"></a>    <span class="cf">with</span> redirect_stdout(f):</span>
<span id="cb13-10"><a href="#cb13-10"></a>        <span class="cf">yield</span></span>
<span id="cb13-11"><a href="#cb13-11"></a>    output <span class="op">=</span> f.getvalue()</span>
<span id="cb13-12"><a href="#cb13-12"></a>    <span class="bu">print</span>(textwrap.indent(output, prefix), end<span class="op">=</span><span class="st">&quot;&quot;</span>)</span></code></pre></div>
</div>
</div></main>

<footer class="py-4 bg-dark text-white-50 footer"><div class="container">
Generated from the Entangled Bootstrap template.<br />
2020-08-18 — version: 0.1.0
</div></footer>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script type="text/javascript" src="js/bootstrap.js"></script>
</body>
</html>
