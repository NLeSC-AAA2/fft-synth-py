<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Johan Hidding, Ben van Werkhoven, Netherlands eScience Center" />
  <title>FFT Synthesis for OpenCL on FPGA</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="css/bootstrap.css" />
  <link rel="stylesheet" href="css/mods.css" />
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  
  <!-- pandoc-eqnos: equation style -->
  <style>
    .eqnos { display: inline-block; position: relative; width: 100%; }
    .eqnos br { display: none; }
    .eqnos-number { position: absolute; right: 0em; top: 50%; line-height: 0; }
  </style>
<!-- <script data-main="scripts/main" src="js/require.js"></script> -->
  <!-- Load React. -->
  <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
<!--  <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script> -->


</head>
<body class="d-flex flex-column">

<nav id="TOC" class="navbar navbar-dark bg-dark">
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a href="#" class="ml-5 mr-auto navbar-brand">FFT Synthesis for OpenCL on FPGA<br><span style="font-size: smaller"> by <i>Johan Hidding, Ben van Werkhoven, Netherlands eScience Center</i></span></a>
<div class="collapse navbar-collapse" id="navbarSupportedContent">
<ul>
<li><a href="#about">About</a></li>
<li><a href="#cooley-tukey-algorithm">Cooley-Tukey algorithm</a></li>
<li><a href="#parity-splitting">Parity splitting</a></li>
<li><a href="#fused-multiply-add-codelets">Fused-Multiply-Add codelets</a></li>
<li><a href="#code-generator">Code generator</a></li>
</ul>
</div>
</nav>

<!-- <nav class="navbar navbar-dark navbar-expand-md bg-dark mb-4">
<p class="author">Johan Hidding, Ben van Werkhoven, Netherlands eScience Center</p>
</nav>
 -->

<main role="main" class="flex-fill"><div class="container my-5">
<h1 id="about">About</h1>
<h2 id="license">License</h2>
<p>Copyright 2020 Johan Hidding, Ben van Werkhoven, Netherlands eScience Center</p>
<blockquote>
<p>This template is licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>; you may not use this file except in compliance with the License. You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0</code></pre>
<p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an “AS IS” BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</p>
</blockquote>
<h2 id="version">Version</h2>
<div class="annotated-code">
<p><span><em>«fftsynth/__init__.py»=</em></span></p>
<div class="sourceCode" id="cb2" data-file="fftsynth/__init__.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>__version__ <span class="op">=</span> <span class="st">&quot;0.1.0&quot;</span></span></code></pre></div>
</div>
<h1 id="cooley-tukey-algorithm">Cooley-Tukey algorithm</h1>
<p>(sampled from Frigo 1999. I changed array indices to <span class="math inline">\(k, l, m\)</span>, <span class="math inline">\(n\)</span> denoting the length of the array.)</p>
<p>The (forward) discrete Fourier transform of <span class="math inline">\(X\)</span> is the array <span class="math inline">\(Y\)</span> given by</p>
<p><span id="eq:dft" class="eqnos"><span class="math display">\[Y[l] = \sum_{k=0}^{n-1} X[k] w_n^{-kl},\]</span><span class="eqnos-number">(1)</span></span> </p>
<p>where</p>
<p><span id="eq:wn" class="eqnos"><span class="math display">\[w_n = \exp\left(\frac{2\pi i}{n}\right).\]</span><span class="eqnos-number">(2)</span></span> </p>
<p>So <span class="math inline">\(w_n^{-kl}\)</span> denotes <span class="math inline">\(w_n\)</span> <em>to the power of</em> <span class="math inline">\(-kl\)</span>.</p>
<p>In the case that <span class="math inline">\(X\)</span> is real valued, <span class="math inline">\(Y\)</span> will have <em>hermitian symmetry</em></p>
<p><span id="eq:hermitian-symmetry" class="eqnos"><span class="math display">\[Y[n - k] = Y^*[k].\]</span><span class="eqnos-number">(3)</span></span> </p>
<p>The backward DFT flips the sign at the exponent of <span class="math inline">\(w_n\)</span>, giving</p>
<p><span id="eq:idft" class="eqnos"><span class="math display">\[Y[l] = \sum_{k=0}^{n-1} X[k] w_n^{kl}.\]</span><span class="eqnos-number">(4)</span></span> </p>
<p>Now suppose that <span class="math inline">\(n\)</span> can be factored into <span class="math inline">\(n = n_1 n_2\)</span>. We may now view the arrays <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> in a rectangular shape, where</p>
<p><span class="math display">\[X[k] = X[k_1 n_2 + k_2] = X[k_1, k_2].\]</span></p>
<p>Also, let <span class="math inline">\(Y\)</span> take the transposed shape of <span class="math inline">\(X\)</span>,</p>
<p><span class="math display">\[Y[l] = Y[l_1 + l_2 n_1] = Y[l_1, l_2].\]</span></p>
<p>Then eq. <a href="#eq:dft">1</a> can be written as</p>
<!-- $$Y[l_1, l_2] = \sum_{k_2 = 0}^{n_2 - 1} \left[\left(\sum_{k_1 = 0}^{n_1-1} X[k_1, k_2] w_{n_1}^{-k_1 l_1}\right) w_n^{l_1 k_2}\right] w_{n_2}^{-l_2 k_2}.$$ -->
<p><span class="math display">\[Y[l_2, l_1] = \sum_{k_2 = 0}^{n_2 - 1} \left[\underbrace{\left(\sum_{k_1 = 0}^{n_1-1} X[k_1, k_2] w_{n_1}^{-k_1 l_1}\right)}_{n_1\text{-point DFT}} \overbrace{\ w_n^{l_1 k_2}\ }^\text{twiddles}\right] w_{n_2}^{-l_2 k_2}.\]</span></p>
<p>Also known as the <strong>Cooley-Tukey fast Fourier transform</strong>.</p>
<p>This separates the DFT in an inner and outer transform, of sizes <span class="math inline">\(n_1\)</span> and <span class="math inline">\(n_2\)</span>. The output of the inner transform is multiplied by <strong>twiddle factors</strong> <span class="math inline">\(w_n^{-l_1 k_2}\)</span>, before the outer transform is done.</p>
<p>We approach the FFT algorithm by casting the array to an multi-dimensional array, where each dimension represents one step in the FFT.</p>
<div id="fig:cooley-tukey" class="fignos">
<figure>
<img src="img/cooley-tukey-20.svg" alt="" /><figcaption><span>Figure 1:</span> A <span class="math inline">\(N=20\)</span> Fourier transform is broken up into an <span class="math inline">\(5 \times 2 \times 2\)</span> fast Fourier transform.</figcaption>
</figure>
</div>
<p>Another way to illustrate the FFT algorithm is by visualising the data flow.</p>
<div id="fig:fft-dataflow" class="fignos">
<figure>
<img src="img/dataflow.svg" alt="" /><figcaption><span>Figure 2:</span> Data flow in a radix-2 FFT</figcaption>
</figure>
</div>
<p>We will refer to the smallest Fourier transform inside an FFT as a <strong>butterfly</strong> operation. In the case of a radix-2 FFT, as illustrated in Figure <a href="#fig:fft-dataflow">2</a>, this is the operation of performing a 2-FT on any two elements within the array, commonly including the multiplication with a twiddle factor.</p>
<h1 id="parity-splitting">Parity splitting</h1>
<h2 id="radix-n-data-streamlining">Radix-n data streamlining</h2>
<p>For a radix-2 FFT, it is possible to divide input data in such a way that every butterfly operation reads and writes to two different arrays in memory. This could be advantageous for an implementation on the FPGA. The trick is to separate data locations based on the parity of their index.</p>
<h3 id="parity">Parity</h3>
<p>The index of each element in the array can be written in binary. In the case of a radix-2 FFT, we can see the array being reshaped in a <span class="math inline">\([2, 2, 2, \dots]\)</span> shape. Every stage of the <span class="math inline">\(n=2^k\)</span> sized radix-2 FFT is being performed in a different dimension of the <span class="math inline">\(k\)</span>-dimensional reshaped array. The indexing in this multi-dimensional array is the same as the binary notation for the linear index. That means that each time the 2-FFT is performed, the multi-index of the elements involved will differ by one bit in the linear index. Separating the array based on the parity of the index will guarantee that each 2-FFT operation reads and writes one (complex) number from each set. The parity is the sum of all the individual bits, modulo 2.</p>
<p><span class="math display">\[P_2(i) = \left(\sum_k b_k\right) \mod 2,\quad {\rm where}\, i := \sum_k b_k 2^k\]</span></p>
<p>We can extend this concept to the radix-4 FFT, on 4 data channels.</p>
<h3 id="parity-1">4-parity</h3>
<p>In the radix-4 FFT we can view the array as being reshaped to a <span class="math inline">\([4, 4, 4, \dots]\)</span> shape. The multi-index into this array is equivalent to the quarternary number notation of the linear index. Similar to the radix-2 parity, we can define the radix-4 parity as the sum of each quarternary digit in the index, modulo 4.</p>
<p><span class="math display">\[P_4(i) = \left(\sum_k q_k\right) \mod 4,\quad {\rm where}\, i := \sum_k q_k 4^k\]</span></p>
<p>This would ensure that each 4-FFT reads its data from the 4 different input channels. We define the <code>parity</code> function to work with any radix:</p>
<div class="annotated-code">
<p><span><em>«fftsynth/parity.py»=</em></span></p>
<div class="sourceCode" id="cb3" data-file="fftsynth/parity.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="im">from</span> numba <span class="im">import</span> jit, vectorize</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="im">import</span> numpy <span class="im">as</span> np                  <span class="co"># type: ignore</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a><span class="im">import</span> math</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a><span class="im">from</span> itertools <span class="im">import</span> groupby</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a><span class="im">from</span> typing <span class="im">import</span> List, Iterator, Sequence, Generator, Tuple</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a><span class="at">@jit</span>(nopython<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a><span class="kw">def</span> digits(n: <span class="bu">int</span>, i: <span class="bu">int</span>) <span class="op">-&gt;</span> Generator[<span class="bu">int</span>, <span class="va">None</span>, <span class="va">None</span>]:</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Generates the n-numbered digits of i, in reverse order.&quot;&quot;&quot;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a>        <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a>            <span class="cf">return</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a>            i, q <span class="op">=</span> <span class="bu">divmod</span>(i, n)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a>            <span class="cf">yield</span> q</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a><span class="at">@vectorize</span>(nopython<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a><span class="kw">def</span> parity(n: <span class="bu">int</span>, i: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Computes the n-parity of a number i.&quot;&quot;&quot;</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a>    x <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true"></a>    <span class="cf">for</span> j <span class="kw">in</span> digits(n, i):</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true"></a>        x <span class="op">+=</span> j</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true"></a>    <span class="cf">return</span> x <span class="op">%</span> n</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true"></a><span class="op">&lt;&lt;</span>parity<span class="op">-</span>channels<span class="op">&gt;&gt;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true"></a><span class="op">&lt;&lt;</span>parity<span class="op">-</span>index<span class="op">-</span>functions<span class="op">&gt;&gt;</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true"></a><span class="op">&lt;&lt;</span>parity<span class="op">-</span>splitting<span class="op">-</span>interface<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<p>Using the parity function we can determine which index belongs to which channel</p>
<div class="annotated-code">
<p><span><em>«parity-channels»=</em></span></p>
<div class="sourceCode" id="parity-channels"><pre class="sourceCode python"><code class="sourceCode python"><span id="parity-channels-1"><a href="#parity-channels-1" aria-hidden="true"></a><span class="kw">def</span> channels(N: <span class="bu">int</span>, radix: <span class="bu">int</span>) <span class="op">-&gt;</span> Iterator[Tuple[<span class="bu">int</span>, Iterator[<span class="bu">int</span>]]]:</span>
<span id="parity-channels-2"><a href="#parity-channels-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Given a 1-d contiguous array of size N, and a FFT of given radix,</span></span>
<span id="parity-channels-3"><a href="#parity-channels-3" aria-hidden="true"></a><span class="co">    this returns a map of iterators of the different memory channels.&quot;&quot;&quot;</span></span>
<span id="parity-channels-4"><a href="#parity-channels-4" aria-hidden="true"></a>    parity_r <span class="op">=</span> partial(parity, radix)</span>
<span id="parity-channels-5"><a href="#parity-channels-5" aria-hidden="true"></a>    <span class="cf">return</span> groupby(<span class="bu">sorted</span>(<span class="bu">range</span>(N), key<span class="op">=</span>parity_r), parity_r)</span></code></pre></div>
</div>
<p>For instance, for radix-2, size 16, this creates the following channels</p>
<div class="annotated-code">
<p><span><em>«parity»=</em></span></p>
<div class="doctest" data-status="SUCCESS">
<div class="doctestInput">
<div class="sourceCode" id="parity"><pre class="sourceCode python eval"><code class="sourceCode python"><span id="parity-1"><a href="#parity-1" aria-hidden="true"></a><span class="im">from</span> fftsynth.parity <span class="im">import</span> channels</span>
<span id="parity-2"><a href="#parity-2" aria-hidden="true"></a></span>
<span id="parity-3"><a href="#parity-3" aria-hidden="true"></a><span class="cf">for</span> (g, i) <span class="kw">in</span> channels(<span class="dv">16</span>, <span class="dv">2</span>):</span>
<span id="parity-4"><a href="#parity-4" aria-hidden="true"></a>    <span class="bu">print</span>(g, <span class="bu">list</span>(i))</span></code></pre></div>
</div>
<div class="doctestResult">
<div class="sourceCode" id="cb4"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>0 [0, 3, 5, 6, 9, 10, 12, 15]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>1 [1, 2, 4, 7, 8, 11, 13, 14]</span></code></pre></div>
</div>
</div>
</div>
<p>and for a radix-4, size 64 fft, this creates the following channels</p>
<div class="annotated-code">
<p><span><em>«parity»+</em></span></p>
<div class="doctest" data-status="SUCCESS">
<div class="doctestInput">
<div class="sourceCode" id="parity"><pre class="sourceCode python eval"><code class="sourceCode python"><span id="parity-1"><a href="#parity-1" aria-hidden="true"></a><span class="cf">for</span> (g, i) <span class="kw">in</span> channels(<span class="dv">64</span>, <span class="dv">4</span>):</span>
<span id="parity-2"><a href="#parity-2" aria-hidden="true"></a>    <span class="bu">print</span>(g, <span class="bu">list</span>(i))</span></code></pre></div>
</div>
<div class="doctestResult">
<div class="sourceCode" id="cb5"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>0 [0, 7, 10, 13, 19, 22, 25, 28, 34, 37, 40, 47, 49, 52, 59, 62]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>1 [1, 4, 11, 14, 16, 23, 26, 29, 35, 38, 41, 44, 50, 53, 56, 63]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>2 [2, 5, 8, 15, 17, 20, 27, 30, 32, 39, 42, 45, 51, 54, 57, 60]</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>3 [3, 6, 9, 12, 18, 21, 24, 31, 33, 36, 43, 46, 48, 55, 58, 61]</span></code></pre></div>
</div>
</div>
</div>
<h2 id="twiddles">Twiddles</h2>
<div class="annotated-code">
<p><span><em>«fftsynth/twiddle.py»=</em></span></p>
<div class="sourceCode" id="cb6" data-file="fftsynth/twiddle.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="op">&lt;&lt;</span>make<span class="op">-</span>twiddle<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«make-twiddle»=</em></span></p>
<div class="sourceCode" id="make-twiddle"><pre class="sourceCode python"><code class="sourceCode python"><span id="make-twiddle-1"><a href="#make-twiddle-1" aria-hidden="true"></a><span class="kw">def</span> make_twiddle(n1, n2):</span>
<span id="make-twiddle-2"><a href="#make-twiddle-2" aria-hidden="true"></a>    <span class="kw">def</span> w(k, n):</span>
<span id="make-twiddle-3"><a href="#make-twiddle-3" aria-hidden="true"></a>        <span class="cf">return</span> np.exp(<span class="ot">2j</span> <span class="op">*</span> np.pi <span class="op">*</span> k <span class="op">/</span> n)</span>
<span id="make-twiddle-4"><a href="#make-twiddle-4" aria-hidden="true"></a></span>
<span id="make-twiddle-5"><a href="#make-twiddle-5" aria-hidden="true"></a>    I1 <span class="op">=</span> np.arange(n1)</span>
<span id="make-twiddle-6"><a href="#make-twiddle-6" aria-hidden="true"></a>    I2 <span class="op">=</span> np.arange(n2)</span>
<span id="make-twiddle-7"><a href="#make-twiddle-7" aria-hidden="true"></a>    <span class="cf">return</span> w(I1[:,<span class="va">None</span>] <span class="op">*</span> I2[<span class="va">None</span>,:], n1<span class="op">*</span>n2).astype(<span class="st">&#39;complex64&#39;</span>)</span></code></pre></div>
</div>
<h2 id="radix-4-fft-example">Radix-4 FFT example</h2>
<p>The radix-4 FFT, takes four elements in every butterfly operation, along with four weights.</p>
<div class="annotated-code">
<p><span><em>«fft-ps-4»=</em></span></p>
<div class="sourceCode" id="fft-ps-4"><pre class="sourceCode python"><code class="sourceCode python"><span id="fft-ps-4-1"><a href="#fft-ps-4-1" aria-hidden="true"></a><span class="kw">def</span> fft4(x0, x1, x2, x3, w0<span class="op">=</span><span class="dv">1</span>, w1<span class="op">=</span><span class="dv">1</span>, w2<span class="op">=</span><span class="dv">1</span>, w3<span class="op">=</span><span class="dv">1</span>):</span>
<span id="fft-ps-4-2"><a href="#fft-ps-4-2" aria-hidden="true"></a>    a <span class="op">=</span> w0<span class="op">*</span>x0 <span class="op">+</span> w2<span class="op">*</span>x2</span>
<span id="fft-ps-4-3"><a href="#fft-ps-4-3" aria-hidden="true"></a>    b <span class="op">=</span> w1<span class="op">*</span>x1 <span class="op">+</span> w3<span class="op">*</span>x3</span>
<span id="fft-ps-4-4"><a href="#fft-ps-4-4" aria-hidden="true"></a>    c <span class="op">=</span> w0<span class="op">*</span>x0 <span class="op">-</span> w2<span class="op">*</span>x2</span>
<span id="fft-ps-4-5"><a href="#fft-ps-4-5" aria-hidden="true"></a>    d <span class="op">=</span> w1<span class="op">*</span>x1 <span class="op">-</span> w3<span class="op">*</span>x3</span>
<span id="fft-ps-4-6"><a href="#fft-ps-4-6" aria-hidden="true"></a>    x0[:] <span class="op">=</span> a <span class="op">+</span> b</span>
<span id="fft-ps-4-7"><a href="#fft-ps-4-7" aria-hidden="true"></a>    x1[:] <span class="op">=</span> c <span class="op">-</span> <span class="ot">1j</span><span class="op">*</span>d</span>
<span id="fft-ps-4-8"><a href="#fft-ps-4-8" aria-hidden="true"></a>    x2[:] <span class="op">=</span> a <span class="op">-</span> b</span>
<span id="fft-ps-4-9"><a href="#fft-ps-4-9" aria-hidden="true"></a>    x3[:] <span class="op">=</span> c <span class="op">+</span> <span class="ot">1j</span><span class="op">*</span>d</span></code></pre></div>
</div>
<p>We’ll perform a <span class="math inline">\(N=64\)</span> FFT,</p>
<div class="annotated-code">
<p><span><em>«fft-ps-4»+</em></span></p>
<div class="sourceCode" id="fft-ps-4"><pre class="sourceCode python"><code class="sourceCode python"><span id="fft-ps-4-1"><a href="#fft-ps-4-1" aria-hidden="true"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="fft-ps-4-2"><a href="#fft-ps-4-2" aria-hidden="true"></a>np.set_printoptions(precision<span class="op">=</span><span class="dv">4</span>)</span>
<span id="fft-ps-4-3"><a href="#fft-ps-4-3" aria-hidden="true"></a></span>
<span id="fft-ps-4-4"><a href="#fft-ps-4-4" aria-hidden="true"></a><span class="im">from</span> fftsynth.parity <span class="im">import</span> ParitySplitting</span>
<span id="fft-ps-4-5"><a href="#fft-ps-4-5" aria-hidden="true"></a><span class="im">from</span> fftsynth.twiddle <span class="im">import</span> make_twiddle</span>
<span id="fft-ps-4-6"><a href="#fft-ps-4-6" aria-hidden="true"></a></span>
<span id="fft-ps-4-7"><a href="#fft-ps-4-7" aria-hidden="true"></a>PS <span class="op">=</span> ParitySplitting(<span class="dv">64</span>, <span class="dv">4</span>)</span>
<span id="fft-ps-4-8"><a href="#fft-ps-4-8" aria-hidden="true"></a>x <span class="op">=</span> np.fft.ifft(np.arange(<span class="dv">0</span>, PS.N, dtype<span class="op">=</span><span class="st">&#39;complex64&#39;</span>))</span></code></pre></div>
</div>
<p>We reshape the input data, and transpose the result</p>
<div class="annotated-code">
<p><span><em>«fft-ps-4»+</em></span></p>
<div class="sourceCode" id="fft-ps-4"><pre class="sourceCode python"><code class="sourceCode python"><span id="fft-ps-4-1"><a href="#fft-ps-4-1" aria-hidden="true"></a>s <span class="op">=</span> x.copy().reshape(PS.factors).transpose()</span></code></pre></div>
</div>
<p>Then the transform looks like</p>
<div class="annotated-code">
<p><span><em>«fft-ps-4»+</em></span></p>
<div class="sourceCode" id="fft-ps-4"><pre class="sourceCode python"><code class="sourceCode python"><span id="fft-ps-4-1"><a href="#fft-ps-4-1" aria-hidden="true"></a><span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(PS.factors)):</span>
<span id="fft-ps-4-2"><a href="#fft-ps-4-2" aria-hidden="true"></a>    w <span class="op">=</span> make_twiddle(<span class="dv">4</span>, <span class="dv">4</span><span class="op">**</span>k).conj()[:,:]</span>
<span id="fft-ps-4-3"><a href="#fft-ps-4-3" aria-hidden="true"></a>    z <span class="op">=</span> s.reshape([<span class="op">-</span><span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">4</span><span class="op">**</span>k])</span>
<span id="fft-ps-4-4"><a href="#fft-ps-4-4" aria-hidden="true"></a>    z <span class="op">*=</span> w</span>
<span id="fft-ps-4-5"><a href="#fft-ps-4-5" aria-hidden="true"></a>    fft4(<span class="op">*</span>(z[..., l, :] <span class="cf">for</span> l <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>)))</span>
<span id="fft-ps-4-6"><a href="#fft-ps-4-6" aria-hidden="true"></a>    s <span class="op">=</span> z</span></code></pre></div>
</div>
<p>In every step, we multiply with twiddles, select a dimension to transform over and perform the butterfly.</p>
<div class="annotated-code">
<p><span><em>«fft-ps-4»+</em></span></p>
<div class="doctest" data-status="SUCCESS">
<div class="doctestInput">
<div class="sourceCode" id="fft-ps-4"><pre class="sourceCode python eval"><code class="sourceCode python"><span id="fft-ps-4-1"><a href="#fft-ps-4-1" aria-hidden="true"></a><span class="bu">print</span>(s.flatten().real)</span></code></pre></div>
</div>
<div class="doctestResult">
<div class="sourceCode" id="cb7"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>[ 0.  1.  2.  3.  4.  5.  6.  7.  8.  9. 10. 11. 12. 13. 14. 15. 16. 17.</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a> 18. 19. 20. 21. 22. 23. 24. 25. 26. 27. 28. 29. 30. 31. 32. 33. 34. 35.</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a> 36. 37. 38. 39. 40. 41. 42. 43. 44. 45. 46. 47. 48. 49. 50. 51. 52. 53.</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a> 54. 55. 56. 57. 58. 59. 60. 61. 62. 63.]</span></code></pre></div>
</div>
</div>
</div>
<h2 id="index-functions">Index functions</h2>
<div class="annotated-code">
<p><span><em>«parity-index-functions»=</em></span></p>
<div class="sourceCode" id="parity-index-functions"><pre class="sourceCode python"><code class="sourceCode python"><span id="parity-index-functions-1"><a href="#parity-index-functions-1" aria-hidden="true"></a><span class="kw">def</span> comp_idx(radix: <span class="bu">int</span>, i: <span class="bu">int</span>, j: <span class="bu">int</span>, k: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="parity-index-functions-2"><a href="#parity-index-functions-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Computes the array index of the k-th iteration of the FFT. We view the</span></span>
<span id="parity-index-functions-3"><a href="#parity-index-functions-3" aria-hidden="true"></a><span class="co">    input array as a multi-dimensional array of shape [r,r,r, ...]. Each iteration</span></span>
<span id="parity-index-functions-4"><a href="#parity-index-functions-4" aria-hidden="true"></a><span class="co">    we perform the butterfly operation on two axes within the n-dimensional array.</span></span>
<span id="parity-index-functions-5"><a href="#parity-index-functions-5" aria-hidden="true"></a></span>
<span id="parity-index-functions-6"><a href="#parity-index-functions-6" aria-hidden="true"></a><span class="co">    Here we factor out `i` into `rem=i % r**k` and `base=i - rem`, and then construct</span></span>
<span id="parity-index-functions-7"><a href="#parity-index-functions-7" aria-hidden="true"></a><span class="co">    result as `rem + j*r**k + base*r`. God knows why.&quot;&quot;&quot;</span></span>
<span id="parity-index-functions-8"><a href="#parity-index-functions-8" aria-hidden="true"></a>    rem  <span class="op">=</span> i <span class="op">%</span> radix<span class="op">**</span>k</span>
<span id="parity-index-functions-9"><a href="#parity-index-functions-9" aria-hidden="true"></a>    base <span class="op">=</span> i <span class="op">-</span> rem</span>
<span id="parity-index-functions-10"><a href="#parity-index-functions-10" aria-hidden="true"></a>    <span class="cf">return</span> rem <span class="op">+</span> j <span class="op">*</span> radix<span class="op">**</span>k <span class="op">+</span> base <span class="op">*</span> radix</span>
<span id="parity-index-functions-11"><a href="#parity-index-functions-11" aria-hidden="true"></a></span>
<span id="parity-index-functions-12"><a href="#parity-index-functions-12" aria-hidden="true"></a></span>
<span id="parity-index-functions-13"><a href="#parity-index-functions-13" aria-hidden="true"></a><span class="kw">def</span> comp_perm(radix: <span class="bu">int</span>, i: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="parity-index-functions-14"><a href="#parity-index-functions-14" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;In each iteration we use a different permutation of indices. We take the</span></span>
<span id="parity-index-functions-15"><a href="#parity-index-functions-15" aria-hidden="true"></a><span class="co">    parity of the highest digits of i, and use that number to cycle the lowest digit</span></span>
<span id="parity-index-functions-16"><a href="#parity-index-functions-16" aria-hidden="true"></a><span class="co">    around.&quot;&quot;&quot;</span></span>
<span id="parity-index-functions-17"><a href="#parity-index-functions-17" aria-hidden="true"></a>    rem  <span class="op">=</span> i <span class="op">%</span> radix</span>
<span id="parity-index-functions-18"><a href="#parity-index-functions-18" aria-hidden="true"></a>    base <span class="op">=</span> i <span class="op">-</span> rem</span>
<span id="parity-index-functions-19"><a href="#parity-index-functions-19" aria-hidden="true"></a>    p <span class="op">=</span> parity(radix, base)</span>
<span id="parity-index-functions-20"><a href="#parity-index-functions-20" aria-hidden="true"></a>    <span class="cf">return</span> base <span class="op">+</span> (rem <span class="op">-</span> p) <span class="op">%</span> radix</span></code></pre></div>
</div>
<h2 id="properties">Properties</h2>
<p>This interface should ease the implementation of the parity-splitting FFT.</p>
<div class="fold-block">
<button class="btn btn-outline-primary btn-sm fold-toggle" type="button" data-toggle="collapse" data-target="#parity-splitting-interface-container" aria-controls="parity-splitting-interface-container">&lt;&lt;parity-splitting-interface&gt;&gt;=</button>
<div id="parity-splitting-interface-container" class="collapse">
<div class="sourceCode" id="parity-splitting-interface" style="max-height: 50vh"><pre class="sourceCode python bootstrap-fold overflow-auto"><code class="sourceCode python"><span id="parity-splitting-interface-1"><a href="#parity-splitting-interface-1" aria-hidden="true"></a><span class="at">@dataclass</span></span>
<span id="parity-splitting-interface-2"><a href="#parity-splitting-interface-2" aria-hidden="true"></a><span class="kw">class</span> ParitySplitting:</span>
<span id="parity-splitting-interface-3"><a href="#parity-splitting-interface-3" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Collects a lot of properties on the parity-splitting FFT algorithm.</span></span>
<span id="parity-splitting-interface-4"><a href="#parity-splitting-interface-4" aria-hidden="true"></a><span class="co">    This algorithm splits memory access for radix-n algorithms into n</span></span>
<span id="parity-splitting-interface-5"><a href="#parity-splitting-interface-5" aria-hidden="true"></a><span class="co">    chunks, such that each chunk is only accessed once for each butterfly</span></span>
<span id="parity-splitting-interface-6"><a href="#parity-splitting-interface-6" aria-hidden="true"></a><span class="co">    operation. Pseudo code:</span></span>
<span id="parity-splitting-interface-7"><a href="#parity-splitting-interface-7" aria-hidden="true"></a></span>
<span id="parity-splitting-interface-8"><a href="#parity-splitting-interface-8" aria-hidden="true"></a><span class="co">        for k in range(depth):</span></span>
<span id="parity-splitting-interface-9"><a href="#parity-splitting-interface-9" aria-hidden="true"></a><span class="co">            for i in range(L):</span></span>
<span id="parity-splitting-interface-10"><a href="#parity-splitting-interface-10" aria-hidden="true"></a><span class="co">                for j in range(radix):</span></span>
<span id="parity-splitting-interface-11"><a href="#parity-splitting-interface-11" aria-hidden="true"></a><span class="co">                    fft(*permute(chunks), W)</span></span>
<span id="parity-splitting-interface-12"><a href="#parity-splitting-interface-12" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="parity-splitting-interface-13"><a href="#parity-splitting-interface-13" aria-hidden="true"></a>    N: <span class="bu">int</span></span>
<span id="parity-splitting-interface-14"><a href="#parity-splitting-interface-14" aria-hidden="true"></a>    radix: <span class="bu">int</span></span>
<span id="parity-splitting-interface-15"><a href="#parity-splitting-interface-15" aria-hidden="true"></a></span>
<span id="parity-splitting-interface-16"><a href="#parity-splitting-interface-16" aria-hidden="true"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-17"><a href="#parity-splitting-interface-17" aria-hidden="true"></a>    <span class="kw">def</span> depth(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="parity-splitting-interface-18"><a href="#parity-splitting-interface-18" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;radix-log of FFT size&quot;&quot;&quot;</span></span>
<span id="parity-splitting-interface-19"><a href="#parity-splitting-interface-19" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">int</span>(math.log(<span class="va">self</span>.N, <span class="va">self</span>.radix))</span>
<span id="parity-splitting-interface-20"><a href="#parity-splitting-interface-20" aria-hidden="true"></a></span>
<span id="parity-splitting-interface-21"><a href="#parity-splitting-interface-21" aria-hidden="true"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-22"><a href="#parity-splitting-interface-22" aria-hidden="true"></a>    <span class="kw">def</span> M(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="parity-splitting-interface-23"><a href="#parity-splitting-interface-23" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;N // radix&quot;&quot;&quot;</span></span>
<span id="parity-splitting-interface-24"><a href="#parity-splitting-interface-24" aria-hidden="true"></a>        <span class="cf">return</span> <span class="va">self</span>.N<span class="op">//</span><span class="va">self</span>.radix</span>
<span id="parity-splitting-interface-25"><a href="#parity-splitting-interface-25" aria-hidden="true"></a></span>
<span id="parity-splitting-interface-26"><a href="#parity-splitting-interface-26" aria-hidden="true"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-27"><a href="#parity-splitting-interface-27" aria-hidden="true"></a>    <span class="kw">def</span> L(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="parity-splitting-interface-28"><a href="#parity-splitting-interface-28" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;N // radix**2&quot;&quot;&quot;</span></span>
<span id="parity-splitting-interface-29"><a href="#parity-splitting-interface-29" aria-hidden="true"></a>        <span class="cf">return</span> <span class="va">self</span>.M<span class="op">//</span><span class="va">self</span>.radix</span>
<span id="parity-splitting-interface-30"><a href="#parity-splitting-interface-30" aria-hidden="true"></a></span>
<span id="parity-splitting-interface-31"><a href="#parity-splitting-interface-31" aria-hidden="true"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-32"><a href="#parity-splitting-interface-32" aria-hidden="true"></a>    <span class="kw">def</span> factors(<span class="va">self</span>) <span class="op">-&gt;</span> List[<span class="bu">int</span>]:</span>
<span id="parity-splitting-interface-33"><a href="#parity-splitting-interface-33" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Shape of FFT&quot;&quot;&quot;</span></span>
<span id="parity-splitting-interface-34"><a href="#parity-splitting-interface-34" aria-hidden="true"></a>        <span class="cf">return</span> [<span class="va">self</span>.radix] <span class="op">*</span> <span class="va">self</span>.depth</span>
<span id="parity-splitting-interface-35"><a href="#parity-splitting-interface-35" aria-hidden="true"></a></span>
<span id="parity-splitting-interface-36"><a href="#parity-splitting-interface-36" aria-hidden="true"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-37"><a href="#parity-splitting-interface-37" aria-hidden="true"></a>    <span class="kw">def</span> channels(<span class="va">self</span>) <span class="op">-&gt;</span> Iterator[Tuple[<span class="bu">int</span>, Iterator[<span class="bu">int</span>]]]:</span>
<span id="parity-splitting-interface-38"><a href="#parity-splitting-interface-38" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Pattern for memory chunks&quot;&quot;&quot;</span></span>
<span id="parity-splitting-interface-39"><a href="#parity-splitting-interface-39" aria-hidden="true"></a>        <span class="cf">return</span> channels(<span class="va">self</span>.N, <span class="va">self</span>.radix)</span>
<span id="parity-splitting-interface-40"><a href="#parity-splitting-interface-40" aria-hidden="true"></a></span>
<span id="parity-splitting-interface-41"><a href="#parity-splitting-interface-41" aria-hidden="true"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-42"><a href="#parity-splitting-interface-42" aria-hidden="true"></a>    <span class="kw">def</span> channel_loc(<span class="va">self</span>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="parity-splitting-interface-43"><a href="#parity-splitting-interface-43" aria-hidden="true"></a>        x <span class="op">=</span> np.zeros(shape<span class="op">=</span>(<span class="va">self</span>.N,), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="parity-splitting-interface-44"><a href="#parity-splitting-interface-44" aria-hidden="true"></a>        <span class="cf">for</span> g, i <span class="kw">in</span> <span class="va">self</span>.channels:</span>
<span id="parity-splitting-interface-45"><a href="#parity-splitting-interface-45" aria-hidden="true"></a>            x[<span class="bu">list</span>(i)] <span class="op">=</span> g</span>
<span id="parity-splitting-interface-46"><a href="#parity-splitting-interface-46" aria-hidden="true"></a>        <span class="cf">return</span> x.reshape(<span class="va">self</span>.factors)</span>
<span id="parity-splitting-interface-47"><a href="#parity-splitting-interface-47" aria-hidden="true"></a></span>
<span id="parity-splitting-interface-48"><a href="#parity-splitting-interface-48" aria-hidden="true"></a>    <span class="at">@property</span></span>
<span id="parity-splitting-interface-49"><a href="#parity-splitting-interface-49" aria-hidden="true"></a>    <span class="kw">def</span> index_loc(<span class="va">self</span>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="parity-splitting-interface-50"><a href="#parity-splitting-interface-50" aria-hidden="true"></a>        x <span class="op">=</span> np.zeros(shape<span class="op">=</span>(<span class="va">self</span>.N,), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="parity-splitting-interface-51"><a href="#parity-splitting-interface-51" aria-hidden="true"></a>        <span class="cf">for</span> g, i <span class="kw">in</span> <span class="va">self</span>.channels:</span>
<span id="parity-splitting-interface-52"><a href="#parity-splitting-interface-52" aria-hidden="true"></a>            x[<span class="bu">list</span>(i)] <span class="op">=</span> np.arange(<span class="va">self</span>.M, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="parity-splitting-interface-53"><a href="#parity-splitting-interface-53" aria-hidden="true"></a>        <span class="cf">return</span> x.reshape(<span class="va">self</span>.factors)</span>
<span id="parity-splitting-interface-54"><a href="#parity-splitting-interface-54" aria-hidden="true"></a></span>
<span id="parity-splitting-interface-55"><a href="#parity-splitting-interface-55" aria-hidden="true"></a>    <span class="kw">def</span> mix(<span class="va">self</span>, x: np.ndarray) <span class="op">-&gt;</span> List[np.ndarray]:</span>
<span id="parity-splitting-interface-56"><a href="#parity-splitting-interface-56" aria-hidden="true"></a>        <span class="cf">return</span> [x[<span class="bu">list</span>(i)].copy() <span class="cf">for</span> g, i <span class="kw">in</span> <span class="va">self</span>.channels]</span>
<span id="parity-splitting-interface-57"><a href="#parity-splitting-interface-57" aria-hidden="true"></a></span>
<span id="parity-splitting-interface-58"><a href="#parity-splitting-interface-58" aria-hidden="true"></a>    <span class="kw">def</span> unmix(<span class="va">self</span>, s: Sequence[np.ndarray]) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="parity-splitting-interface-59"><a href="#parity-splitting-interface-59" aria-hidden="true"></a>        x <span class="op">=</span> np.zeros(shape<span class="op">=</span>(<span class="va">self</span>.N,), dtype<span class="op">=</span><span class="st">&#39;complex64&#39;</span>)</span>
<span id="parity-splitting-interface-60"><a href="#parity-splitting-interface-60" aria-hidden="true"></a>        <span class="cf">for</span> g, i <span class="kw">in</span> <span class="va">self</span>.channels:</span>
<span id="parity-splitting-interface-61"><a href="#parity-splitting-interface-61" aria-hidden="true"></a>            x[<span class="bu">list</span>(i)] <span class="op">=</span> s[g]</span>
<span id="parity-splitting-interface-62"><a href="#parity-splitting-interface-62" aria-hidden="true"></a>        <span class="cf">return</span> x</span></code></pre></div>
</div>
</div>
<h1 id="fused-multiply-add-codelets">Fused-Multiply-Add codelets</h1>
<p>Rewriting FFT codelets to contain <strong>more</strong> floating-point operations, but increase the fraction of FP operations inside an FMA operation can increase the efficiency on some architectures.</p>
<h2 id="twiddle-factors">Twiddle factors</h2>
<p>Only half of the twiddle factors are used.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/fma-twiddles.cl»=</em></span></p>
<div class="sourceCode" id="cb8" data-file="fftsynth/templates/fma-twiddles.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="kw">__constant</span> <span class="dt">float2</span> W[{{ W.shape[<span class="dv">0</span>] - radix }}][{{ n_twiddles }}] = {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>{% <span class="kw">for</span> ws in W[radix:] %}</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>{ {% <span class="kw">for</span> w in ws[<span class="dv">1</span>:n_twiddles+<span class="dv">1</span>] -%}</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>(<span class="dt">float2</span>)({{ <span class="st">&quot;%0.6f&quot;</span> | format(w.real) }}f, {{ <span class="st">&quot;%0.6f&quot;</span> | format(w.imag) }}f) {%- <span class="kw">if</span> not loop.last %}, {% endif %}</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>{%- endfor %} } {%- <span class="kw">if</span> not loop.last %},{% endif %}</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>{%- endfor %}</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>};</span></code></pre></div>
</div>
<h2 id="radix-2">Radix 2</h2>
<p>A normal implementation of the radix-2 butterfly</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="dt">void</span> radix2(<span class="dt">float2</span> e, <span class="dt">float2</span> o, <span class="dt">float2</span> w, <span class="dt">float2</span>* xa, <span class="dt">float2</span>* xb)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>{</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>    <span class="dt">float2</span> t = w * o;</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>    *xa = e + t;</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>    *xb = e - t;</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>}</span></code></pre></div>
<p>This contains one complex multiplication and two complex additions, totaling four floating point multiplications and six additions.</p>
<div class="annotated-code">
<p><span><em>«fma-radix2»=</em></span></p>
<div class="sourceCode" id="fma-radix2"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="fma-radix2-1"><a href="#fma-radix2-1" aria-hidden="true"></a>{% <span class="kw">if</span> radix == <span class="dv">2</span> %}</span>
<span id="fma-radix2-2"><a href="#fma-radix2-2" aria-hidden="true"></a><span class="dt">void</span> fft_2(<span class="dt">float2</span> * <span class="dt">restrict</span> s0, <span class="dt">float2</span> * <span class="dt">restrict</span> s1,{% <span class="kw">if</span> fpga %} <span class="dt">float2</span> * <span class="dt">restrict</span> s0_in, <span class="dt">float2</span> * <span class="dt">restrict</span> s1_in, <span class="dt">float2</span> * <span class="dt">restrict</span> s0_out, <span class="dt">float2</span> * <span class="dt">restrict</span> s1_out, <span class="dt">bool</span> first_iteration, <span class="dt">bool</span> last_iteration,{% endif %} <span class="dt">int</span> cycle, <span class="dt">int</span> i0, <span class="dt">int</span> i1, <span class="dt">int</span> iw)</span>
<span id="fma-radix2-3"><a href="#fma-radix2-3" aria-hidden="true"></a>{</span>
<span id="fma-radix2-4"><a href="#fma-radix2-4" aria-hidden="true"></a>    <span class="dt">float2</span> t0, t1, a, b;</span>
<span id="fma-radix2-5"><a href="#fma-radix2-5" aria-hidden="true"></a>    <span class="kw">__constant</span> <span class="dt">float2</span> *w = W[iw];</span>
<span id="fma-radix2-6"><a href="#fma-radix2-6" aria-hidden="true"></a></span>
<span id="fma-radix2-7"><a href="#fma-radix2-7" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga %}</span>
<span id="fma-radix2-8"><a href="#fma-radix2-8" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="fma-radix2-9"><a href="#fma-radix2-9" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: SWAP(<span class="dt">int</span>, i0, i1); <span class="kw">break</span>;</span>
<span id="fma-radix2-10"><a href="#fma-radix2-10" aria-hidden="true"></a>    }</span>
<span id="fma-radix2-11"><a href="#fma-radix2-11" aria-hidden="true"></a>    <span class="kw">if</span> ( first_iteration )</span>
<span id="fma-radix2-12"><a href="#fma-radix2-12" aria-hidden="true"></a>    {</span>
<span id="fma-radix2-13"><a href="#fma-radix2-13" aria-hidden="true"></a>        t0 = s0_in[i0]; t1 = s1_in[i1];</span>
<span id="fma-radix2-14"><a href="#fma-radix2-14" aria-hidden="true"></a>    }</span>
<span id="fma-radix2-15"><a href="#fma-radix2-15" aria-hidden="true"></a>    <span class="kw">else</span></span>
<span id="fma-radix2-16"><a href="#fma-radix2-16" aria-hidden="true"></a>    {</span>
<span id="fma-radix2-17"><a href="#fma-radix2-17" aria-hidden="true"></a>        t0 = s0[i0]; t1 = s1[i1];</span>
<span id="fma-radix2-18"><a href="#fma-radix2-18" aria-hidden="true"></a>    }</span>
<span id="fma-radix2-19"><a href="#fma-radix2-19" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="fma-radix2-20"><a href="#fma-radix2-20" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: SWAP(<span class="dt">float2</span>, t0, t1); <span class="kw">break</span>;</span>
<span id="fma-radix2-21"><a href="#fma-radix2-21" aria-hidden="true"></a>    }</span>
<span id="fma-radix2-22"><a href="#fma-radix2-22" aria-hidden="true"></a>    {% <span class="kw">else</span> %}</span>
<span id="fma-radix2-23"><a href="#fma-radix2-23" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="fma-radix2-24"><a href="#fma-radix2-24" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">0</span>: t0 = s0[i0]; t1 = s1[i1]; <span class="kw">break</span>;</span>
<span id="fma-radix2-25"><a href="#fma-radix2-25" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: t0 = s1[i0]; t1 = s0[i1]; <span class="kw">break</span>;</span>
<span id="fma-radix2-26"><a href="#fma-radix2-26" aria-hidden="true"></a>    }</span>
<span id="fma-radix2-27"><a href="#fma-radix2-27" aria-hidden="true"></a>    {% endif %}</span>
<span id="fma-radix2-28"><a href="#fma-radix2-28" aria-hidden="true"></a></span>
<span id="fma-radix2-29"><a href="#fma-radix2-29" aria-hidden="true"></a>    a = (<span class="dt">float2</span>) (-w[<span class="dv">0</span>].y * t1.y + t0.x, w[<span class="dv">0</span>].y * t1.x + t0.y);</span>
<span id="fma-radix2-30"><a href="#fma-radix2-30" aria-hidden="true"></a>    a += (<span class="dt">float2</span>) (w[<span class="dv">0</span>].x * t1.x, w[<span class="dv">0</span>].x * t1.y);</span>
<span id="fma-radix2-31"><a href="#fma-radix2-31" aria-hidden="true"></a>    b = <span class="dv">2</span> * t0 - a;</span>
<span id="fma-radix2-32"><a href="#fma-radix2-32" aria-hidden="true"></a></span>
<span id="fma-radix2-33"><a href="#fma-radix2-33" aria-hidden="true"></a>    t0 = a;</span>
<span id="fma-radix2-34"><a href="#fma-radix2-34" aria-hidden="true"></a>    t1 = b;</span>
<span id="fma-radix2-35"><a href="#fma-radix2-35" aria-hidden="true"></a></span>
<span id="fma-radix2-36"><a href="#fma-radix2-36" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga %}</span>
<span id="fma-radix2-37"><a href="#fma-radix2-37" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="fma-radix2-38"><a href="#fma-radix2-38" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: SWAP(<span class="dt">float2</span>, t0, t1); <span class="kw">break</span>;</span>
<span id="fma-radix2-39"><a href="#fma-radix2-39" aria-hidden="true"></a>    }</span>
<span id="fma-radix2-40"><a href="#fma-radix2-40" aria-hidden="true"></a>    <span class="kw">if</span> ( last_iteration )</span>
<span id="fma-radix2-41"><a href="#fma-radix2-41" aria-hidden="true"></a>    {</span>
<span id="fma-radix2-42"><a href="#fma-radix2-42" aria-hidden="true"></a>        s0_out[i0] = t0; s1_out[i1] = t1;</span>
<span id="fma-radix2-43"><a href="#fma-radix2-43" aria-hidden="true"></a>    }</span>
<span id="fma-radix2-44"><a href="#fma-radix2-44" aria-hidden="true"></a>    <span class="kw">else</span></span>
<span id="fma-radix2-45"><a href="#fma-radix2-45" aria-hidden="true"></a>    {</span>
<span id="fma-radix2-46"><a href="#fma-radix2-46" aria-hidden="true"></a>        s0[i0] = t0; s1[i1] = t1;</span>
<span id="fma-radix2-47"><a href="#fma-radix2-47" aria-hidden="true"></a>    }</span>
<span id="fma-radix2-48"><a href="#fma-radix2-48" aria-hidden="true"></a>    {% <span class="kw">else</span> %}</span>
<span id="fma-radix2-49"><a href="#fma-radix2-49" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="fma-radix2-50"><a href="#fma-radix2-50" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">0</span>: s0[i0] = t0; s1[i1] = t1; <span class="kw">break</span>;</span>
<span id="fma-radix2-51"><a href="#fma-radix2-51" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: s1[i0] = t0; s0[i1] = t1; <span class="kw">break</span>;</span>
<span id="fma-radix2-52"><a href="#fma-radix2-52" aria-hidden="true"></a>    }</span>
<span id="fma-radix2-53"><a href="#fma-radix2-53" aria-hidden="true"></a>    {% endif %}</span>
<span id="fma-radix2-54"><a href="#fma-radix2-54" aria-hidden="true"></a>}</span>
<span id="fma-radix2-55"><a href="#fma-radix2-55" aria-hidden="true"></a>{% endif %}</span></code></pre></div>
</div>
<p>Now we have six multiplications and six additions, but they are completely contained in six FMA operations.</p>
<h2 id="higher-radix">Higher radix</h2>
<div class="fold-block">
<button class="btn btn-outline-primary btn-sm fold-toggle" type="button" data-toggle="collapse" data-target="#fftsynth-slash-templates-slash-fma-codelets-dot-cl-container" aria-controls="fftsynth-slash-templates-slash-fma-codelets-dot-cl-container">&lt;&lt;fftsynth/templates/fma-codelets.cl&gt;&gt;=</button>
<div id="fftsynth-slash-templates-slash-fma-codelets-dot-cl-container" class="collapse">
<div class="sourceCode" id="cb10" data-file="fftsynth/templates/fma-codelets.cl" style="max-height: 50vh"><pre class="sourceCode opencl bootstrap-fold overflow-auto"><code class="sourceCode opencl"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>&lt;&lt;fma-radix2&gt;&gt;</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>{% <span class="kw">if</span> radix == <span class="dv">3</span> %}</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="dt">void</span> fft_3(<span class="dt">float2</span> t0, <span class="dt">float2</span> t1, <span class="dt">float2</span> t2, <span class="dt">float2</span> w0, <span class="dt">float2</span> w1, <span class="dt">float2</span>* xa, <span class="dt">float2</span>* xb, <span class="dt">float2</span>* xc) {</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a>    <span class="dt">float2</span> z1, s1, s2, s3, s4, s5, s6;</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a>    <span class="dt">const</span> <span class="dt">float</span> c1 = <span class="fl">-0.5</span>;</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>    <span class="dt">const</span> <span class="dt">float</span> c2 = <span class="fl">-0.8660254037844386</span>;</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a>    <span class="co">//z1 = w0 * t1</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a>    z1 = (<span class="dt">float2</span>) (w0.x * t1.x - w0.y * t1.y,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a>                   w0.x * t1.y + w0.y * t1.x);</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true"></a>    <span class="co">//s1 = z1 - w1 * t2</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true"></a>    s1 = (<span class="dt">float2</span>) (z1.x - w1.x * t2.x + w1.y * t2.y,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true"></a>                   z1.y - w1.x * t2.y - w1.y * t2.x);</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true"></a>    <span class="co">//s2 = 2*z1 - s1</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true"></a>    s2 = (<span class="dt">float2</span>) (<span class="dv">2</span>*z1.x - s1.x,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true"></a>                   <span class="dv">2</span>*z1.y - s1.y);</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true"></a>    <span class="co">//s3 = s2 + t0</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true"></a>    s3 = (<span class="dt">float2</span>) (s2.x + t0.x,</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true"></a>                   s2.y + t0.y);</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true"></a>    <span class="co">//s4 = t0 + c1*s2</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true"></a>    s4 = (<span class="dt">float2</span>) (t0.x + c1*s2.x,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true"></a>                   t0.y + c1*s2.y);</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true"></a>    <span class="co">//s5 = s4-i*c2*s1</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true"></a>    s5 = (<span class="dt">float2</span>) (s4.x - c2*s1.y,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true"></a>                   s4.y + c2*s1.x);</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true"></a>    <span class="co">//s6 = 2*s4-s5</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true"></a>    s6 = (<span class="dt">float2</span>) (<span class="dv">2</span>*s4.x - s5.x,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true"></a>                   <span class="dv">2</span>*s4.y - s5.y);</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true"></a>    *xa = s3;</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true"></a>    *xb = s5; <span class="co">//pseudo code in karner2001multiply paper says s6</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true"></a>    *xc = s6; <span class="co">//pseudo code in karner2001multiply paper says s5</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true"></a>}</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true"></a>{% endif %}</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true"></a>{% <span class="kw">if</span> radix == <span class="dv">4</span> %}</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true"></a><span class="dt">void</span> fft_4(<span class="dt">float2</span> * <span class="dt">restrict</span> s0, <span class="dt">float2</span> * <span class="dt">restrict</span> s1, <span class="dt">float2</span> * <span class="dt">restrict</span> s2, <span class="dt">float2</span> * <span class="dt">restrict</span> s3,{% <span class="kw">if</span> fpga %} <span class="dt">float2</span> * <span class="dt">restrict</span> s0_in, <span class="dt">float2</span> * <span class="dt">restrict</span> s1_in, <span class="dt">float2</span> * <span class="dt">restrict</span> s2_in, <span class="dt">float2</span> * <span class="dt">restrict</span> s3_in, <span class="dt">float2</span> * <span class="dt">restrict</span> s0_out, <span class="dt">float2</span> * <span class="dt">restrict</span> s1_out, <span class="dt">float2</span> * <span class="dt">restrict</span> s2_out, <span class="dt">float2</span> * <span class="dt">restrict</span> s3_out, <span class="dt">bool</span> first_iteration, <span class="dt">bool</span> last_iteration,{% endif %} <span class="dt">int</span> cycle, <span class="dt">int</span> i0, <span class="dt">int</span> i1, <span class="dt">int</span> i2, <span class="dt">int</span> i3, <span class="dt">int</span> iw)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true"></a>{</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true"></a>     <span class="dt">float2</span> t0, t1, t2, t3, a, b, c, d;</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true"></a>    <span class="kw">__constant</span> <span class="dt">float2</span> *w = W[iw];</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true"></a></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga %}</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: SWAP(<span class="dt">int</span>, i0, i1); SWAP(<span class="dt">int</span>, i2, i3); SWAP(<span class="dt">int</span>, i0, i2); <span class="kw">break</span>;</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">2</span>: SWAP(<span class="dt">int</span>, i0, i2); SWAP(<span class="dt">int</span>, i1, i3); <span class="kw">break</span>;</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">3</span>: SWAP(<span class="dt">int</span>, i0, i1); SWAP(<span class="dt">int</span>, i1, i3); SWAP(<span class="dt">int</span>, i1, i2); <span class="kw">break</span>;</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true"></a>    }</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true"></a>    <span class="kw">if</span> ( first_iteration )</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true"></a>    {</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true"></a>        t0 = s0_in[i0]; t1 = s1_in[i1]; t2 = s2_in[i2]; t3 = s3_in[i3];</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true"></a>    }</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true"></a>    <span class="kw">else</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true"></a>    {</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true"></a>        t0 = s0[i0]; t1 = s1[i1]; t2 = s2[i2]; t3 = s3[i3];</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true"></a>    }</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: SWAP(<span class="dt">float2</span>, t0, t1); SWAP(<span class="dt">float2</span>, t1, t2); SWAP(<span class="dt">float2</span>, t2, t3); <span class="kw">break</span>;</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">2</span>: SWAP(<span class="dt">float2</span>, t0, t2); SWAP(<span class="dt">float2</span>, t1, t3); <span class="kw">break</span>;</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">3</span>: SWAP(<span class="dt">float2</span>, t2, t3); SWAP(<span class="dt">float2</span>, t0, t1); SWAP(<span class="dt">float2</span>, t0, t2); <span class="kw">break</span>;</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true"></a>    }</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true"></a>    {% <span class="kw">else</span> %}</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">0</span>: t0 = s0[i0]; t1 = s1[i1]; t2 = s2[i2]; t3 = s3[i3]; <span class="kw">break</span>;</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: t0 = s1[i0]; t1 = s2[i1]; t2 = s3[i2]; t3 = s0[i3]; <span class="kw">break</span>;</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">2</span>: t0 = s2[i0]; t1 = s3[i1]; t2 = s0[i2]; t3 = s1[i3]; <span class="kw">break</span>;</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">3</span>: t0 = s3[i0]; t1 = s0[i1]; t2 = s1[i2]; t3 = s2[i3]; <span class="kw">break</span>;</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true"></a>    }</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true"></a>    {% endif %}</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true"></a></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true"></a>   <span class="co">// adapted from pedram2013transforming, however</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true"></a>   <span class="co">// some versions of the pedram2013transforming paper, including the one hosted by IEEE and the one hosted here:</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true"></a>   <span class="co">// https://www.cs.utexas.edu/users/flame/pubs/LAC_fft.pdf</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true"></a>   <span class="co">// contains serious errors in the FMA-optimized radix-4 pseudocode</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true"></a>   <span class="co">// finally corrected based on the pseudocode reported in karner1998top</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true"></a>    a = t0;     b = t2;     c = t1;     d = t3;</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true"></a></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true"></a>    b = (<span class="dt">float2</span>) (a.x - w[<span class="dv">1</span>].x * b.x + w[<span class="dv">1</span>].y * b.y,</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true"></a>                  a.y - w[<span class="dv">1</span>].x * b.y - w[<span class="dv">1</span>].y * b.x);</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true"></a>    a = (<span class="dt">float2</span>) (<span class="dv">2</span>*a.x - b.x,</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true"></a>                  <span class="dv">2</span>*a.y - b.y);</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true"></a>    d = (<span class="dt">float2</span>) (c.x - w[<span class="dv">1</span>].x * d.x + w[<span class="dv">1</span>].y * d.y,</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true"></a>                  c.y - w[<span class="dv">1</span>].x * d.y - w[<span class="dv">1</span>].y * d.x);</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true"></a>    c = (<span class="dt">float2</span>) (<span class="dv">2</span>*c.x - d.x,</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true"></a>                  <span class="dv">2</span>*c.y - d.y);</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true"></a></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true"></a>    c = (<span class="dt">float2</span>) (a.x - w[<span class="dv">0</span>].x * c.x + w[<span class="dv">0</span>].y * c.y,</span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true"></a>                  a.y - w[<span class="dv">0</span>].x * c.y - w[<span class="dv">0</span>].y * c.x);</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true"></a>    t2 = c;</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true"></a>    t0 = (<span class="dt">float2</span>) (<span class="dv">2</span>*a.x - c.x,</span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true"></a>                    <span class="dv">2</span>*a.y - c.y);</span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true"></a></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true"></a>    <span class="co">//d = b - i*w0*d</span></span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true"></a>    d = (<span class="dt">float2</span>) (b.x + w[<span class="dv">0</span>].x * d.y + w[<span class="dv">0</span>].y * d.x,</span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true"></a>                  b.y - w[<span class="dv">0</span>].x * d.x + w[<span class="dv">0</span>].y * d.y);</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true"></a>    t1 = d;</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true"></a>    t3 = (<span class="dt">float2</span>) (<span class="dv">2</span>*b.x - d.x,</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true"></a>                    <span class="dv">2</span>*b.y - d.y);</span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true"></a></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga %}</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: SWAP(<span class="dt">float2</span>, t2, t3); SWAP(<span class="dt">float2</span>, t1, t2); SWAP(<span class="dt">float2</span>, t0, t1); <span class="kw">break</span>;</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">2</span>: SWAP(<span class="dt">float2</span>, t1, t3); SWAP(<span class="dt">float2</span>, t0, t2); <span class="kw">break</span>;</span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">3</span>: SWAP(<span class="dt">float2</span>, t0, t2); SWAP(<span class="dt">float2</span>, t0, t1); SWAP(<span class="dt">float2</span>, t2, t3); <span class="kw">break</span>;</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true"></a>    }</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true"></a>    <span class="kw">if</span> ( last_iteration )</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true"></a>    {</span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true"></a>        s0_out[i0] = t0; s1_out[i1] = t1; s2_out[i2] = t2; s3_out[i3] = t3;</span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true"></a>    }</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true"></a>    <span class="kw">else</span></span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true"></a>    {</span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true"></a>        s0[i0] = t0; s1[i1] = t1; s2[i2] = t2; s3[i3] = t3;</span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true"></a>    }</span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true"></a>    {% <span class="kw">else</span> %}</span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">0</span>: s0[i0] = t0; s1[i1] = t1; s2[i2] = t2; s3[i3] = t3; <span class="kw">break</span>;</span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: s1[i0] = t0; s2[i1] = t1; s3[i2] = t2; s0[i3] = t3; <span class="kw">break</span>;</span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">2</span>: s2[i0] = t0; s3[i1] = t1; s0[i2] = t2; s1[i3] = t3; <span class="kw">break</span>;</span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">3</span>: s3[i0] = t0; s0[i1] = t1; s1[i2] = t2; s2[i3] = t3; <span class="kw">break</span>;</span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true"></a>    }</span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true"></a>    {% endif %}</span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true"></a>}</span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true"></a>{% endif %}</span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true"></a></span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true"></a></span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true"></a>{% <span class="kw">if</span> radix == <span class="dv">5</span> %}</span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true"></a><span class="dt">float</span> fft_5(<span class="dt">float2</span> t0, <span class="dt">float2</span> t1, <span class="dt">float2</span> t2, <span class="dt">float2</span> t3, <span class="dt">float2</span> t4,</span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true"></a>                 <span class="dt">float2</span> w0, <span class="dt">float2</span> w1, <span class="dt">float2</span> w2, <span class="dt">float2</span> w3,</span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true"></a>                 <span class="dt">float2</span>* x0, <span class="dt">float2</span>* x1, <span class="dt">float2</span> *x2, <span class="dt">float2</span>* x3, <span class="dt">float2</span> *x4) {</span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true"></a></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true"></a>    <span class="dt">const</span> <span class="dt">float</span> c1 = <span class="fl">0.25</span>;                  <span class="co">// 1/4</span></span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true"></a>    <span class="dt">const</span> <span class="dt">float</span> c2 = <span class="fl">0.5590169943749475</span>;      <span class="co">// sqrt(5)/4</span></span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true"></a>    <span class="dt">const</span> <span class="dt">float</span> c3 = <span class="fl">0.6180339887498949</span>;    <span class="co">// sqrt( (5-sqrt(5))/(5+sqrt(5)) )</span></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true"></a>    <span class="dt">const</span> <span class="dt">float</span> c4 = <span class="fl">0.9510565162951535</span>;    <span class="co">// 1/2 * np.sqrt(5/2 + np.sqrt(5)/2)</span></span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true"></a></span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true"></a>    <span class="dt">float2</span> z0, z1, z2;</span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true"></a>    <span class="dt">float2</span> s1, s2, s3, s4, s5, s6, s7, s8, s9, s10, s11;</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true"></a>    <span class="dt">float2</span> q1, q2;</span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true"></a></span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true"></a>    <span class="co">//z0 = t0</span></span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true"></a>    z0 = t0;</span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true"></a></span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true"></a>    <span class="co">//z1 = w0*t1</span></span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true"></a>    z1 = (<span class="dt">float2</span>) (w0.x * t1.x - w0.y * t1.y,</span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true"></a>                   w0.x * t1.y + w0.y * t1.x);</span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true"></a></span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true"></a>    <span class="co">//z2 = w1*t2</span></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true"></a>    z2 = (<span class="dt">float2</span>) (w1.x * t2.x - w1.y * t2.y,</span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true"></a>                   w1.x * t2.y + w1.y * t2.x);</span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true"></a></span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true"></a>    <span class="co">//s1 = z1 - w3*t4</span></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true"></a>    s1 = (<span class="dt">float2</span>) (z1.x - w3.x * t4.x + w3.y * t4.y,</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true"></a>                   z1.y - w3.x * t4.y - w3.y * t4.x);</span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true"></a></span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true"></a>    <span class="co">//s2 = 2*z1-s1</span></span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true"></a>    s2 = (<span class="dt">float2</span>) (<span class="dv">2</span>*z1.x - s1.x,</span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true"></a>                   <span class="dv">2</span>*z1.y - s1.y);</span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true"></a></span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true"></a>    <span class="co">//s3 = z2 - w2*t3</span></span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true"></a>    s3 = (<span class="dt">float2</span>) (z2.x - w2.x * t3.x + w2.y * t3.y,</span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true"></a>                   z2.y - w2.x * t3.y - w2.y * t3.x);</span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true"></a></span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true"></a>    <span class="co">//s4 = 2*z2 - s3</span></span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true"></a>    s4 = (<span class="dt">float2</span>) (<span class="dv">2</span>*z2.x - s3.x,</span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true"></a>                   <span class="dv">2</span>*z2.y - s3.y);</span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true"></a></span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true"></a>    <span class="co">//s5 = s2+s4</span></span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true"></a>    s5 = (<span class="dt">float2</span>) (s2.x + s4.x,</span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true"></a>                   s2.y + s4.y);</span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true"></a></span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true"></a>    <span class="co">//s6 = s2-s4</span></span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true"></a>    s6 = (<span class="dt">float2</span>) (s2.x - s4.x,</span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true"></a>                   s2.y - s4.y);</span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true"></a></span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true"></a>    <span class="co">//s7 = z0 - c1*s5</span></span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true"></a>    s7 = (<span class="dt">float2</span>) (z0.x - c1*s5.x,</span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true"></a>                   z0.y - c1*s5.y);</span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true"></a></span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true"></a>    <span class="co">//s8 = s7 - c2*s6</span></span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true"></a>    s8 = (<span class="dt">float2</span>) (s7.x - c2*s6.x,</span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true"></a>                   s7.y - c2*s6.y);</span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true"></a></span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true"></a>    <span class="co">//s9 = 2*s7 - s8</span></span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true"></a>    s9 = (<span class="dt">float2</span>) (<span class="dv">2</span>*s7.x - s8.x,</span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true"></a>                   <span class="dv">2</span>*s7.y - s8.y);</span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true"></a></span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true"></a>    <span class="co">//s10 = s1 + c3*s3</span></span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true"></a>    s10 = (<span class="dt">float2</span>) (s1.x + c3*s3.x,</span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true"></a>                    s1.y + c3*s3.y);</span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true"></a></span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true"></a>    <span class="co">//s11 = c3*s1 - s3</span></span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true"></a>    s11 = (<span class="dt">float2</span>) (c3*s1.x - s3.x,</span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true"></a>                    c3*s1.y - s3.y);</span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true"></a></span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true"></a>    <span class="co">// *x0 = z0 + s5</span></span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true"></a>    *x0 = (<span class="dt">float2</span>) (z0.x + s5.x,</span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true"></a>                    z0.y + s5.y);</span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true"></a></span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true"></a>    <span class="co">//q1 = s9 - i*c4*s10</span></span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true"></a>    q1 = (<span class="dt">float2</span>) (s9.x - c4*s10.y,</span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true"></a>                   s9.y + c4*s10.x);</span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true"></a></span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true"></a>    <span class="co">// *x1 = 2*s9 - q1</span></span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true"></a>    *x1 = (<span class="dt">float2</span>) (<span class="dv">2</span>*s9.x - q1.x,</span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true"></a>                    <span class="dv">2</span>*s9.y - q1.y);</span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true"></a></span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true"></a>    <span class="co">//q2 = s8 - i*c4*s11</span></span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true"></a>    q2 = (<span class="dt">float2</span>) (s8.x - c4*s11.y,</span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true"></a>                   s8.y + c4*s11.x);</span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true"></a></span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true"></a>    <span class="co">// *x2 = 2*s8-q2</span></span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true"></a>    *x2 = (<span class="dt">float2</span>) (<span class="dv">2</span>*s8.x - q2.x,</span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true"></a>                    <span class="dv">2</span>*s8.y - q2.y);</span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true"></a></span>
<span id="cb10-222"><a href="#cb10-222" aria-hidden="true"></a>    <span class="co">// *x3 = q2</span></span>
<span id="cb10-223"><a href="#cb10-223" aria-hidden="true"></a>    *x3 = q2;</span>
<span id="cb10-224"><a href="#cb10-224" aria-hidden="true"></a></span>
<span id="cb10-225"><a href="#cb10-225" aria-hidden="true"></a>    <span class="co">// *x4 = q1 </span></span>
<span id="cb10-226"><a href="#cb10-226" aria-hidden="true"></a>    *x4 = q1;</span>
<span id="cb10-227"><a href="#cb10-227" aria-hidden="true"></a></span>
<span id="cb10-228"><a href="#cb10-228" aria-hidden="true"></a>    <span class="kw">return</span> <span class="fl">0.0</span>;</span>
<span id="cb10-229"><a href="#cb10-229" aria-hidden="true"></a>}</span>
<span id="cb10-230"><a href="#cb10-230" aria-hidden="true"></a>{% endif %}</span>
<span id="cb10-231"><a href="#cb10-231" aria-hidden="true"></a></span>
<span id="cb10-232"><a href="#cb10-232" aria-hidden="true"></a>&lt;&lt;fma-codelet-tests&gt;&gt;</span></code></pre></div>
</div>
</div>
<h2 id="testing">Testing</h2>
<div class="fold-block">
<button class="btn btn-outline-primary btn-sm fold-toggle" type="button" data-toggle="collapse" data-target="#fma-codelet-tests-container" aria-controls="fma-codelet-tests-container">&lt;&lt;fma-codelet-tests&gt;&gt;=</button>
<div id="fma-codelet-tests-container" class="collapse">
<div class="sourceCode" id="fma-codelet-tests" style="max-height: 50vh"><pre class="sourceCode opencl bootstrap-fold overflow-auto"><code class="sourceCode opencl"><span id="fma-codelet-tests-1"><a href="#fma-codelet-tests-1" aria-hidden="true"></a><span class="ot">#ifdef TESTING</span></span>
<span id="fma-codelet-tests-2"><a href="#fma-codelet-tests-2" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-3"><a href="#fma-codelet-tests-3" aria-hidden="true"></a>{% <span class="kw">if</span> radix == <span class="dv">2</span> %}</span>
<span id="fma-codelet-tests-4"><a href="#fma-codelet-tests-4" aria-hidden="true"></a><span class="kw">__kernel</span> <span class="dt">void</span> test_radix_2(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</span>
<span id="fma-codelet-tests-5"><a href="#fma-codelet-tests-5" aria-hidden="true"></a>    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>) * <span class="dv">2</span>;</span>
<span id="fma-codelet-tests-6"><a href="#fma-codelet-tests-6" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-7"><a href="#fma-codelet-tests-7" aria-hidden="true"></a>    <span class="co">// n is the number of radix2 ffts to perform</span></span>
<span id="fma-codelet-tests-8"><a href="#fma-codelet-tests-8" aria-hidden="true"></a>    <span class="kw">if</span> (i &lt; <span class="dv">2</span> * n) {</span>
<span id="fma-codelet-tests-9"><a href="#fma-codelet-tests-9" aria-hidden="true"></a>        <span class="dt">float2</span> s0 = x[i];</span>
<span id="fma-codelet-tests-10"><a href="#fma-codelet-tests-10" aria-hidden="true"></a>        <span class="dt">float2</span> s1 = x[i + <span class="dv">1</span>];</span>
<span id="fma-codelet-tests-11"><a href="#fma-codelet-tests-11" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-12"><a href="#fma-codelet-tests-12" aria-hidden="true"></a>        fft_2(&amp;s0, &amp;s1, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>);</span>
<span id="fma-codelet-tests-13"><a href="#fma-codelet-tests-13" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-14"><a href="#fma-codelet-tests-14" aria-hidden="true"></a>        y[i] = s0; y[i + <span class="dv">1</span>] = s1;</span>
<span id="fma-codelet-tests-15"><a href="#fma-codelet-tests-15" aria-hidden="true"></a>    }</span>
<span id="fma-codelet-tests-16"><a href="#fma-codelet-tests-16" aria-hidden="true"></a>}</span>
<span id="fma-codelet-tests-17"><a href="#fma-codelet-tests-17" aria-hidden="true"></a>{% endif %}</span>
<span id="fma-codelet-tests-18"><a href="#fma-codelet-tests-18" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-19"><a href="#fma-codelet-tests-19" aria-hidden="true"></a>{% <span class="kw">if</span> radix == <span class="dv">3</span> %}</span>
<span id="fma-codelet-tests-20"><a href="#fma-codelet-tests-20" aria-hidden="true"></a><span class="kw">__kernel</span> <span class="dt">void</span> test_radix_3(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</span>
<span id="fma-codelet-tests-21"><a href="#fma-codelet-tests-21" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-22"><a href="#fma-codelet-tests-22" aria-hidden="true"></a>    <span class="dt">float2</span> w0 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-23"><a href="#fma-codelet-tests-23" aria-hidden="true"></a>    <span class="dt">float2</span> w1 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-24"><a href="#fma-codelet-tests-24" aria-hidden="true"></a>    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>)*<span class="dv">3</span>;</span>
<span id="fma-codelet-tests-25"><a href="#fma-codelet-tests-25" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-26"><a href="#fma-codelet-tests-26" aria-hidden="true"></a>    <span class="co">// n is the number of radix3 ffts to perform</span></span>
<span id="fma-codelet-tests-27"><a href="#fma-codelet-tests-27" aria-hidden="true"></a>    <span class="kw">if</span> (i&lt;<span class="dv">3</span>*n) {</span>
<span id="fma-codelet-tests-28"><a href="#fma-codelet-tests-28" aria-hidden="true"></a>        <span class="dt">float2</span> y0, y1, y2;</span>
<span id="fma-codelet-tests-29"><a href="#fma-codelet-tests-29" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-30"><a href="#fma-codelet-tests-30" aria-hidden="true"></a>        fft_3(x[i], x[i+<span class="dv">1</span>], x[i+<span class="dv">2</span>], w0, w1, &amp;y0, &amp;y1, &amp;y2);</span>
<span id="fma-codelet-tests-31"><a href="#fma-codelet-tests-31" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-32"><a href="#fma-codelet-tests-32" aria-hidden="true"></a>        y[i] = y0;    y[i+<span class="dv">1</span>] = y1;    y[i+<span class="dv">2</span>] = y2;</span>
<span id="fma-codelet-tests-33"><a href="#fma-codelet-tests-33" aria-hidden="true"></a>    }</span>
<span id="fma-codelet-tests-34"><a href="#fma-codelet-tests-34" aria-hidden="true"></a>}</span>
<span id="fma-codelet-tests-35"><a href="#fma-codelet-tests-35" aria-hidden="true"></a>{% endif %}</span>
<span id="fma-codelet-tests-36"><a href="#fma-codelet-tests-36" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-37"><a href="#fma-codelet-tests-37" aria-hidden="true"></a>{% <span class="kw">if</span> radix == <span class="dv">4</span> %}</span>
<span id="fma-codelet-tests-38"><a href="#fma-codelet-tests-38" aria-hidden="true"></a><span class="kw">__kernel</span> <span class="dt">void</span> test_radix_4(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</span>
<span id="fma-codelet-tests-39"><a href="#fma-codelet-tests-39" aria-hidden="true"></a>    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>) * <span class="dv">4</span>;</span>
<span id="fma-codelet-tests-40"><a href="#fma-codelet-tests-40" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-41"><a href="#fma-codelet-tests-41" aria-hidden="true"></a>    <span class="co">// n is the number of radix4 ffts to perform</span></span>
<span id="fma-codelet-tests-42"><a href="#fma-codelet-tests-42" aria-hidden="true"></a>    <span class="kw">if</span> (i &lt; <span class="dv">4</span> * n) {</span>
<span id="fma-codelet-tests-43"><a href="#fma-codelet-tests-43" aria-hidden="true"></a>        <span class="dt">float2</span> s0 = x[i];</span>
<span id="fma-codelet-tests-44"><a href="#fma-codelet-tests-44" aria-hidden="true"></a>        <span class="dt">float2</span> s1 = x[i + <span class="dv">1</span>];</span>
<span id="fma-codelet-tests-45"><a href="#fma-codelet-tests-45" aria-hidden="true"></a>        <span class="dt">float2</span> s2 = x[i + <span class="dv">2</span>];</span>
<span id="fma-codelet-tests-46"><a href="#fma-codelet-tests-46" aria-hidden="true"></a>        <span class="dt">float2</span> s3 = x[i + <span class="dv">3</span>];</span>
<span id="fma-codelet-tests-47"><a href="#fma-codelet-tests-47" aria-hidden="true"></a>        fft_4(&amp;s0, &amp;s1, &amp;s2, &amp;s3, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>);</span>
<span id="fma-codelet-tests-48"><a href="#fma-codelet-tests-48" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-49"><a href="#fma-codelet-tests-49" aria-hidden="true"></a>        y[i] = s0;    y[i + <span class="dv">1</span>] = s1;    y[i + <span class="dv">2</span>] = s2;    y[i + <span class="dv">3</span>] = s3;</span>
<span id="fma-codelet-tests-50"><a href="#fma-codelet-tests-50" aria-hidden="true"></a>    }</span>
<span id="fma-codelet-tests-51"><a href="#fma-codelet-tests-51" aria-hidden="true"></a>}</span>
<span id="fma-codelet-tests-52"><a href="#fma-codelet-tests-52" aria-hidden="true"></a>{% endif %}</span>
<span id="fma-codelet-tests-53"><a href="#fma-codelet-tests-53" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-54"><a href="#fma-codelet-tests-54" aria-hidden="true"></a>{% <span class="kw">if</span> radix == <span class="dv">5</span> %}</span>
<span id="fma-codelet-tests-55"><a href="#fma-codelet-tests-55" aria-hidden="true"></a><span class="kw">__kernel</span> <span class="dt">void</span> test_radix_5(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</span>
<span id="fma-codelet-tests-56"><a href="#fma-codelet-tests-56" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-57"><a href="#fma-codelet-tests-57" aria-hidden="true"></a>    <span class="dt">float2</span> w0 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-58"><a href="#fma-codelet-tests-58" aria-hidden="true"></a>    <span class="dt">float2</span> w1 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-59"><a href="#fma-codelet-tests-59" aria-hidden="true"></a>    <span class="dt">float2</span> w2 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-60"><a href="#fma-codelet-tests-60" aria-hidden="true"></a>    <span class="dt">float2</span> w3 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</span>
<span id="fma-codelet-tests-61"><a href="#fma-codelet-tests-61" aria-hidden="true"></a>    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>)*<span class="dv">5</span>;</span>
<span id="fma-codelet-tests-62"><a href="#fma-codelet-tests-62" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-63"><a href="#fma-codelet-tests-63" aria-hidden="true"></a>    <span class="co">// n is the number of radix5 ffts to perform</span></span>
<span id="fma-codelet-tests-64"><a href="#fma-codelet-tests-64" aria-hidden="true"></a>    <span class="kw">if</span> (i&lt;<span class="dv">5</span>*n) {</span>
<span id="fma-codelet-tests-65"><a href="#fma-codelet-tests-65" aria-hidden="true"></a>        <span class="dt">float2</span> y0, y1, y2, y3, y4;</span>
<span id="fma-codelet-tests-66"><a href="#fma-codelet-tests-66" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-67"><a href="#fma-codelet-tests-67" aria-hidden="true"></a>        fft_5(x[i], x[i+<span class="dv">1</span>], x[i+<span class="dv">2</span>], x[i+<span class="dv">3</span>], x[i+<span class="dv">4</span>], w0, w1, w2, w3, &amp;y0, &amp;y1, &amp;y2, &amp;y3, &amp;y4);</span>
<span id="fma-codelet-tests-68"><a href="#fma-codelet-tests-68" aria-hidden="true"></a></span>
<span id="fma-codelet-tests-69"><a href="#fma-codelet-tests-69" aria-hidden="true"></a>        y[i] = y0;    y[i+<span class="dv">1</span>] = y1;    y[i+<span class="dv">2</span>] = y2;    y[i+<span class="dv">3</span>] = y3;    y[i+<span class="dv">4</span>] = y4;</span>
<span id="fma-codelet-tests-70"><a href="#fma-codelet-tests-70" aria-hidden="true"></a>    }</span>
<span id="fma-codelet-tests-71"><a href="#fma-codelet-tests-71" aria-hidden="true"></a>}</span>
<span id="fma-codelet-tests-72"><a href="#fma-codelet-tests-72" aria-hidden="true"></a>{% endif %}</span>
<span id="fma-codelet-tests-73"><a href="#fma-codelet-tests-73" aria-hidden="true"></a><span class="ot">#endif </span><span class="co">// </span><span class="al">TESTING</span></span></code></pre></div>
</div>
</div>
<div class="annotated-code">
<p><span><em>«test/test_fma_codelets.py»=</em></span></p>
<div class="sourceCode" id="cb11" data-file="test/test_fma_codelets.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="im">import</span> numpy</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a><span class="im">import</span> pytest</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a><span class="im">from</span> fftsynth <span class="im">import</span> generator, parity</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a><span class="im">from</span> kernel_tuner <span class="im">import</span> run_kernel     <span class="co"># type: ignore</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a><span class="at">@pytest.mark.parametrize</span>(<span class="st">&#39;radix&#39;</span>, [<span class="dv">2</span>, <span class="dv">4</span>])</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a><span class="kw">def</span> test_radix(radix):</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a>    <span class="co"># this test runs 256 instances of the radix n function</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a>    <span class="co"># it does not use twiddle factors, so as a test</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a>    <span class="co"># it&#39;s not to be relied upon fully</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a>    n <span class="op">=</span> numpy.int32(<span class="dv">256</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true"></a>    x <span class="op">=</span> numpy.random.normal(size<span class="op">=</span>(n, radix, <span class="dv">2</span>)).astype(numpy.float32)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true"></a>    y <span class="op">=</span> numpy.zeros_like(x)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true"></a>    y_ref <span class="op">=</span> numpy.fft.fft(x[..., <span class="dv">0</span>]<span class="op">+</span><span class="ot">1j</span><span class="op">*</span>x[..., <span class="dv">1</span>])</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true"></a>    parity_splitting <span class="op">=</span> parity.ParitySplitting(radix <span class="op">*</span> n, radix)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true"></a>    codelets <span class="op">=</span> <span class="st">&quot;</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(generator.generate_preprocessor(parity_splitting, <span class="va">False</span>),</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true"></a>                                   generator.generate_fma_twiddle_array(parity_splitting),</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true"></a>                                   generator.generate_fma_codelets(parity_splitting, <span class="va">False</span>))</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true"></a>    args <span class="op">=</span> [x, y, n]</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true"></a>    answer <span class="op">=</span> run_kernel(<span class="ss">f&quot;test_radix_</span><span class="sc">{</span>radix<span class="sc">}</span><span class="ss">&quot;</span>, codelets, <span class="dv">1</span>, args, {}, compiler_options<span class="op">=</span>[<span class="st">&quot;-DTESTING&quot;</span>])</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true"></a>    y <span class="op">=</span> answer[<span class="dv">1</span>]</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true"></a>    y <span class="op">=</span> y[..., <span class="dv">0</span>] <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> y[..., <span class="dv">1</span>]</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true"></a>    numpy.testing.assert_almost_equal(y, y_ref, decimal<span class="op">=</span><span class="dv">5</span>)</span></code></pre></div>
</div>
<h1 id="code-generator">Code generator</h1>
<div class="annotated-code">
<p><span><em>«fftsynth/generator.py»=</em></span></p>
<div class="sourceCode" id="cb12" data-file="fftsynth/generator.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="im">from</span> jinja2 <span class="im">import</span> Environment, FileSystemLoader</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a><span class="im">import</span> numpy</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a><span class="im">from</span> pkg_resources <span class="im">import</span> resource_filename</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a><span class="im">from</span> math <span class="im">import</span> ceil</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a><span class="im">from</span> .parity <span class="im">import</span> ParitySplitting, comp_perm</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a><span class="im">from</span> .twiddle <span class="im">import</span> make_twiddle</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>template_loader <span class="op">=</span> FileSystemLoader(resource_filename(<span class="st">&quot;fftsynth&quot;</span>, <span class="st">&quot;templates&quot;</span>))</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a>template_environment <span class="op">=</span> Environment(loader<span class="op">=</span>template_loader)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a><span class="kw">def</span> get_n_twiddles(radix):</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Gives the width of the twiddle array as a function of radix.&quot;&quot;&quot;</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a>    <span class="cf">return</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>][radix]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>preprocessor<span class="op">&gt;&gt;</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>twiddle<span class="op">-</span>array<span class="op">&gt;&gt;</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>fpga<span class="op">-</span>functions<span class="op">&gt;&gt;</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>transpose<span class="op">-</span>function<span class="op">&gt;&gt;</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>parity<span class="op">-</span>function<span class="op">&gt;&gt;</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>ipow<span class="op">-</span>function<span class="op">&gt;&gt;</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>index<span class="op">-</span>functions<span class="op">&gt;&gt;</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>fft<span class="op">-</span>functions<span class="op">&gt;&gt;</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>codelets<span class="op">&gt;&gt;</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true"></a><span class="kw">def</span> generate_fft(parity_splitting: ParitySplitting, fpga: <span class="bu">bool</span>):</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true"></a><span class="co">    Generate the complete OpenCL FFT code.</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true"></a>    code <span class="op">=</span> <span class="st">&quot;</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(generate_preprocessor(parity_splitting, fpga),</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true"></a>                                                     generate_twiddle_array(parity_splitting),</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true"></a>                                                     generate_parity_function(parity_splitting),</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true"></a>                                                     generate_transpose_function(parity_splitting),</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true"></a>                                                     generate_ipow_function(parity_splitting),</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true"></a>                                                     generate_index_functions(parity_splitting),</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true"></a>                                                     generate_codelets(parity_splitting, fpga),</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true"></a>                                                     generate_fft_functions(parity_splitting, fpga))</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true"></a>    <span class="cf">if</span> fpga:</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true"></a>        code <span class="op">=</span> <span class="st">&quot;</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(code, generate_fpga_functions())</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true"></a>    <span class="cf">return</span> code</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true"></a></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true"></a></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true"></a><span class="kw">def</span> generate_fma_twiddle_array(parity_splitting: ParitySplitting):</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true"></a><span class="co">    Generate OpenCL constant array for twiddle factors</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true"></a>    template <span class="op">=</span> template_environment.get_template(<span class="st">&quot;fma-twiddles.cl&quot;</span>)</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true"></a>    twiddles <span class="op">=</span> numpy.ones(shape<span class="op">=</span>[parity_splitting.radix, parity_splitting.radix])</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true"></a>    perm <span class="op">=</span> numpy.array([comp_perm(parity_splitting.radix, i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(parity_splitting.M)])</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true"></a></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true"></a>    n <span class="op">=</span> parity_splitting.radix</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(parity_splitting.depth <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true"></a>        w <span class="op">=</span> make_twiddle(parity_splitting.radix, n).conj()</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true"></a>        w_r_x <span class="op">=</span> (numpy.ones(shape<span class="op">=</span>[parity_splitting.M <span class="op">//</span> n, parity_splitting.radix, n]) <span class="op">*</span> w) <span class="op">\</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true"></a>            .transpose([<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>]) <span class="op">\</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true"></a>            .reshape([<span class="op">-</span><span class="dv">1</span>, parity_splitting.radix])[perm]</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true"></a>        twiddles <span class="op">=</span> numpy.r_[twiddles, w_r_x]</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true"></a>        n <span class="op">*=</span> parity_splitting.radix</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true"></a></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true"></a>    <span class="cf">return</span> template.render(radix<span class="op">=</span>parity_splitting.radix,</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true"></a>                           n_twiddles<span class="op">=</span>get_n_twiddles(parity_splitting.radix),</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true"></a>                           W<span class="op">=</span>twiddles)</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true"></a></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true"></a></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true"></a><span class="kw">def</span> generate_fma_codelets(parity_splitting: ParitySplitting, fpga: <span class="bu">bool</span>):</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true"></a><span class="co">    Generate OpenCL codelets for FFT (FMA version).</span></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true"></a>    template <span class="op">=</span> template_environment.get_template(<span class="st">&quot;fma-codelets.cl&quot;</span>)</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true"></a></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true"></a>    <span class="cf">return</span> template.render(radix<span class="op">=</span>parity_splitting.radix, fpga<span class="op">=</span>fpga)</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true"></a></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true"></a></span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true"></a><span class="kw">def</span> generate_fma_fft_functions(parity_splitting: ParitySplitting, fpga: <span class="bu">bool</span>):</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true"></a><span class="co">    Generate outer loop for OpenCL FFT (FMA version).</span></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true"></a>    template <span class="op">=</span> template_environment.get_template(<span class="st">&quot;fma-fft.cl&quot;</span>)</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true"></a>    depth_type <span class="op">=</span> <span class="st">&quot;unsigned int&quot;</span></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true"></a>    m_type <span class="op">=</span> <span class="st">&quot;unsigned int&quot;</span></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true"></a>    n_type <span class="op">=</span> <span class="st">&quot;unsigned int&quot;</span></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true"></a>    <span class="cf">if</span> fpga:</span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true"></a>        depth_type <span class="op">=</span> <span class="st">&quot;uint</span><span class="sc">{}</span><span class="st">_t&quot;</span>.<span class="bu">format</span>(<span class="bu">int</span>(numpy.ceil(numpy.log2(parity_splitting.depth <span class="op">+</span> <span class="fl">0.5</span>))))</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true"></a>        m_type <span class="op">=</span> <span class="st">&quot;uint</span><span class="sc">{}</span><span class="st">_t&quot;</span>.<span class="bu">format</span>(<span class="bu">int</span>(numpy.ceil(numpy.log2(parity_splitting.M <span class="op">+</span> <span class="fl">0.5</span>))))</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true"></a>        n_type <span class="op">=</span> <span class="st">&quot;uint</span><span class="sc">{}</span><span class="st">_t&quot;</span>.<span class="bu">format</span>(<span class="bu">int</span>(numpy.ceil(numpy.log2(parity_splitting.N <span class="op">+</span> <span class="fl">0.5</span>))))</span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true"></a></span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true"></a>    <span class="cf">return</span> template.render(N<span class="op">=</span>parity_splitting.N,</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true"></a>                           depth<span class="op">=</span>parity_splitting.depth,</span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true"></a>                           radix<span class="op">=</span>parity_splitting.radix,</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true"></a>                           n_twiddles<span class="op">=</span>get_n_twiddles(parity_splitting.radix),</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true"></a>                           M<span class="op">=</span>parity_splitting.M,</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true"></a>                           fpga<span class="op">=</span>fpga,</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true"></a>                           depth_type<span class="op">=</span>depth_type,</span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true"></a>                           m_type<span class="op">=</span>m_type,</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true"></a>                           n_type<span class="op">=</span>n_type)</span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true"></a></span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true"></a></span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true"></a><span class="kw">def</span> generate_fma_fft(parity_splitting: ParitySplitting, fpga: <span class="bu">bool</span>):</span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true"></a><span class="co">    Generate the complete OpenCL FFT code (FMA version).</span></span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true"></a>    code <span class="op">=</span> <span class="st">&quot;</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(generate_preprocessor(parity_splitting, fpga),</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true"></a>                                                     generate_fma_twiddle_array(parity_splitting),</span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true"></a>                                                     generate_parity_function(parity_splitting),</span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true"></a>                                                     generate_transpose_function(parity_splitting),</span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true"></a>                                                     generate_ipow_function(parity_splitting),</span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true"></a>                                                     generate_index_functions(parity_splitting),</span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true"></a>                                                     generate_fma_codelets(parity_splitting, fpga),</span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true"></a>                                                     generate_fma_fft_functions(parity_splitting, fpga))</span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true"></a>    <span class="cf">if</span> fpga:</span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true"></a>        code <span class="op">=</span> <span class="st">&quot;</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(code, generate_fpga_functions())</span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true"></a>    <span class="cf">return</span> code</span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true"></a></span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true"></a></span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true"></a>    <span class="im">import</span> sys</span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true"></a>    <span class="im">import</span> argparse</span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">&quot;Generate an OpenCL FFT kernel&quot;</span>)</span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true"></a>    parser.add_argument(<span class="st">&quot;--radix&quot;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">4</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;FFT radix&quot;</span>)</span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true"></a>    parser.add_argument(<span class="st">&quot;--depth&quot;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">3</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;FFT depth&quot;</span>)</span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true"></a>    parser.add_argument(<span class="st">&quot;--fpga&quot;</span>, action<span class="op">=</span><span class="st">&quot;store_true&quot;</span>)</span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true"></a>    parser.add_argument(<span class="st">&quot;--fma&quot;</span>, action<span class="op">=</span><span class="st">&quot;store_true&quot;</span>)</span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;/* FFT&quot;</span>)</span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="ss">f&quot; * command: python -m fftsynth.generator </span><span class="sc">{</span><span class="st">&#39; &#39;</span><span class="sc">.</span>join(sys.argv[<span class="dv">1</span>:])<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot; */&quot;</span>)</span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true"></a>    N <span class="op">=</span> args.radix<span class="op">**</span>args.depth</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true"></a>    ps <span class="op">=</span> ParitySplitting(N, args.radix)</span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true"></a>    <span class="cf">if</span> args.fma:</span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true"></a>        <span class="bu">print</span>(generate_fma_fft(ps, args.fpga))</span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true"></a>    <span class="cf">else</span>:</span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true"></a>        <span class="bu">print</span>(generate_fft(ps, args.fpga))</span></code></pre></div>
</div>
<h3 id="codelets">Codelets</h3>
<p>These are the codelets for specific radix FFT.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/codelets.cl»=</em></span></p>
<div class="sourceCode" id="cb13" data-file="fftsynth/templates/codelets.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a>{% <span class="kw">if</span> radix == <span class="dv">2</span>%}</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a><span class="dt">void</span> fft_2(<span class="dt">float2</span> * <span class="dt">restrict</span> s0, <span class="dt">float2</span> * <span class="dt">restrict</span> s1,{% <span class="kw">if</span> fpga %} <span class="dt">float2</span> * <span class="dt">restrict</span> s0_in, <span class="dt">float2</span> * <span class="dt">restrict</span> s1_in, <span class="dt">float2</span> * <span class="dt">restrict</span> s0_out, <span class="dt">float2</span> * <span class="dt">restrict</span> s1_out, <span class="dt">bool</span> first_iteration, <span class="dt">bool</span> last_iteration,{% endif %} <span class="dt">int</span> cycle, <span class="dt">int</span> i0, <span class="dt">int</span> i1, <span class="dt">int</span> iw)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a>{</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a>    <span class="dt">float2</span> t0, t1, ws0, ws1;</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>    <span class="kw">__constant</span> <span class="dt">float2</span> *w = W[iw];</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga %}</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: SWAP(<span class="dt">int</span>, i0, i1); <span class="kw">break</span>;</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a>    }</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true"></a>    <span class="kw">if</span> ( first_iteration )</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true"></a>    {</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true"></a>        t0 = s0_in[i0]; t1 = s1_in[i1];</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true"></a>    }</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true"></a>    <span class="kw">else</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true"></a>    {</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true"></a>        t0 = s0[i0]; t1 = s1[i1];</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true"></a>    }</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: SWAP(<span class="dt">float2</span>, t0, t1); <span class="kw">break</span>;</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true"></a>    }</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true"></a>    {% <span class="kw">else</span> %}</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">0</span>: t0 = s0[i0]; t1 = s1[i1]; <span class="kw">break</span>;</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: t0 = s1[i0]; t1 = s0[i1]; <span class="kw">break</span>;</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true"></a>    }</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true"></a>    {% endif %}</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true"></a>    ws0 = t0;</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true"></a>    ws1 = (<span class="dt">float2</span>) (w[<span class="dv">0</span>].x * t1.x - w[<span class="dv">0</span>].y * t1.y,</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true"></a>                    w[<span class="dv">0</span>].x * t1.y + w[<span class="dv">0</span>].y * t1.x);</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true"></a>    t0 = ws0 + ws1;</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true"></a>    t1 = ws0 - ws1;</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga %}</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: SWAP(<span class="dt">float2</span>, t0, t1); <span class="kw">break</span>;</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true"></a>    }</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true"></a>    <span class="kw">if</span> ( last_iteration )</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true"></a>    {</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true"></a>        s0_out[i0] = t0; s1_out[i1] = t1;</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true"></a>    }</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true"></a>    <span class="kw">else</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true"></a>    {</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true"></a>        s0[i0] = t0; s1[i1] = t1;</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true"></a>    }</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true"></a>    {% <span class="kw">else</span> %}</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">0</span>: s0[i0] = t0; s1[i1] = t1; <span class="kw">break</span>;</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: s1[i0] = t0; s0[i1] = t1; <span class="kw">break</span>;</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true"></a>    }</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true"></a>    {% endif %}</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true"></a>}</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true"></a></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true"></a><span class="ot">#ifdef TESTING</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true"></a><span class="kw">__kernel</span> <span class="dt">void</span> test_radix_2(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true"></a>    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>) * <span class="dv">2</span>;</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true"></a></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true"></a>    <span class="co">//n is the number of radix2 ffts to perform</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true"></a>    <span class="kw">if</span> (i &lt; <span class="dv">2</span> * n) {</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true"></a>        <span class="dt">float2</span> s0 = x[i];</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true"></a>        <span class="dt">float2</span> s1 = x[i + <span class="dv">1</span>];</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true"></a></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true"></a>        fft_2(&amp;s0, &amp;s1, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>);</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true"></a></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true"></a>        y[i] = s0; y[i + <span class="dv">1</span>] = s1;</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true"></a>    }</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true"></a>}</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true"></a><span class="ot">#endif </span><span class="co">// </span><span class="al">TESTING</span></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true"></a></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true"></a>{% elif radix == <span class="dv">4</span> %}</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true"></a><span class="dt">void</span> fft_4(<span class="dt">float2</span> * <span class="dt">restrict</span> s0, <span class="dt">float2</span> * <span class="dt">restrict</span> s1, <span class="dt">float2</span> * <span class="dt">restrict</span> s2, <span class="dt">float2</span> * <span class="dt">restrict</span> s3,{% <span class="kw">if</span> fpga %} <span class="dt">float2</span> * <span class="dt">restrict</span> s0_in, <span class="dt">float2</span> * <span class="dt">restrict</span> s1_in, <span class="dt">float2</span> * <span class="dt">restrict</span> s2_in, <span class="dt">float2</span> * <span class="dt">restrict</span> s3_in, <span class="dt">float2</span> * <span class="dt">restrict</span> s0_out, <span class="dt">float2</span> * <span class="dt">restrict</span> s1_out, <span class="dt">float2</span> * <span class="dt">restrict</span> s2_out, <span class="dt">float2</span> * <span class="dt">restrict</span> s3_out, <span class="dt">bool</span> first_iteration, <span class="dt">bool</span> last_iteration,{% endif %} <span class="dt">int</span> cycle, <span class="dt">int</span> i0, <span class="dt">int</span> i1, <span class="dt">int</span> i2, <span class="dt">int</span> i3, <span class="dt">int</span> iw)</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true"></a>{</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true"></a>    <span class="dt">float2</span> t0, t1, t2, t3, ws0, ws1, ws2, ws3, a, b, c, d;</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true"></a>    <span class="kw">__constant</span> <span class="dt">float2</span> *w = W[iw];</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true"></a></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga %}</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: SWAP(<span class="dt">int</span>, i0, i1); SWAP(<span class="dt">int</span>, i2, i3); SWAP(<span class="dt">int</span>, i0, i2); <span class="kw">break</span>;</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">2</span>: SWAP(<span class="dt">int</span>, i0, i2); SWAP(<span class="dt">int</span>, i1, i3); <span class="kw">break</span>;</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">3</span>: SWAP(<span class="dt">int</span>, i0, i1); SWAP(<span class="dt">int</span>, i1, i3); SWAP(<span class="dt">int</span>, i1, i2); <span class="kw">break</span>;</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true"></a>    }</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true"></a>    <span class="kw">if</span> ( first_iteration )</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true"></a>    {</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true"></a>        t0 = s0_in[i0]; t1 = s1_in[i1]; t2 = s2_in[i2]; t3 = s3_in[i3];</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true"></a>    }</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true"></a>    <span class="kw">else</span></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true"></a>    {</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true"></a>        t0 = s0[i0]; t1 = s1[i1]; t2 = s2[i2]; t3 = s3[i3];</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true"></a>    }</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: SWAP(<span class="dt">float2</span>, t0, t1); SWAP(<span class="dt">float2</span>, t1, t2); SWAP(<span class="dt">float2</span>, t2, t3); <span class="kw">break</span>;</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">2</span>: SWAP(<span class="dt">float2</span>, t0, t2); SWAP(<span class="dt">float2</span>, t1, t3); <span class="kw">break</span>;</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">3</span>: SWAP(<span class="dt">float2</span>, t2, t3); SWAP(<span class="dt">float2</span>, t0, t1); SWAP(<span class="dt">float2</span>, t0, t2); <span class="kw">break</span>;</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true"></a>    }</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true"></a>    {% <span class="kw">else</span> %}</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">0</span>: t0 = s0[i0]; t1 = s1[i1]; t2 = s2[i2]; t3 = s3[i3]; <span class="kw">break</span>;</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: t0 = s1[i0]; t1 = s2[i1]; t2 = s3[i2]; t3 = s0[i3]; <span class="kw">break</span>;</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">2</span>: t0 = s2[i0]; t1 = s3[i1]; t2 = s0[i2]; t3 = s1[i3]; <span class="kw">break</span>;</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">3</span>: t0 = s3[i0]; t1 = s0[i1]; t2 = s1[i2]; t3 = s2[i3]; <span class="kw">break</span>;</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true"></a>    }</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true"></a>    {% endif %}</span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true"></a></span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true"></a>    ws0 = t0;</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true"></a>    ws1 = (<span class="dt">float2</span>) (w[<span class="dv">0</span>].x * t1.x - w[<span class="dv">0</span>].y * t1.y,</span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true"></a>                    w[<span class="dv">0</span>].x * t1.y + w[<span class="dv">0</span>].y * t1.x);</span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true"></a>    ws2 = (<span class="dt">float2</span>) (w[<span class="dv">1</span>].x * t2.x - w[<span class="dv">1</span>].y * t2.y,</span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true"></a>                    w[<span class="dv">1</span>].x * t2.y + w[<span class="dv">1</span>].y * t2.x);</span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true"></a>    ws3 = (<span class="dt">float2</span>) (w[<span class="dv">2</span>].x * t3.x - w[<span class="dv">2</span>].y * t3.y,</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true"></a>                    w[<span class="dv">2</span>].x * t3.y + w[<span class="dv">2</span>].y * t3.x);</span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true"></a></span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true"></a>    a = ws0 + ws2;</span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true"></a>    b = ws1 + ws3;</span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true"></a>    c = ws0 - ws2;</span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true"></a>    d = ws1 - ws3;</span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true"></a>    t0 = a + b;</span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true"></a>    t1 = (<span class="dt">float2</span>) (c.x + d.y, c.y - d.x);</span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true"></a>    t2 = a - b;</span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true"></a>    t3 = (<span class="dt">float2</span>) (c.x - d.y, c.y + d.x);</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true"></a></span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga %}</span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: SWAP(<span class="dt">float2</span>, t2, t3); SWAP(<span class="dt">float2</span>, t1, t2); SWAP(<span class="dt">float2</span>, t0, t1); <span class="kw">break</span>;</span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">2</span>: SWAP(<span class="dt">float2</span>, t1, t3); SWAP(<span class="dt">float2</span>, t0, t2); <span class="kw">break</span>;</span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">3</span>: SWAP(<span class="dt">float2</span>, t0, t2); SWAP(<span class="dt">float2</span>, t0, t1); SWAP(<span class="dt">float2</span>, t2, t3); <span class="kw">break</span>;</span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true"></a>    }</span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true"></a>    <span class="kw">if</span> ( last_iteration )</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true"></a>    {</span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true"></a>        s0_out[i0] = t0; s1_out[i1] = t1; s2_out[i2] = t2; s3_out[i3] = t3;</span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true"></a>    }</span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true"></a>    <span class="kw">else</span></span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true"></a>    {</span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true"></a>        s0[i0] = t0; s1[i1] = t1; s2[i2] = t2; s3[i3] = t3;</span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true"></a>    }</span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true"></a>    {% <span class="kw">else</span> %}</span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true"></a>    <span class="kw">switch</span> (cycle) {</span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">0</span>: s0[i0] = t0; s1[i1] = t1; s2[i2] = t2; s3[i3] = t3; <span class="kw">break</span>;</span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">1</span>: s1[i0] = t0; s2[i1] = t1; s3[i2] = t2; s0[i3] = t3; <span class="kw">break</span>;</span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">2</span>: s2[i0] = t0; s3[i1] = t1; s0[i2] = t2; s1[i3] = t3; <span class="kw">break</span>;</span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true"></a>        <span class="kw">case</span> <span class="dv">3</span>: s3[i0] = t0; s0[i1] = t1; s1[i2] = t2; s2[i3] = t3; <span class="kw">break</span>;</span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true"></a>    }</span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true"></a>    {% endif %}</span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true"></a>}</span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true"></a></span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true"></a><span class="ot">#ifdef TESTING</span></span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true"></a><span class="kw">__kernel</span> <span class="dt">void</span> test_radix_4(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true"></a>    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>) * <span class="dv">4</span>;</span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true"></a></span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true"></a>    <span class="co">//n is the number of radix4 ffts to perform</span></span>
<span id="cb13-152"><a href="#cb13-152" aria-hidden="true"></a>    <span class="kw">if</span> (i &lt; <span class="dv">4</span> * n) {</span>
<span id="cb13-153"><a href="#cb13-153" aria-hidden="true"></a>        <span class="dt">float2</span> s0 = x[i];</span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true"></a>        <span class="dt">float2</span> s1 = x[i + <span class="dv">1</span>];</span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true"></a>        <span class="dt">float2</span> s2 = x[i + <span class="dv">2</span>];</span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true"></a>        <span class="dt">float2</span> s3 = x[i + <span class="dv">3</span>];</span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true"></a>        fft_4(&amp;s0, &amp;s1, &amp;s2, &amp;s3, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>);</span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true"></a></span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true"></a>        y[i] = s0;    y[i + <span class="dv">1</span>] = s1;    y[i + <span class="dv">2</span>] = s2;    y[i + <span class="dv">3</span>] = s3;</span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true"></a>    }</span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true"></a>}</span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true"></a><span class="ot">#endif </span><span class="co">// </span><span class="al">TESTING</span></span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true"></a>{% endif %}</span></code></pre></div>
</div>
<p>What follows is the Python function used to generate the OpenCL code.</p>
<div class="annotated-code">
<p><span><em>«generate-codelets»=</em></span></p>
<div class="sourceCode" id="generate-codelets"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-codelets-1"><a href="#generate-codelets-1" aria-hidden="true"></a><span class="kw">def</span> generate_codelets(parity_splitting: ParitySplitting, fpga: <span class="bu">bool</span>):</span>
<span id="generate-codelets-2"><a href="#generate-codelets-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="generate-codelets-3"><a href="#generate-codelets-3" aria-hidden="true"></a><span class="co">    Generate OpenCL codelets for FFT.</span></span>
<span id="generate-codelets-4"><a href="#generate-codelets-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="generate-codelets-5"><a href="#generate-codelets-5" aria-hidden="true"></a>    template <span class="op">=</span> template_environment.get_template(<span class="st">&quot;codelets.cl&quot;</span>)</span>
<span id="generate-codelets-6"><a href="#generate-codelets-6" aria-hidden="true"></a></span>
<span id="generate-codelets-7"><a href="#generate-codelets-7" aria-hidden="true"></a>    <span class="cf">return</span> template.render(radix<span class="op">=</span>parity_splitting.radix, fpga<span class="op">=</span>fpga)</span></code></pre></div>
</div>
<p>Here we also have a test for the codelets.</p>
<div class="annotated-code">
<p><span><em>«test/test_codelets.py»=</em></span></p>
<div class="sourceCode" id="cb14" data-file="test/test_codelets.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="im">import</span> numpy</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a><span class="im">import</span> pytest</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a><span class="im">from</span> fftsynth <span class="im">import</span> generator, parity</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a><span class="im">from</span> kernel_tuner <span class="im">import</span> run_kernel     <span class="co"># type: ignore</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a><span class="at">@pytest.mark.parametrize</span>(<span class="st">&#39;radix&#39;</span>, [<span class="dv">2</span>, <span class="dv">4</span>])</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a><span class="kw">def</span> test_radix(radix):</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a>    <span class="co"># this test runs 256 instances of the radix n function</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a>    <span class="co"># it does not use twiddle factors, so as a test</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a>    <span class="co"># it&#39;s not to be relied upon fully</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true"></a>    n <span class="op">=</span> numpy.int32(<span class="dv">256</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true"></a>    x <span class="op">=</span> numpy.random.normal(size<span class="op">=</span>(n, radix, <span class="dv">2</span>)).astype(numpy.float32)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true"></a>    y <span class="op">=</span> numpy.zeros_like(x)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true"></a>    y_ref <span class="op">=</span> numpy.fft.fft(x[..., <span class="dv">0</span>]<span class="op">+</span><span class="ot">1j</span><span class="op">*</span>x[..., <span class="dv">1</span>])</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true"></a>    parity_splitting <span class="op">=</span> parity.ParitySplitting(radix <span class="op">*</span> n, radix)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true"></a>    codelets <span class="op">=</span> <span class="st">&quot;</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(generator.generate_preprocessor(parity_splitting, <span class="va">False</span>),</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true"></a>                                   generator.generate_twiddle_array(parity_splitting),</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true"></a>                                   generator.generate_codelets(parity_splitting, <span class="va">False</span>))</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true"></a>    args <span class="op">=</span> [x, y, n]</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true"></a>    answer <span class="op">=</span> run_kernel(<span class="ss">f&quot;test_radix_</span><span class="sc">{</span>radix<span class="sc">}</span><span class="ss">&quot;</span>, codelets, <span class="dv">1</span>, args, {}, compiler_options<span class="op">=</span>[<span class="st">&quot;-DTESTING&quot;</span>])</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true"></a>    y <span class="op">=</span> answer[<span class="dv">1</span>]</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true"></a>    y <span class="op">=</span> y[..., <span class="dv">0</span>] <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> y[..., <span class="dv">1</span>]</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true"></a>    numpy.testing.assert_almost_equal(y, y_ref, decimal<span class="op">=</span><span class="dv">5</span>)</span></code></pre></div>
</div>
<h3 id="preprocessor">Preprocessor</h3>
<p>This is the parameterized OpenCL code used to write the preprocessor directives.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/preprocessor.cl»=</em></span></p>
<div class="sourceCode" id="cb15" data-file="fftsynth/templates/preprocessor.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a>{% <span class="kw">if</span> fpga -%}</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a><span class="ot">#pragma OPENCL EXTENSION cl_intel_channels : enable</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a><span class="ot">#include &lt;ihc_apint.h&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a>channel <span class="dt">float2</span> in_channel, out_channel;</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a><span class="ot">#define SWAP(type, x, y) do { type temp = x; x = y, y = temp; } while ( false );</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a>{% endif -%}</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a>{%<span class="kw">if</span> radix == <span class="dv">2</span> %}</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true"></a><span class="ot">#define DIVR(x) ((x) &gt;&gt; 1)</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true"></a><span class="ot">#define MODR(x) ((x) &amp; 1)</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true"></a><span class="ot">#define MULR(x) ((x) &lt;&lt; 1)</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true"></a>{% elif radix == <span class="dv">4</span> %}</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true"></a><span class="ot">#define DIVR(x) ((x) &gt;&gt; 2)</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true"></a><span class="ot">#define MODR(x) ((x) &amp; 3)</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true"></a><span class="ot">#define MULR(x) ((x) &lt;&lt; 2)</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true"></a>{% <span class="kw">else</span> %}</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true"></a><span class="ot">#define DIVR(x) ((x) / {{ radix }})</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true"></a><span class="ot">#define MODR(x) ((x) % {{ radix }})</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true"></a><span class="ot">#define MULR(x) ((x) * {{ radix }})</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true"></a>{% endif %}</span></code></pre></div>
</div>
<p>What follows is the Python function used to generate the OpenCL code.</p>
<div class="annotated-code">
<p><span><em>«generate-preprocessor»=</em></span></p>
<div class="sourceCode" id="generate-preprocessor"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-preprocessor-1"><a href="#generate-preprocessor-1" aria-hidden="true"></a><span class="kw">def</span> generate_preprocessor(parity_splitting: ParitySplitting, fpga: <span class="bu">bool</span>):</span>
<span id="generate-preprocessor-2"><a href="#generate-preprocessor-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="generate-preprocessor-3"><a href="#generate-preprocessor-3" aria-hidden="true"></a><span class="co">    Generate the preprocessor directives necessary for the FFT.</span></span>
<span id="generate-preprocessor-4"><a href="#generate-preprocessor-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="generate-preprocessor-5"><a href="#generate-preprocessor-5" aria-hidden="true"></a>    template <span class="op">=</span> template_environment.get_template(<span class="st">&quot;preprocessor.cl&quot;</span>)</span>
<span id="generate-preprocessor-6"><a href="#generate-preprocessor-6" aria-hidden="true"></a></span>
<span id="generate-preprocessor-7"><a href="#generate-preprocessor-7" aria-hidden="true"></a>    <span class="cf">return</span> template.render(radix<span class="op">=</span>parity_splitting.radix, fpga<span class="op">=</span>fpga)</span></code></pre></div>
</div>
<h3 id="fpga-specific-code">FPGA specific code</h3>
<p>This is the parameterized OpenCL code used to write the FPGA specific functions.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/fpga.cl»=</em></span></p>
<div class="sourceCode" id="cb16" data-file="fftsynth/templates/fpga.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="kw">__kernel</span> __attribute__((max_global_work_dim(<span class="dv">0</span>)))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a><span class="dt">void</span> source(<span class="kw">__global</span> <span class="dt">const</span> <span class="dt">volatile</span> <span class="dt">float2</span> * in, <span class="dt">unsigned</span> count)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>{</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a>    <span class="ot">#pragma ii 1</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>    <span class="kw">for</span> ( <span class="dt">unsigned</span> i = <span class="dv">0</span>; i &lt; count; i++ )</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>    {</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a>        write_channel_intel(in_channel, in[i]);</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a>    }</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a>}</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a><span class="kw">__kernel</span> __attribute__((max_global_work_dim(<span class="dv">0</span>)))</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a><span class="dt">void</span> sink(<span class="kw">__global</span> <span class="dt">float2</span> *out, <span class="dt">unsigned</span> count)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a>{</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a>    <span class="ot">#pragma ii 1</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true"></a>    <span class="kw">for</span> ( <span class="dt">unsigned</span> i = <span class="dv">0</span>; i &lt; count; i++ )</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true"></a>    {</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true"></a>        out[i] = read_channel_intel(out_channel);</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true"></a>    }</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<p>What follows is the Python function used to generate the OpenCL code.</p>
<div class="annotated-code">
<p><span><em>«generate-fpga-functions»=</em></span></p>
<div class="sourceCode" id="generate-fpga-functions"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-fpga-functions-1"><a href="#generate-fpga-functions-1" aria-hidden="true"></a><span class="kw">def</span> generate_fpga_functions():</span>
<span id="generate-fpga-functions-2"><a href="#generate-fpga-functions-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="generate-fpga-functions-3"><a href="#generate-fpga-functions-3" aria-hidden="true"></a><span class="co">    Generate OpenCL code for FPGA functions.</span></span>
<span id="generate-fpga-functions-4"><a href="#generate-fpga-functions-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="generate-fpga-functions-5"><a href="#generate-fpga-functions-5" aria-hidden="true"></a>    template <span class="op">=</span> template_environment.get_template(<span class="st">&quot;fpga.cl&quot;</span>)</span>
<span id="generate-fpga-functions-6"><a href="#generate-fpga-functions-6" aria-hidden="true"></a></span>
<span id="generate-fpga-functions-7"><a href="#generate-fpga-functions-7" aria-hidden="true"></a>    <span class="cf">return</span> template.render()</span></code></pre></div>
</div>
<h2 id="testing-1">Testing</h2>
<p>To test we need to define small <code>__kernel</code> functions.</p>
<div class="annotated-code">
<p><span><em>«test/test_generator.py»=</em></span></p>
<div class="sourceCode" id="cb17" data-file="test/test_generator.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="im">import</span> pytest</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a><span class="im">from</span> kernel_tuner <span class="im">import</span> run_kernel  <span class="co"># type: ignore</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a><span class="im">from</span> fftsynth.parity <span class="im">import</span> ParitySplitting, parity</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a><span class="im">from</span> fftsynth.generator <span class="im">import</span> generate_preprocessor, generate_transpose_function, generate_parity_function, generate_fft, generate_fma_fft</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true"></a>cases <span class="op">=</span> [</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true"></a>    ParitySplitting(<span class="dv">128</span>, <span class="dv">2</span>),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true"></a>    ParitySplitting(<span class="dv">64</span>, <span class="dv">4</span>),</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true"></a>]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true"></a><span class="op">&lt;&lt;</span>test<span class="op">-</span>parity<span class="op">&gt;&gt;</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true"></a><span class="op">&lt;&lt;</span>test<span class="op">-</span>transpose<span class="op">&gt;&gt;</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true"></a><span class="op">&lt;&lt;</span>test<span class="op">-</span>fft<span class="op">&gt;&gt;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true"></a><span class="op">&lt;&lt;</span>test<span class="op">-</span>fft<span class="op">-</span>fma<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«test-fft»=</em></span></p>
<div class="sourceCode" id="test-fft"><pre class="sourceCode python"><code class="sourceCode python"><span id="test-fft-1"><a href="#test-fft-1" aria-hidden="true"></a><span class="at">@pytest.mark.parametrize</span>(<span class="st">&#39;parity_splitting&#39;</span>, cases)</span>
<span id="test-fft-2"><a href="#test-fft-2" aria-hidden="true"></a><span class="kw">def</span> test_fft(parity_splitting: ParitySplitting):</span>
<span id="test-fft-3"><a href="#test-fft-3" aria-hidden="true"></a>    kernel <span class="op">=</span> generate_fft(parity_splitting, <span class="va">False</span>)</span>
<span id="test-fft-4"><a href="#test-fft-4" aria-hidden="true"></a></span>
<span id="test-fft-5"><a href="#test-fft-5" aria-hidden="true"></a>    x <span class="op">=</span> np.random.normal(size<span class="op">=</span>(parity_splitting.N, <span class="dv">2</span>)).astype(np.float32)</span>
<span id="test-fft-6"><a href="#test-fft-6" aria-hidden="true"></a>    y <span class="op">=</span> np.zeros_like(x)</span>
<span id="test-fft-7"><a href="#test-fft-7" aria-hidden="true"></a></span>
<span id="test-fft-8"><a href="#test-fft-8" aria-hidden="true"></a>    results <span class="op">=</span> run_kernel(</span>
<span id="test-fft-9"><a href="#test-fft-9" aria-hidden="true"></a>        <span class="ss">f&quot;fft_</span><span class="sc">{</span>parity_splitting<span class="sc">.N}</span><span class="ss">&quot;</span>, kernel, parity_splitting.N, [x, y], {},</span>
<span id="test-fft-10"><a href="#test-fft-10" aria-hidden="true"></a>        compiler_options<span class="op">=</span>[<span class="st">&quot;-DTESTING&quot;</span>])</span>
<span id="test-fft-11"><a href="#test-fft-11" aria-hidden="true"></a>    y_ref <span class="op">=</span> np.fft.fft(x[:, <span class="dv">0</span>] <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> x[:, <span class="dv">1</span>])</span>
<span id="test-fft-12"><a href="#test-fft-12" aria-hidden="true"></a>    y <span class="op">=</span> results[<span class="dv">1</span>][:, <span class="dv">0</span>] <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> results[<span class="dv">1</span>][:, <span class="dv">1</span>]</span>
<span id="test-fft-13"><a href="#test-fft-13" aria-hidden="true"></a>    np.testing.assert_almost_equal(y, y_ref, decimal<span class="op">=</span><span class="dv">4</span>)</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«test-fft-fma»=</em></span></p>
<div class="sourceCode" id="test-fft-fma"><pre class="sourceCode python"><code class="sourceCode python"><span id="test-fft-fma-1"><a href="#test-fft-fma-1" aria-hidden="true"></a><span class="at">@pytest.mark.parametrize</span>(<span class="st">&#39;parity_splitting&#39;</span>, cases)</span>
<span id="test-fft-fma-2"><a href="#test-fft-fma-2" aria-hidden="true"></a><span class="kw">def</span> test_fft_fma(parity_splitting: ParitySplitting):</span>
<span id="test-fft-fma-3"><a href="#test-fft-fma-3" aria-hidden="true"></a>    kernel <span class="op">=</span> generate_fma_fft(parity_splitting, <span class="va">False</span>)</span>
<span id="test-fft-fma-4"><a href="#test-fft-fma-4" aria-hidden="true"></a></span>
<span id="test-fft-fma-5"><a href="#test-fft-fma-5" aria-hidden="true"></a>    x <span class="op">=</span> np.random.normal(size<span class="op">=</span>(parity_splitting.N, <span class="dv">2</span>)).astype(np.float32)</span>
<span id="test-fft-fma-6"><a href="#test-fft-fma-6" aria-hidden="true"></a>    y <span class="op">=</span> np.zeros_like(x)</span>
<span id="test-fft-fma-7"><a href="#test-fft-fma-7" aria-hidden="true"></a></span>
<span id="test-fft-fma-8"><a href="#test-fft-fma-8" aria-hidden="true"></a>    results <span class="op">=</span> run_kernel(</span>
<span id="test-fft-fma-9"><a href="#test-fft-fma-9" aria-hidden="true"></a>        <span class="ss">f&quot;fft_</span><span class="sc">{</span>parity_splitting<span class="sc">.N}</span><span class="ss">&quot;</span>, kernel, parity_splitting.N, [x, y], {},</span>
<span id="test-fft-fma-10"><a href="#test-fft-fma-10" aria-hidden="true"></a>        compiler_options<span class="op">=</span>[<span class="st">&quot;-DTESTING&quot;</span>])</span>
<span id="test-fft-fma-11"><a href="#test-fft-fma-11" aria-hidden="true"></a>    y_ref <span class="op">=</span> np.fft.fft(x[:, <span class="dv">0</span>] <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> x[:, <span class="dv">1</span>])</span>
<span id="test-fft-fma-12"><a href="#test-fft-fma-12" aria-hidden="true"></a>    y <span class="op">=</span> results[<span class="dv">1</span>][:, <span class="dv">0</span>] <span class="op">+</span> <span class="ot">1j</span> <span class="op">*</span> results[<span class="dv">1</span>][:, <span class="dv">1</span>]</span>
<span id="test-fft-fma-13"><a href="#test-fft-fma-13" aria-hidden="true"></a>    np.testing.assert_almost_equal(y, y_ref, decimal<span class="op">=</span><span class="dv">4</span>)</span></code></pre></div>
</div>
<h2 id="bit-math">Bit math</h2>
<p>The <code>transpose_{r}</code> function should reverse the digits in a base-n representation of the integer.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/transpose.cl»=</em></span></p>
<div class="sourceCode" id="cb18" data-file="fftsynth/templates/transpose.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="kw">inline</span> <span class="dt">int</span> transpose_{{ radix }}(<span class="dt">int</span> j)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>{</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a>    <span class="dt">int</span> x = <span class="dv">0</span>;</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a>    {% <span class="kw">for</span> item in range(depth) %}</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a>    x = MULR(x) + MODR(j);</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a>    j = DIVR(j);</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a>    {%- endfor %}</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a>    <span class="kw">return</span> x;</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«generate-transpose-function»=</em></span></p>
<div class="sourceCode" id="generate-transpose-function"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-transpose-function-1"><a href="#generate-transpose-function-1" aria-hidden="true"></a><span class="kw">def</span> generate_transpose_function(parity_splitting: ParitySplitting):</span>
<span id="generate-transpose-function-2"><a href="#generate-transpose-function-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="generate-transpose-function-3"><a href="#generate-transpose-function-3" aria-hidden="true"></a><span class="co">    Generate inline OpenCL function to reverse the digits in base-n representation.</span></span>
<span id="generate-transpose-function-4"><a href="#generate-transpose-function-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="generate-transpose-function-5"><a href="#generate-transpose-function-5" aria-hidden="true"></a>    template <span class="op">=</span> template_environment.get_template(<span class="st">&quot;transpose.cl&quot;</span>)</span>
<span id="generate-transpose-function-6"><a href="#generate-transpose-function-6" aria-hidden="true"></a></span>
<span id="generate-transpose-function-7"><a href="#generate-transpose-function-7" aria-hidden="true"></a>    <span class="cf">return</span> template.render(radix<span class="op">=</span>parity_splitting.radix,</span>
<span id="generate-transpose-function-8"><a href="#generate-transpose-function-8" aria-hidden="true"></a>                           depth<span class="op">=</span>parity_splitting.depth)</span></code></pre></div>
</div>
<p>The <code>parity_{r}</code> function should compute the parity of the index.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/parity.cl»=</em></span></p>
<div class="sourceCode" id="cb19" data-file="fftsynth/templates/parity.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="kw">inline</span> <span class="dt">int</span> parity_{{ radix }}(<span class="dt">int</span> i)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>{</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>    <span class="dt">int</span> x = MODR(i);</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>    {% <span class="kw">for</span> item in range(depth) %}</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a>    i = DIVR(i);</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a>    x += MODR(i);</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a>    {%- endfor %}</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true"></a>    <span class="kw">return</span> MODR(x);</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«generate-parity-function»=</em></span></p>
<div class="sourceCode" id="generate-parity-function"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-parity-function-1"><a href="#generate-parity-function-1" aria-hidden="true"></a><span class="kw">def</span> generate_parity_function(parity_splitting: ParitySplitting):</span>
<span id="generate-parity-function-2"><a href="#generate-parity-function-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="generate-parity-function-3"><a href="#generate-parity-function-3" aria-hidden="true"></a><span class="co">    Generate inline OpenCL function to compute the parity of the index.</span></span>
<span id="generate-parity-function-4"><a href="#generate-parity-function-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="generate-parity-function-5"><a href="#generate-parity-function-5" aria-hidden="true"></a>    template <span class="op">=</span> template_environment.get_template(<span class="st">&quot;parity.cl&quot;</span>)</span>
<span id="generate-parity-function-6"><a href="#generate-parity-function-6" aria-hidden="true"></a></span>
<span id="generate-parity-function-7"><a href="#generate-parity-function-7" aria-hidden="true"></a>    <span class="cf">return</span> template.render(radix<span class="op">=</span>parity_splitting.radix,</span>
<span id="generate-parity-function-8"><a href="#generate-parity-function-8" aria-hidden="true"></a>                           depth<span class="op">=</span>parity_splitting.depth)</span></code></pre></div>
</div>
<h3 id="testing-2">Testing</h3>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/transpose.cl»+</em></span></p>
<div class="sourceCode" id="cb20" data-file="fftsynth/templates/transpose.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="ot">#ifdef TESTING</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a><span class="kw">__kernel</span> <span class="dt">void</span> test_transpose_{{ radix }}(<span class="kw">__global</span> <span class="dt">const</span> <span class="dt">int</span> * x, <span class="kw">__global</span> <span class="dt">int</span> * y)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>{</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a>    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>);</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a>    </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a>    y[i] = transpose_{{ radix }}(x[i]);</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a>}</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a><span class="ot">#endif </span><span class="co">// </span><span class="al">TESTING</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«test-transpose»=</em></span></p>
<div class="sourceCode" id="test-transpose"><pre class="sourceCode python"><code class="sourceCode python"><span id="test-transpose-1"><a href="#test-transpose-1" aria-hidden="true"></a><span class="at">@pytest.mark.parametrize</span>(<span class="st">&#39;parity_splitting&#39;</span>, cases)</span>
<span id="test-transpose-2"><a href="#test-transpose-2" aria-hidden="true"></a><span class="kw">def</span> test_transpose(parity_splitting: ParitySplitting):</span>
<span id="test-transpose-3"><a href="#test-transpose-3" aria-hidden="true"></a>    kernel <span class="op">=</span> generate_preprocessor(parity_splitting, <span class="va">False</span>) <span class="op">+</span> generate_transpose_function(parity_splitting)</span>
<span id="test-transpose-4"><a href="#test-transpose-4" aria-hidden="true"></a>    x <span class="op">=</span> np.arange(parity_splitting.N, dtype<span class="op">=</span>np.int32)</span>
<span id="test-transpose-5"><a href="#test-transpose-5" aria-hidden="true"></a>    y <span class="op">=</span> np.zeros_like(x)</span>
<span id="test-transpose-6"><a href="#test-transpose-6" aria-hidden="true"></a>    kernel_args <span class="op">=</span> [x, y]</span>
<span id="test-transpose-7"><a href="#test-transpose-7" aria-hidden="true"></a></span>
<span id="test-transpose-8"><a href="#test-transpose-8" aria-hidden="true"></a>    results <span class="op">=</span> run_kernel(<span class="st">&quot;test_transpose_</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(parity_splitting.radix), kernel, parity_splitting.N, kernel_args, {}, compiler_options<span class="op">=</span>[<span class="st">&quot;-DTESTING&quot;</span>])</span>
<span id="test-transpose-9"><a href="#test-transpose-9" aria-hidden="true"></a>    y_ref <span class="op">=</span> x.reshape(parity_splitting.factors).T.flatten()</span>
<span id="test-transpose-10"><a href="#test-transpose-10" aria-hidden="true"></a></span>
<span id="test-transpose-11"><a href="#test-transpose-11" aria-hidden="true"></a>    <span class="cf">assert</span> np.<span class="bu">all</span>(results[<span class="dv">1</span>] <span class="op">==</span> y_ref)</span></code></pre></div>
</div>
<h4 id="parity-2">Parity</h4>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/parity.cl»+</em></span></p>
<div class="sourceCode" id="cb21" data-file="fftsynth/templates/parity.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="ot">#ifdef TESTING</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a><span class="kw">__kernel</span> <span class="dt">void</span> test_parity_{{ radix }}(<span class="kw">__global</span> <span class="dt">const</span> <span class="dt">int</span> * x, <span class="kw">__global</span> <span class="dt">int</span> * y)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a>{</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a>    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>);</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a>    </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a>    y[i] = parity_{{ radix }}(x[i]);</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a>}</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true"></a><span class="ot">#endif </span><span class="co">// </span><span class="al">TESTING</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«test-parity»=</em></span></p>
<div class="sourceCode" id="test-parity"><pre class="sourceCode python"><code class="sourceCode python"><span id="test-parity-1"><a href="#test-parity-1" aria-hidden="true"></a><span class="at">@pytest.mark.parametrize</span>(<span class="st">&quot;parity_splitting&quot;</span>, cases)</span>
<span id="test-parity-2"><a href="#test-parity-2" aria-hidden="true"></a><span class="kw">def</span> test_parity(parity_splitting: ParitySplitting):</span>
<span id="test-parity-3"><a href="#test-parity-3" aria-hidden="true"></a>    kernel <span class="op">=</span> generate_preprocessor(parity_splitting, <span class="va">False</span>) <span class="op">+</span> generate_parity_function(parity_splitting)</span>
<span id="test-parity-4"><a href="#test-parity-4" aria-hidden="true"></a>    x <span class="op">=</span> np.arange(parity_splitting.N, dtype<span class="op">=</span>np.int32)</span>
<span id="test-parity-5"><a href="#test-parity-5" aria-hidden="true"></a>    y <span class="op">=</span> np.zeros_like(x)</span>
<span id="test-parity-6"><a href="#test-parity-6" aria-hidden="true"></a>    kernel_args <span class="op">=</span> [x, y]</span>
<span id="test-parity-7"><a href="#test-parity-7" aria-hidden="true"></a></span>
<span id="test-parity-8"><a href="#test-parity-8" aria-hidden="true"></a>    results <span class="op">=</span> run_kernel(<span class="st">&quot;test_parity_</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(parity_splitting.radix), kernel, parity_splitting.N, kernel_args, {}, compiler_options<span class="op">=</span>[<span class="st">&quot;-DTESTING&quot;</span>])</span>
<span id="test-parity-9"><a href="#test-parity-9" aria-hidden="true"></a>    y_ref <span class="op">=</span> np.array([parity(parity_splitting.radix, i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(parity_splitting.N)])</span>
<span id="test-parity-10"><a href="#test-parity-10" aria-hidden="true"></a></span>
<span id="test-parity-11"><a href="#test-parity-11" aria-hidden="true"></a>    <span class="cf">assert</span> np.<span class="bu">all</span>(results[<span class="dv">1</span>] <span class="op">==</span> y_ref)</span></code></pre></div>
</div>
<h2 id="fft-kernel">FFT kernel</h2>
<div class="annotated-code">
<p><span><em>«generate-fft-functions»=</em></span></p>
<div class="sourceCode" id="generate-fft-functions"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-fft-functions-1"><a href="#generate-fft-functions-1" aria-hidden="true"></a><span class="kw">def</span> generate_fft_functions(parity_splitting: ParitySplitting, fpga: <span class="bu">bool</span>):</span>
<span id="generate-fft-functions-2"><a href="#generate-fft-functions-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="generate-fft-functions-3"><a href="#generate-fft-functions-3" aria-hidden="true"></a><span class="co">    Generate outer and inner loop for OpenCL FFT.</span></span>
<span id="generate-fft-functions-4"><a href="#generate-fft-functions-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="generate-fft-functions-5"><a href="#generate-fft-functions-5" aria-hidden="true"></a>    template <span class="op">=</span> template_environment.get_template(<span class="st">&quot;fft.cl&quot;</span>)</span>
<span id="generate-fft-functions-6"><a href="#generate-fft-functions-6" aria-hidden="true"></a>    depth_type <span class="op">=</span> <span class="st">&quot;unsigned int&quot;</span></span>
<span id="generate-fft-functions-7"><a href="#generate-fft-functions-7" aria-hidden="true"></a>    m_type <span class="op">=</span> <span class="st">&quot;unsigned int&quot;</span></span>
<span id="generate-fft-functions-8"><a href="#generate-fft-functions-8" aria-hidden="true"></a>    n_type <span class="op">=</span> <span class="st">&quot;unsigned int&quot;</span></span>
<span id="generate-fft-functions-9"><a href="#generate-fft-functions-9" aria-hidden="true"></a>    <span class="cf">if</span> fpga:</span>
<span id="generate-fft-functions-10"><a href="#generate-fft-functions-10" aria-hidden="true"></a>        depth_type <span class="op">=</span> <span class="st">&quot;uint</span><span class="sc">{}</span><span class="st">_t&quot;</span>.<span class="bu">format</span>(<span class="bu">int</span>(numpy.ceil(numpy.log2(parity_splitting.depth <span class="op">+</span> <span class="fl">0.5</span>))))</span>
<span id="generate-fft-functions-11"><a href="#generate-fft-functions-11" aria-hidden="true"></a>        m_type <span class="op">=</span> <span class="st">&quot;uint</span><span class="sc">{}</span><span class="st">_t&quot;</span>.<span class="bu">format</span>(<span class="bu">int</span>(numpy.ceil(numpy.log2(parity_splitting.M <span class="op">+</span> <span class="fl">0.5</span>))))</span>
<span id="generate-fft-functions-12"><a href="#generate-fft-functions-12" aria-hidden="true"></a>        n_type <span class="op">=</span> <span class="st">&quot;uint</span><span class="sc">{}</span><span class="st">_t&quot;</span>.<span class="bu">format</span>(<span class="bu">int</span>(numpy.ceil(numpy.log2(parity_splitting.N <span class="op">+</span> <span class="fl">0.5</span>))))</span>
<span id="generate-fft-functions-13"><a href="#generate-fft-functions-13" aria-hidden="true"></a></span>
<span id="generate-fft-functions-14"><a href="#generate-fft-functions-14" aria-hidden="true"></a>    <span class="cf">return</span> template.render(N<span class="op">=</span>parity_splitting.N,</span>
<span id="generate-fft-functions-15"><a href="#generate-fft-functions-15" aria-hidden="true"></a>                           depth<span class="op">=</span>parity_splitting.depth,</span>
<span id="generate-fft-functions-16"><a href="#generate-fft-functions-16" aria-hidden="true"></a>                           radix<span class="op">=</span>parity_splitting.radix,</span>
<span id="generate-fft-functions-17"><a href="#generate-fft-functions-17" aria-hidden="true"></a>                           M<span class="op">=</span>parity_splitting.M,</span>
<span id="generate-fft-functions-18"><a href="#generate-fft-functions-18" aria-hidden="true"></a>                           fpga<span class="op">=</span>fpga,</span>
<span id="generate-fft-functions-19"><a href="#generate-fft-functions-19" aria-hidden="true"></a>                           depth_type<span class="op">=</span>depth_type,</span>
<span id="generate-fft-functions-20"><a href="#generate-fft-functions-20" aria-hidden="true"></a>                           m_type<span class="op">=</span>m_type,</span>
<span id="generate-fft-functions-21"><a href="#generate-fft-functions-21" aria-hidden="true"></a>                           n_type<span class="op">=</span>n_type)</span></code></pre></div>
</div>
<h3 id="inner-loop">Inner loop</h3>
<p>Here we have <code>k</code> being the index of the outer loop. The next bit is only implemented for radix-2 and radix-4.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/fft.cl»=</em></span></p>
<div class="sourceCode" id="cb22" data-file="fftsynth/templates/fft.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="dt">void</span> fft_{{ N }}_ps({% <span class="kw">for</span> i in range(radix) %} <span class="dt">float2</span> * <span class="dt">restrict</span> s{{ i }}{%- <span class="kw">if</span> not loop.last %},{% endif %}{% endfor %}{% <span class="kw">if</span> fpga %},{% <span class="kw">for</span> i in range(radix) %} <span class="dt">float2</span> * <span class="dt">restrict</span> s{{ i }}_in,{% endfor %}{% <span class="kw">for</span> i in range(radix) %} <span class="dt">float2</span> * <span class="dt">restrict</span> s{{ i }}_out{%- <span class="kw">if</span> not loop.last %},{% endif %}{% endfor %}{% endif %})</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a>{</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a>    <span class="dt">int</span> wp = <span class="dv">0</span>;</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true"></a>    <span class="kw">for</span> ( {{ depth_type }} k = <span class="dv">0</span>; k != {{ depth }}; ++k )</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true"></a>    {</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true"></a>        <span class="dt">int</span> j = (k == <span class="dv">0</span> ? <span class="dv">0</span> : ipow(k - <span class="dv">1</span>));</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true"></a>        {% <span class="kw">if</span> fpga -%}</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true"></a>        <span class="ot">#pragma ivdep</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true"></a>        {% endif -%}</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true"></a>        <span class="kw">for</span> ( {{ m_type }} i = <span class="dv">0</span>; i != {{ M }}; ++i )</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true"></a>        {</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true"></a>            <span class="dt">int</span> a;</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true"></a>            <span class="kw">if</span> ( k != <span class="dv">0</span> )</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true"></a>            {</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true"></a>                a = comp_idx_{{ radix }}(DIVR(i), k<span class="dv">-1</span>);</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true"></a>            }</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true"></a>            <span class="kw">else</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true"></a>            {</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true"></a>                a = comp_perm_{{ radix }}(DIVR(i), MODR(i));</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true"></a>            }</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true"></a>            {% <span class="kw">if</span> fpga %}</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true"></a>            fft_{{ radix }}({% <span class="kw">for</span> i in range(radix) %} s{{ i }},{% endfor %}{% <span class="kw">for</span> i in range(radix) %} s{{ i }}_in,{% endfor %}{% <span class="kw">for</span> i in range(radix) %} s{{ i }}_out,{% endfor %} k == <span class="dv">0</span>, k == {{ depth - <span class="dv">1</span> }}, MODR(i), {% <span class="kw">for</span> i in range(radix) %} a + {{ i }} * j,{% endfor %} wp);</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true"></a>            {% <span class="kw">else</span> %}</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true"></a>            fft_{{ radix }}({% <span class="kw">for</span> i in range(radix) %} s{{ i }},{% endfor %} MODR(i), {% <span class="kw">for</span> i in range(radix) %} a + {{ i }} * j,{% endfor %} wp);</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true"></a>            {% endif %}</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true"></a>            <span class="kw">if</span> ( k != <span class="dv">0</span> )</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true"></a>            {</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true"></a>                ++wp;</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true"></a>            }</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true"></a>        }</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true"></a>    }</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<p>FMA version.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/fma-fft.cl»=</em></span></p>
<div class="sourceCode" id="cb23" data-file="fftsynth/templates/fma-fft.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="dt">void</span> fft_{{ N }}_ps({% <span class="kw">for</span> i in range(radix) %} <span class="dt">float2</span> * <span class="dt">restrict</span> s{{ i }}{%- <span class="kw">if</span> not loop.last %},{% endif %}{% endfor %}{% <span class="kw">if</span> fpga %},{% <span class="kw">for</span> i in range(radix) %} <span class="dt">float2</span> * <span class="dt">restrict</span> s{{ i }}_in,{% endfor %}{% <span class="kw">for</span> i in range(radix) %} <span class="dt">float2</span> * <span class="dt">restrict</span> s{{ i }}_out{%- <span class="kw">if</span> not loop.last %},{% endif %}{% endfor %}{% endif %})</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a>{</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a>    <span class="dt">int</span> wp = <span class="dv">0</span>;</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true"></a>    <span class="kw">for</span> ( {{ depth_type }} k = <span class="dv">0</span>; k != {{ depth }}; ++k )</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true"></a>    {</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true"></a>        <span class="dt">int</span> j = (k == <span class="dv">0</span> ? <span class="dv">0</span> : ipow(k - <span class="dv">1</span>));</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true"></a>        {% <span class="kw">if</span> fpga -%}</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true"></a>        <span class="ot">#pragma ivdep</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true"></a>        {% endif -%}</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true"></a>        <span class="kw">for</span> ( {{ m_type }} i = <span class="dv">0</span>; i != {{ M }}; ++i )</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true"></a>        {</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true"></a>            <span class="dt">int</span> a;</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true"></a>            <span class="kw">if</span> ( k != <span class="dv">0</span> )</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true"></a>            {</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true"></a>                a = comp_idx_{{ radix }}(DIVR(i), k<span class="dv">-1</span>);</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true"></a>            }</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true"></a>            <span class="kw">else</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true"></a>            {</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true"></a>                a = comp_perm_{{ radix }}(DIVR(i), MODR(i));</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true"></a>            }</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true"></a>            {% <span class="kw">if</span> fpga %}</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true"></a>            fft_{{ radix }}({% <span class="kw">for</span> i in range(radix) %} s{{ i }},{% endfor %}{% <span class="kw">for</span> i in range(radix) %} s{{ i }}_in,{% endfor %}{% <span class="kw">for</span> i in range(radix) %} s{{ i }}_out,{% endfor %} k == <span class="dv">0</span>, k == {{ depth - <span class="dv">1</span> }}, MODR(i), {% <span class="kw">for</span> i in range(radix) %} a + {{ i }} * j,{% endfor %} wp);</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true"></a>            {% <span class="kw">else</span> %}</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true"></a>            fft_{{ radix }}({% <span class="kw">for</span> i in range(radix) %} s{{ i }},{% endfor %} MODR(i), {% <span class="kw">for</span> i in range(radix) %} a + {{ i }} * j,{% endfor %} wp);</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true"></a>            {% endif %}</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true"></a>            <span class="kw">if</span> ( k != <span class="dv">0</span> )</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true"></a>            {</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true"></a>                ++wp;</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true"></a>            }</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true"></a>        }</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true"></a>    }</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<h3 id="outer-loop">Outer loop</h3>
<p>The outer kernel reads the data, puts it in the correct parity-channel and then calls the respective <code>fft_{n}_ps</code> kernel.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/fft.cl»+</em></span></p>
<div class="sourceCode" id="cb24" data-file="fftsynth/templates/fft.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a><span class="kw">__kernel</span> {%<span class="kw">if</span> fpga %}__attribute__((autorun)) __attribute__((max_global_work_dim(<span class="dv">0</span>))){% endif %}</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a><span class="dt">void</span> fft_{{ N }}({% <span class="kw">if</span> not fpga %}<span class="kw">__global</span> <span class="dt">const</span> <span class="dt">float2</span> * <span class="dt">restrict</span> x, <span class="kw">__global</span> <span class="dt">float2</span> * <span class="dt">restrict</span> y{% endif %})</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a>{</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga -%}</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a>    <span class="kw">while</span> ( true )</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true"></a>    {</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true"></a>    {% endif -%}</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true"></a>    {%- <span class="kw">for</span> i in range(radix) %}</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true"></a>    <span class="dt">float2</span> s{{ i }}[{{ M }}];</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga -%}</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true"></a>    <span class="dt">float2</span> s{{ i }}_in[{{ M }}], s{{ i }}_out[{{ M }}];</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true"></a>    {%- endif -%}</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true"></a>    {%- endfor %}</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true"></a>    <span class="kw">for</span> ( {{ n_type }} j = <span class="dv">0</span>; j != {{ N }}; ++j )</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true"></a>    {</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true"></a>        <span class="dt">int</span> i = transpose_{{ radix }}(j);</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true"></a>        <span class="dt">int</span> p = parity_{{ radix }}(i);</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true"></a>        {% <span class="kw">if</span> fpga -%}</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true"></a>        <span class="dt">float2</span> x = read_channel_intel(in_channel);</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true"></a>        {% endif -%}</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true"></a>        <span class="kw">switch</span> ( p )</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true"></a>        {</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true"></a>            {%- <span class="kw">if</span> fpga %}</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true"></a>            {%- <span class="kw">for</span> p in range(radix) %}</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true"></a>            <span class="kw">case</span> {{ p }}: s{{ p }}_in[DIVR(i)] = x; <span class="kw">break</span>;</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true"></a>            {%- endfor -%}</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true"></a>            {% <span class="kw">else</span> %}</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true"></a>            {%- <span class="kw">for</span> p in range(radix) %}</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true"></a>            <span class="kw">case</span> {{ p }}: s{{ p }}[DIVR(i)] = x[j]; <span class="kw">break</span>;</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true"></a>            {%- endfor -%}</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true"></a>            {%- endif %}</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true"></a>        }</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true"></a>    }</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true"></a></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga %}</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true"></a>    fft_{{ N }}_ps({%- <span class="kw">for</span> i in range(radix) %} s{{ i }},{% endfor %} {%- <span class="kw">for</span> i in range(radix) %} s{{ i }}_in,{% endfor %} {%- <span class="kw">for</span> i in range(radix) %} s{{ i }}_out{%- <span class="kw">if</span> not loop.last %},{% endif %}{% endfor %});</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true"></a>    {% <span class="kw">else</span> %}</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true"></a>    fft_{{ N }}_ps({%- <span class="kw">for</span> i in range(radix) %} s{{ i }}{%- <span class="kw">if</span> not loop.last %},{% endif %}{% endfor %});</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true"></a>    {% endif %}</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true"></a>    <span class="kw">for</span> ( {{ n_type }} i = <span class="dv">0</span>; i != {{ N }}; ++i )</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true"></a>    {</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true"></a>        <span class="dt">int</span> p = parity_{{ radix }}(i);</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true"></a>        {% <span class="kw">if</span> fpga -%}</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true"></a>        <span class="dt">float2</span> y;</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true"></a>        {% endif -%}</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true"></a></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true"></a>        <span class="kw">switch</span> ( p )</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true"></a>        {</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true"></a>            {%- <span class="kw">if</span> fpga -%}</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true"></a>            {%- <span class="kw">for</span> p in range(radix) %}</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true"></a>            <span class="kw">case</span> {{ p }}: y = s{{ p }}_out[DIVR(i)]; <span class="kw">break</span>;</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true"></a>            {%- endfor -%}</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true"></a>            {% <span class="kw">else</span> %}</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true"></a>            {%- <span class="kw">for</span> p in range(radix) %}</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true"></a>            <span class="kw">case</span> {{ p }}: y[i] = s{{ p }}[DIVR(i)]; <span class="kw">break</span>;</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true"></a>            {%- endfor -%}</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true"></a>            {%- endif %}</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true"></a>        }</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true"></a>        {%- <span class="kw">if</span> fpga %}</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true"></a>        write_channel_intel(out_channel, y);</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true"></a>        {%- endif %}</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true"></a>    }</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true"></a>    {%- <span class="kw">if</span> fpga %}</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true"></a>    }</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true"></a>    {%- endif %}</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<p>FMA version.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/fma-fft.cl»+</em></span></p>
<div class="sourceCode" id="cb25" data-file="fftsynth/templates/fma-fft.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="kw">__kernel</span> {%<span class="kw">if</span> fpga %}__attribute__((autorun)) __attribute__((max_global_work_dim(<span class="dv">0</span>))){% endif %}</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a><span class="dt">void</span> fft_{{ N }}({% <span class="kw">if</span> not fpga %}<span class="kw">__global</span> <span class="dt">const</span> <span class="dt">float2</span> * <span class="dt">restrict</span> x, <span class="kw">__global</span> <span class="dt">float2</span> * <span class="dt">restrict</span> y{% endif %})</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a>{</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga -%}</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a>    <span class="kw">while</span> ( true )</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true"></a>    {</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true"></a>    {% endif -%}</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true"></a>    {%- <span class="kw">for</span> i in range(radix) %}</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true"></a>    <span class="dt">float2</span> s{{ i }}[{{ M }}];</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga -%}</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true"></a>    <span class="dt">float2</span> s{{ i }}_in[{{ M }}], s{{ i }}_out[{{ M }}];</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true"></a>    {%- endif -%}</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true"></a>    {%- endfor %}</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true"></a>    <span class="kw">for</span> ( {{ n_type }} j = <span class="dv">0</span>; j != {{ N }}; ++j )</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true"></a>    {</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true"></a>        <span class="dt">int</span> i = transpose_{{ radix }}(j);</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true"></a>        <span class="dt">int</span> p = parity_{{ radix }}(i);</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true"></a>        {% <span class="kw">if</span> fpga -%}</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true"></a>        <span class="dt">float2</span> x = read_channel_intel(in_channel);</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true"></a>        {% endif -%}</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true"></a>        <span class="kw">switch</span> ( p )</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true"></a>        {</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true"></a>            {%- <span class="kw">if</span> fpga %}</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true"></a>            {%- <span class="kw">for</span> p in range(radix) %}</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true"></a>            <span class="kw">case</span> {{ p }}: s{{ p }}_in[DIVR(i)] = x; <span class="kw">break</span>;</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true"></a>            {%- endfor -%}</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true"></a>            {% <span class="kw">else</span> %}</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true"></a>            {%- <span class="kw">for</span> p in range(radix) %}</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true"></a>            <span class="kw">case</span> {{ p }}: s{{ p }}[DIVR(i)] = x[j]; <span class="kw">break</span>;</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true"></a>            {%- endfor -%}</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true"></a>            {%- endif %}</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true"></a>        }</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true"></a>    }</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true"></a>    {% <span class="kw">if</span> fpga %}</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true"></a>    fft_{{ N }}_ps({%- <span class="kw">for</span> i in range(radix) %} s{{ i }},{% endfor %} {%- <span class="kw">for</span> i in range(radix) %} s{{ i }}_in,{% endfor %} {%- <span class="kw">for</span> i in range(radix) %} s{{ i }}_out{%- <span class="kw">if</span> not loop.last %},{% endif %}{% endfor %});</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true"></a>    {% <span class="kw">else</span> %}</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true"></a>    fft_{{ N }}_ps({%- <span class="kw">for</span> i in range(radix) %} s{{ i }}{%- <span class="kw">if</span> not loop.last %},{% endif %}{% endfor %});</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true"></a>    {% endif %}</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true"></a></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true"></a>    <span class="kw">for</span> ( {{ n_type }} i = <span class="dv">0</span>; i != {{ N }}; ++i )</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true"></a>    {</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true"></a>        <span class="dt">int</span> p = parity_{{ radix }}(i);</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true"></a>        {% <span class="kw">if</span> fpga -%}</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true"></a>        <span class="dt">float2</span> y;</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true"></a>        {% endif -%}</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true"></a>        </span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true"></a>        <span class="kw">switch</span> ( p )</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true"></a>        {</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true"></a>            {%- <span class="kw">if</span> fpga -%}</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true"></a>            {%- <span class="kw">for</span> p in range(radix) %}</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true"></a>            <span class="kw">case</span> {{ p }}: y = s{{ p }}_out[DIVR(i)]; <span class="kw">break</span>;</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true"></a>            {%- endfor -%}</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true"></a>            {% <span class="kw">else</span> %}</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true"></a>            {%- <span class="kw">for</span> p in range(radix) %}</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true"></a>            <span class="kw">case</span> {{ p }}: y[i] = s{{ p }}[DIVR(i)]; <span class="kw">break</span>;</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true"></a>            {%- endfor -%}</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true"></a>            {%- endif %}</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true"></a>        }</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true"></a>        {%- <span class="kw">if</span> fpga %}</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true"></a>        write_channel_intel(out_channel, y);</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true"></a>        {%- endif %}</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true"></a>    }</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true"></a>    {%- <span class="kw">if</span> fpga %}</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true"></a>    }</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true"></a>    {%- endif %}</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<h2 id="twiddles-1">Twiddles</h2>
<p>This is the parameterized OpenCL code containing the constant array of the twiddle factors.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/twiddles.cl»=</em></span></p>
<div class="sourceCode" id="cb26" data-file="fftsynth/templates/twiddles.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a><span class="kw">__constant</span> <span class="dt">float2</span> W[{{ W.shape[<span class="dv">0</span>] - radix }}][{{ radix - <span class="dv">1</span> }}] = {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a>{% <span class="kw">for</span> ws in W[radix:] %}</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a>{ {% <span class="kw">for</span> w in ws[<span class="dv">1</span>:] -%}</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a>(<span class="dt">float2</span>)({{ <span class="st">&quot;%0.6f&quot;</span> | format(w.real) }}f, {{ <span class="st">&quot;%0.6f&quot;</span> | format(w.imag) }}f) {%- <span class="kw">if</span> not loop.last %}, {% endif %}</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true"></a>{%- endfor %} } {%- <span class="kw">if</span> not loop.last %},{% endif %}</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true"></a>{%- endfor %}</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true"></a>};</span></code></pre></div>
</div>
<p>What follows is the Python function used to generate the OpenCL code.</p>
<div class="annotated-code">
<p><span><em>«generate-twiddle-array»=</em></span></p>
<div class="sourceCode" id="generate-twiddle-array"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-twiddle-array-1"><a href="#generate-twiddle-array-1" aria-hidden="true"></a><span class="kw">def</span> generate_twiddle_array(parity_splitting: ParitySplitting):</span>
<span id="generate-twiddle-array-2"><a href="#generate-twiddle-array-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="generate-twiddle-array-3"><a href="#generate-twiddle-array-3" aria-hidden="true"></a><span class="co">    Generate OpenCL constant array for twiddle factors</span></span>
<span id="generate-twiddle-array-4"><a href="#generate-twiddle-array-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="generate-twiddle-array-5"><a href="#generate-twiddle-array-5" aria-hidden="true"></a>    template <span class="op">=</span> template_environment.get_template(<span class="st">&quot;twiddles.cl&quot;</span>)</span>
<span id="generate-twiddle-array-6"><a href="#generate-twiddle-array-6" aria-hidden="true"></a>    twiddles <span class="op">=</span> numpy.ones(shape<span class="op">=</span>[parity_splitting.radix, parity_splitting.radix])</span>
<span id="generate-twiddle-array-7"><a href="#generate-twiddle-array-7" aria-hidden="true"></a>    perm <span class="op">=</span> numpy.array([comp_perm(parity_splitting.radix, i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(parity_splitting.M)])</span>
<span id="generate-twiddle-array-8"><a href="#generate-twiddle-array-8" aria-hidden="true"></a></span>
<span id="generate-twiddle-array-9"><a href="#generate-twiddle-array-9" aria-hidden="true"></a>    n <span class="op">=</span> parity_splitting.radix</span>
<span id="generate-twiddle-array-10"><a href="#generate-twiddle-array-10" aria-hidden="true"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(parity_splitting.depth <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="generate-twiddle-array-11"><a href="#generate-twiddle-array-11" aria-hidden="true"></a>        w <span class="op">=</span> make_twiddle(parity_splitting.radix, n).conj()</span>
<span id="generate-twiddle-array-12"><a href="#generate-twiddle-array-12" aria-hidden="true"></a>        w_r_x <span class="op">=</span> (numpy.ones(shape<span class="op">=</span>[parity_splitting.M <span class="op">//</span> n, parity_splitting.radix, n]) <span class="op">*</span> w) <span class="op">\</span></span>
<span id="generate-twiddle-array-13"><a href="#generate-twiddle-array-13" aria-hidden="true"></a>            .transpose([<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>]) <span class="op">\</span></span>
<span id="generate-twiddle-array-14"><a href="#generate-twiddle-array-14" aria-hidden="true"></a>            .reshape([<span class="op">-</span><span class="dv">1</span>, parity_splitting.radix])[perm]</span>
<span id="generate-twiddle-array-15"><a href="#generate-twiddle-array-15" aria-hidden="true"></a>        twiddles <span class="op">=</span> numpy.r_[twiddles, w_r_x]</span>
<span id="generate-twiddle-array-16"><a href="#generate-twiddle-array-16" aria-hidden="true"></a>        n <span class="op">*=</span> parity_splitting.radix</span>
<span id="generate-twiddle-array-17"><a href="#generate-twiddle-array-17" aria-hidden="true"></a></span>
<span id="generate-twiddle-array-18"><a href="#generate-twiddle-array-18" aria-hidden="true"></a>    <span class="cf">return</span> template.render(radix<span class="op">=</span>parity_splitting.radix,</span>
<span id="generate-twiddle-array-19"><a href="#generate-twiddle-array-19" aria-hidden="true"></a>                           W<span class="op">=</span>twiddles)</span></code></pre></div>
</div>
<h2 id="index-functions-1">Index functions</h2>
<p>This is the parameterized OpenCL code used to compute indices.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/indices.cl»=</em></span></p>
<div class="sourceCode" id="cb27" data-file="fftsynth/templates/indices.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a><span class="kw">inline</span> <span class="dt">int</span> comp_idx_{{ radix }}(<span class="dt">int</span> i, <span class="dt">int</span> k)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a>{</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a>    <span class="dt">int</span> rem = i % ipow(k);</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true"></a>    <span class="dt">int</span> base = i - rem;</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true"></a>    <span class="kw">return</span> MULR(base) + rem;</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true"></a>}</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true"></a><span class="kw">inline</span> <span class="dt">int</span> comp_perm_{{ radix }}(<span class="dt">int</span> i, <span class="dt">int</span> rem)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true"></a>{</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true"></a>    <span class="dt">int</span> p = parity_{{ radix }}(i);</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true"></a>    <span class="kw">return</span> MULR(i) + MODR(rem + {{ radix }} - p);</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<p>What follows is the Python function used to generate the OpenCL code.</p>
<div class="annotated-code">
<p><span><em>«generate-index-functions»=</em></span></p>
<div class="sourceCode" id="generate-index-functions"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-index-functions-1"><a href="#generate-index-functions-1" aria-hidden="true"></a><span class="kw">def</span> generate_index_functions(parity_splitting: ParitySplitting):</span>
<span id="generate-index-functions-2"><a href="#generate-index-functions-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="generate-index-functions-3"><a href="#generate-index-functions-3" aria-hidden="true"></a><span class="co">    Generate inline OpenCL function to compute indices and permutations of the indices.</span></span>
<span id="generate-index-functions-4"><a href="#generate-index-functions-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="generate-index-functions-5"><a href="#generate-index-functions-5" aria-hidden="true"></a>    template <span class="op">=</span> template_environment.get_template(<span class="st">&quot;indices.cl&quot;</span>)</span>
<span id="generate-index-functions-6"><a href="#generate-index-functions-6" aria-hidden="true"></a></span>
<span id="generate-index-functions-7"><a href="#generate-index-functions-7" aria-hidden="true"></a>    <span class="cf">return</span> template.render(radix<span class="op">=</span>parity_splitting.radix)</span></code></pre></div>
</div>
<h2 id="utilities">Utilities</h2>
<p>This is the parameterized OpenCL code used to compute the integer power of a radix.</p>
<div class="annotated-code">
<p><span><em>«fftsynth/templates/ipow.cl»=</em></span></p>
<div class="sourceCode" id="cb28" data-file="fftsynth/templates/ipow.cl"><pre class="sourceCode opencl"><code class="sourceCode opencl"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a>{% <span class="kw">if</span> radix == <span class="dv">2</span> %}</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true"></a><span class="kw">inline</span> <span class="dt">int</span> ipow(<span class="dt">int</span> b)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true"></a>{</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true"></a>    <span class="kw">return</span> <span class="dv">1</span> &lt;&lt; b;</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true"></a>}</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true"></a>{% elif radix == <span class="dv">4</span> %}</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true"></a><span class="kw">inline</span> <span class="dt">int</span> ipow(<span class="dt">int</span> b)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true"></a>{</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true"></a>    <span class="kw">return</span> <span class="dv">1</span> &lt;&lt; (<span class="dv">2</span>*b);</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true"></a>}</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true"></a>{% <span class="kw">else</span> %}</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true"></a><span class="kw">inline</span> <span class="dt">int</span> ipow(<span class="dt">int</span> b)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true"></a>{</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true"></a>    <span class="dt">int</span> i, j;</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true"></a>    <span class="dt">int</span> a = {{ radix }};</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true"></a>    <span class="ot">#pragma unroll</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true"></a>    <span class="kw">for</span> (i = <span class="dv">0</span>, j = <span class="dv">1</span>; i &lt; b; ++i, j*=a);</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true"></a>    <span class="kw">return</span> j;</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true"></a>}</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true"></a>{% endif %}</span></code></pre></div>
</div>
<p>What follows is the Python function used to generate the OpenCL code.</p>
<div class="annotated-code">
<p><span><em>«generate-ipow-function»=</em></span></p>
<div class="sourceCode" id="generate-ipow-function"><pre class="sourceCode python"><code class="sourceCode python"><span id="generate-ipow-function-1"><a href="#generate-ipow-function-1" aria-hidden="true"></a><span class="kw">def</span> generate_ipow_function(parity_splitting: ParitySplitting):</span>
<span id="generate-ipow-function-2"><a href="#generate-ipow-function-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="generate-ipow-function-3"><a href="#generate-ipow-function-3" aria-hidden="true"></a><span class="co">    Generate inline OpenCL function to compute the integer power of a radix.</span></span>
<span id="generate-ipow-function-4"><a href="#generate-ipow-function-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="generate-ipow-function-5"><a href="#generate-ipow-function-5" aria-hidden="true"></a>    template <span class="op">=</span> template_environment.get_template(<span class="st">&quot;ipow.cl&quot;</span>)</span>
<span id="generate-ipow-function-6"><a href="#generate-ipow-function-6" aria-hidden="true"></a></span>
<span id="generate-ipow-function-7"><a href="#generate-ipow-function-7" aria-hidden="true"></a>    <span class="cf">return</span> template.render(radix<span class="op">=</span>parity_splitting.radix)</span></code></pre></div>
</div>
</div></main>

<footer class="py-4 bg-dark text-white-50 footer"><div class="container">
Generated from the Entangled Bootstrap template.<br />
2021-04-12 — version: 0.1.0
</div></footer>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script type="text/javascript" src="js/bootstrap.js"></script>
</body>
</html>
