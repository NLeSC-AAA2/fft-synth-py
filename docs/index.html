<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Johan Hidding, Ben van Werkhoven, Netherlands eScience Center" />
  <title>FFT Synthesis for OpenCL on FPGA</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="css/bootstrap.css" />
  <link rel="stylesheet" href="css/mods.css" />
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  
  <!-- pandoc-eqnos: equation style -->
  <style>
    .eqnos { display: inline-block; position: relative; width: 100%; }
    .eqnos br { display: none; }
    .eqnos-number { position: absolute; right: 0em; top: 50%; line-height: 0; }
  </style>
<!-- <script data-main="scripts/main" src="js/require.js"></script> -->
  <!-- Load React. -->
  <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
<!--  <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script> -->


</head>
<body class="d-flex flex-column">

<nav id="TOC" class="navbar navbar-dark bg-dark">
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a href="#" class="ml-5 mr-auto navbar-brand">FFT Synthesis for OpenCL on FPGA<br><span style="font-size: smaller"> by <i>Johan Hidding, Ben van Werkhoven, Netherlands eScience Center</i></span></a>
<div class="collapse navbar-collapse" id="navbarSupportedContent">
<ul>
<li><a href="#about">About</a></li>
<li><a href="#cooley-tukey-algorithm">Cooley-Tukey algorithm</a></li>
<li><a href="#parity-splitting">Parity splitting</a></li>
<li><a href="#fused-multiply-add-codelets">Fused-Multiply-Add codelets</a></li>
</ul>
</div>
</nav>

<!-- <nav class="navbar navbar-dark navbar-expand-md bg-dark mb-4">
<p class="author">Johan Hidding, Ben van Werkhoven, Netherlands eScience Center</p>
</nav>
 -->

<main role="main" class="flex-fill"><div class="container my-5">
<h1 id="about">About</h1>
<h2 id="license">License</h2>
<p>Copyright 2020 Johan Hidding, Ben van Werkhoven, Netherlands eScience Center</p>
<blockquote>
<p>This template is licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>; you may not use this file except in compliance with the License. You may obtain a copy of the License at</p>
<pre><code>http://www.apache.org/licenses/LICENSE-2.0</code></pre>
<p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an “AS IS” BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</p>
</blockquote>
<h2 id="version">Version</h2>
<div class="annotated-code">
<p><span><em>«fftsynth/__init__.py»=</em></span></p>
<div class="sourceCode" id="cb2" data-file="fftsynth/__init__.py"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" title="1">__version__ <span class="op">=</span> <span class="st">&quot;0.1.0&quot;</span></a></code></pre></div>
</div>
<h1 id="cooley-tukey-algorithm">Cooley-Tukey algorithm</h1>
<p>(sampled from Frigo 1999. I changed array indices to <span class="math inline">\(k, l, m\)</span>, <span class="math inline">\(n\)</span> denoting the length of the array.)</p>
<p>The (forward) discrete Fourier transform of <span class="math inline">\(X\)</span> is the array <span class="math inline">\(Y\)</span> given by</p>
<p><span id="eq:dft" class="eqnos"><span class="math display">\[Y[l] = \sum_{k=0}^{n-1} X[k] w_n^{-kl},\]</span><span class="eqnos-number">(1)</span></span> </p>
<p>where</p>
<p><span id="eq:wn" class="eqnos"><span class="math display">\[w_n = \exp\left(\frac{2\pi i}{n}\right).\]</span><span class="eqnos-number">(2)</span></span> </p>
<p>So <span class="math inline">\(w_n^{-kl}\)</span> denotes <span class="math inline">\(w_n\)</span> <em>to the power of</em> <span class="math inline">\(-kl\)</span>.</p>
<p>In the case that <span class="math inline">\(X\)</span> is real valued, <span class="math inline">\(Y\)</span> will have <em>hermitian symmetry</em></p>
<p><span id="eq:hermitian-symmetry" class="eqnos"><span class="math display">\[Y[n - k] = Y^*[k].\]</span><span class="eqnos-number">(3)</span></span> </p>
<p>The backward DFT flips the sign at the exponent of <span class="math inline">\(w_n\)</span>, giving</p>
<p><span id="eq:idft" class="eqnos"><span class="math display">\[Y[l] = \sum_{k=0}^{n-1} X[k] w_n^{kl}.\]</span><span class="eqnos-number">(4)</span></span> </p>
<p>Now suppose that <span class="math inline">\(n\)</span> can be factored into <span class="math inline">\(n = n_1 n_2\)</span>. We may now view the arrays <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> in a rectangular shape, where</p>
<p><span class="math display">\[X[k] = X[k_1 n_2 + k_2] = X[k_1, k_2].\]</span></p>
<p>Also, let <span class="math inline">\(Y\)</span> take the transposed shape of <span class="math inline">\(X\)</span>,</p>
<p><span class="math display">\[Y[l] = Y[l_1 + l_2 n_1] = Y[l_1, l_2].\]</span></p>
<p>Then eq. <a href="#eq:dft">1</a> can be written as</p>
<p><span class="math display">\[Y[l_1, l_2] = \sum_{k_2 = 0}^{n_2 - 1} \left[\left(\sum_{k_1 = 0}^{n_1-1} X[k_1, k_2] w_{n_1}^{-k_1 l_1}\right) w_n^{l_1 k_2}\right] w_{n_2}^{-l_2 k_2}.\]</span></p>
<p>Also known as the <strong>Cooley-Tukey fast Fourier transform</strong>.</p>
<p>This separates the DFT in an inner and outer transform, of sizes <span class="math inline">\(n_1\)</span> and <span class="math inline">\(n_2\)</span>. The output of the inner transform is multiplied by <strong>twiddle factors</strong> <span class="math inline">\(w_n^{-l_1 k_2}\)</span>, before the outer transform is done.</p>
<h1 id="parity-splitting">Parity splitting</h1>
<h2 id="radix-n-data-streamlining">Radix-n data streamlining</h2>
<p>For a radix-2 FFT, it is possible to divide input data in such a way that every butterfly operation reads and writes to two different arrays in memory. This could be advantageous for an implementation on the FPGA. The trick is to separate data locations based on the parity of their index.</p>
<h3 id="parity">Parity</h3>
<p>The index of each element in the array can be written in binary. In the case of a radix-2 FFT, we can see the array being reshaped in a <span class="math inline">\([2, 2, 2, \dots]\)</span> shape. Every stage of the <span class="math inline">\(n=2^k\)</span> sized radix-2 FFT is being performed in a different dimension of the <span class="math inline">\(k\)</span>-dimensional reshaped array. The indexing in this multi-dimensional array is the same as the binary notation for the linear index. That means that each time the 2-FFT is performed, the multi-index of the elements involved will differ by one bit in the linear index. Separating the array based on the parity of the index will guarantee that each 2-FFT operation reads and writes one (complex) number from each set. The parity is the sum of all the individual bits, modulo 2.</p>
<p><span class="math display">\[P_2(i) = \left(\sum_k b_k\right) \mod 2,\quad {\rm where}\, i := \sum_k b_k 2^k\]</span></p>
<p>We can extend this concept to the radix-4 FFT, on 4 data channels.</p>
<h3 id="parity-1">4-parity</h3>
<p>In the radix-4 FFT we can view the array as being reshaped to a <span class="math inline">\([4, 4, 4, \dots]\)</span> shape. The multi-index into this array is equivalent to the quarternary number notation of the linear index. Similar to the radix-2 parity, we can define the radix-4 parity as the sum of each quarternary digit in the index, modulo 4.</p>
<p><span class="math display">\[P_4(i) = \left(\sum_k q_k\right) \mod 4,\quad {\rm where}\, i := \sum_k q_k 4^k\]</span></p>
<p>This would ensure that each 4-FFT reads its data from the 4 different input channels. We define the <code>parity</code> function to work with any radix:</p>
<div class="annotated-code">
<p><span><em>«fftsynth/parity.py»=</em></span></p>
<div class="sourceCode" id="cb3" data-file="fftsynth/parity.py"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" title="1"><span class="im">from</span> numba <span class="im">import</span> jit, vectorize</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="im">import</span> math</a>
<a class="sourceLine" id="cb3-4" title="4"></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="im">from</span> functools <span class="im">import</span> partial</a>
<a class="sourceLine" id="cb3-6" title="6"><span class="im">from</span> itertools <span class="im">import</span> groupby</a>
<a class="sourceLine" id="cb3-7" title="7"><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</a>
<a class="sourceLine" id="cb3-8" title="8"></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="im">from</span> typing <span class="im">import</span> List, Mapping, Iterator, Sequence</a>
<a class="sourceLine" id="cb3-10" title="10"></a>
<a class="sourceLine" id="cb3-11" title="11"></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="at">@jit</span>(nopython<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb3-13" title="13"><span class="kw">def</span> digits(n: <span class="bu">int</span>, i: <span class="bu">int</span>) <span class="op">-&gt;</span> List[<span class="bu">int</span>]:</a>
<a class="sourceLine" id="cb3-14" title="14">    <span class="co">&quot;&quot;&quot;Generates the n-numbered digits of i, in reverse order.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb3-15" title="15">    <span class="cf">while</span> <span class="va">True</span>:</a>
<a class="sourceLine" id="cb3-16" title="16">        <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb3-17" title="17">            <span class="cf">return</span></a>
<a class="sourceLine" id="cb3-18" title="18">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb3-19" title="19">            i, q <span class="op">=</span> <span class="bu">divmod</span>(i, n)</a>
<a class="sourceLine" id="cb3-20" title="20">            <span class="cf">yield</span> q</a>
<a class="sourceLine" id="cb3-21" title="21"></a>
<a class="sourceLine" id="cb3-22" title="22"></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="at">@vectorize</span>(nopython<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb3-24" title="24"><span class="kw">def</span> parity(n: <span class="bu">int</span>, i: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</a>
<a class="sourceLine" id="cb3-25" title="25">    <span class="co">&quot;&quot;&quot;Computes the n-parity of a number i.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb3-26" title="26">    x <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb3-27" title="27">    <span class="cf">for</span> j <span class="kw">in</span> digits(n, i):</a>
<a class="sourceLine" id="cb3-28" title="28">        x <span class="op">+=</span> j</a>
<a class="sourceLine" id="cb3-29" title="29">    <span class="cf">return</span> x <span class="op">%</span> n</a>
<a class="sourceLine" id="cb3-30" title="30"></a>
<a class="sourceLine" id="cb3-31" title="31"><span class="op">&lt;&lt;</span>parity<span class="op">-</span>channels<span class="op">&gt;&gt;</span></a>
<a class="sourceLine" id="cb3-32" title="32"><span class="op">&lt;&lt;</span>parity<span class="op">-</span>index<span class="op">-</span>functions<span class="op">&gt;&gt;</span></a>
<a class="sourceLine" id="cb3-33" title="33"><span class="op">&lt;&lt;</span>parity<span class="op">-</span>splitting<span class="op">-</span>interface<span class="op">&gt;&gt;</span></a></code></pre></div>
</div>
<p>Using the parity function we can determine which index belongs to which channel</p>
<div class="annotated-code">
<p><span><em>«parity-channels»=</em></span></p>
<div class="sourceCode" id="parity-channels"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="parity-channels-1" title="1"><span class="kw">def</span> channels(N: <span class="bu">int</span>, radix: <span class="bu">int</span>) <span class="op">-&gt;</span> Mapping[<span class="bu">int</span>, Iterator[<span class="bu">int</span>]]:</a>
<a class="sourceLine" id="parity-channels-2" title="2">    <span class="co">&quot;&quot;&quot;Given a 1-d contiguous array of size N, and a FFT of given radix,</span></a>
<a class="sourceLine" id="parity-channels-3" title="3"><span class="co">    this returns a map of iterators of the different memory channels.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="parity-channels-4" title="4">    parity_r <span class="op">=</span> partial(parity, radix)</a>
<a class="sourceLine" id="parity-channels-5" title="5">    <span class="cf">return</span> groupby(<span class="bu">sorted</span>(<span class="bu">range</span>(N), key<span class="op">=</span>parity_r), parity_r)</a></code></pre></div>
</div>
<p>For instance, for radix-2, size 16, this creates the following channels</p>
<div class="annotated-code">
<p><span><em>«parity»=</em></span></p>
<div class="sourceCode" id="parity"><pre class="sourceCode python doctest"><code class="sourceCode python"><a class="sourceLine" id="parity-1" title="1"><span class="im">from</span> fftsynth.parity <span class="im">import</span> channels</a>
<a class="sourceLine" id="parity-2" title="2"></a>
<a class="sourceLine" id="parity-3" title="3"><span class="cf">for</span> (g, i) <span class="kw">in</span> channels(<span class="dv">16</span>, <span class="dv">2</span>):</a>
<a class="sourceLine" id="parity-4" title="4">    <span class="bu">print</span>(g, <span class="bu">list</span>(i))</a>
<a class="sourceLine" id="parity-5" title="5"><span class="op">---</span></a>
<a class="sourceLine" id="parity-6" title="6"><span class="dv">0</span> [<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">15</span>]</a>
<a class="sourceLine" id="parity-7" title="7"><span class="dv">1</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">11</span>, <span class="dv">13</span>, <span class="dv">14</span>]</a></code></pre></div>
</div>
<p>and for a radix-4, size 64 fft, this creates the following channels</p>
<div class="annotated-code">
<p><span><em>«parity»+</em></span></p>
<div class="sourceCode" id="parity"><pre class="sourceCode python doctest"><code class="sourceCode python"><a class="sourceLine" id="parity-1" title="1"><span class="im">from</span> fftsynth.parity <span class="im">import</span> channels</a>
<a class="sourceLine" id="parity-2" title="2"></a>
<a class="sourceLine" id="parity-3" title="3"><span class="cf">for</span> (g, i) <span class="kw">in</span> channels(<span class="dv">16</span>, <span class="dv">2</span>):</a>
<a class="sourceLine" id="parity-4" title="4">    <span class="bu">print</span>(g, <span class="bu">list</span>(i))</a>
<a class="sourceLine" id="parity-5" title="5"><span class="op">---</span></a>
<a class="sourceLine" id="parity-6" title="6"><span class="dv">0</span> [<span class="dv">0</span>, <span class="dv">7</span>, <span class="dv">10</span>, <span class="dv">13</span>, <span class="dv">19</span>, <span class="dv">22</span>, <span class="dv">25</span>, <span class="dv">28</span>, <span class="dv">34</span>, <span class="dv">37</span>, <span class="dv">40</span>, <span class="dv">47</span>, <span class="dv">49</span>, <span class="dv">52</span>, <span class="dv">59</span>, <span class="dv">62</span>]</a>
<a class="sourceLine" id="parity-7" title="7"><span class="dv">1</span> [<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">11</span>, <span class="dv">14</span>, <span class="dv">16</span>, <span class="dv">23</span>, <span class="dv">26</span>, <span class="dv">29</span>, <span class="dv">35</span>, <span class="dv">38</span>, <span class="dv">41</span>, <span class="dv">44</span>, <span class="dv">50</span>, <span class="dv">53</span>, <span class="dv">56</span>, <span class="dv">63</span>]</a>
<a class="sourceLine" id="parity-8" title="8"><span class="dv">2</span> [<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">8</span>, <span class="dv">15</span>, <span class="dv">17</span>, <span class="dv">20</span>, <span class="dv">27</span>, <span class="dv">30</span>, <span class="dv">32</span>, <span class="dv">39</span>, <span class="dv">42</span>, <span class="dv">45</span>, <span class="dv">51</span>, <span class="dv">54</span>, <span class="dv">57</span>, <span class="dv">60</span>]</a>
<a class="sourceLine" id="parity-9" title="9"><span class="dv">3</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>, <span class="dv">18</span>, <span class="dv">21</span>, <span class="dv">24</span>, <span class="dv">31</span>, <span class="dv">33</span>, <span class="dv">36</span>, <span class="dv">43</span>, <span class="dv">46</span>, <span class="dv">48</span>, <span class="dv">55</span>, <span class="dv">58</span>, <span class="dv">61</span>]</a></code></pre></div>
</div>
<h2 id="index-functions">Index functions</h2>
<div class="annotated-code">
<p><span><em>«parity-index-functions»=</em></span></p>
<div class="sourceCode" id="parity-index-functions"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="parity-index-functions-1" title="1"><span class="kw">def</span> comp_idx(radix: <span class="bu">int</span>, i: <span class="bu">int</span>, j: <span class="bu">int</span>, k: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</a>
<a class="sourceLine" id="parity-index-functions-2" title="2">    base <span class="op">=</span> (i <span class="op">&amp;</span> <span class="op">~</span>(radix<span class="op">**</span>k <span class="op">-</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="parity-index-functions-3" title="3">    rem  <span class="op">=</span> (i <span class="op">&amp;</span>  (radix<span class="op">**</span>k <span class="op">-</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="parity-index-functions-4" title="4">    <span class="cf">return</span> rem <span class="op">+</span> j <span class="op">*</span> radix<span class="op">**</span>k <span class="op">+</span> base <span class="op">*</span> radix</a>
<a class="sourceLine" id="parity-index-functions-5" title="5"></a>
<a class="sourceLine" id="parity-index-functions-6" title="6"></a>
<a class="sourceLine" id="parity-index-functions-7" title="7"><span class="kw">def</span> comp_perm(radix: <span class="bu">int</span>, i: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</a>
<a class="sourceLine" id="parity-index-functions-8" title="8">    base <span class="op">=</span> (i <span class="op">&amp;</span> <span class="op">~</span>(radix <span class="op">-</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="parity-index-functions-9" title="9">    rem <span class="op">=</span> (i <span class="op">&amp;</span> (radix <span class="op">-</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="parity-index-functions-10" title="10">    p <span class="op">=</span> parity(radix, base)</a>
<a class="sourceLine" id="parity-index-functions-11" title="11">    <span class="cf">return</span> base <span class="op">|</span> ((rem <span class="op">-</span> p) <span class="op">%</span> radix)</a></code></pre></div>
</div>
<h2 id="interface">Interface</h2>
<p>This interface should ease the implementation of the parity-splitting FFT.</p>
<div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#parity-splitting-interface-container" aria-controls="parity-splitting-interface-container">&lt;&lt;parity-splitting-interface&gt;&gt;=</button>
<div id="parity-splitting-interface-container" class="collapse">
<div class="sourceCode" id="parity-splitting-interface" style="max-height: 50vh"><pre class="sourceCode python bootstrap-fold overflow-auto"><code class="sourceCode python"><a class="sourceLine" id="parity-splitting-interface-1" title="1"><span class="at">@dataclass</span></a>
<a class="sourceLine" id="parity-splitting-interface-2" title="2"><span class="kw">class</span> ParitySplitting:</a>
<a class="sourceLine" id="parity-splitting-interface-3" title="3">    <span class="co">&quot;&quot;&quot;Collects a lot of properties on the parity-splitting FFT algorithm.</span></a>
<a class="sourceLine" id="parity-splitting-interface-4" title="4"><span class="co">    This algorithm splits memory access for radix-n algorithms into n</span></a>
<a class="sourceLine" id="parity-splitting-interface-5" title="5"><span class="co">    chunks, such that each chunk is only accessed once for each butterfly</span></a>
<a class="sourceLine" id="parity-splitting-interface-6" title="6"><span class="co">    operation. Pseudo code:</span></a>
<a class="sourceLine" id="parity-splitting-interface-7" title="7"></a>
<a class="sourceLine" id="parity-splitting-interface-8" title="8"><span class="co">        for k in range(depth):</span></a>
<a class="sourceLine" id="parity-splitting-interface-9" title="9"><span class="co">            for i in range(L):</span></a>
<a class="sourceLine" id="parity-splitting-interface-10" title="10"><span class="co">                for j in range(radix):</span></a>
<a class="sourceLine" id="parity-splitting-interface-11" title="11"><span class="co">                    fft(*permute(chunks), W)</span></a>
<a class="sourceLine" id="parity-splitting-interface-12" title="12"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="parity-splitting-interface-13" title="13">    N: <span class="bu">int</span></a>
<a class="sourceLine" id="parity-splitting-interface-14" title="14">    radix: <span class="bu">int</span></a>
<a class="sourceLine" id="parity-splitting-interface-15" title="15">    </a>
<a class="sourceLine" id="parity-splitting-interface-16" title="16">    <span class="at">@property</span></a>
<a class="sourceLine" id="parity-splitting-interface-17" title="17">    <span class="kw">def</span> depth(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</a>
<a class="sourceLine" id="parity-splitting-interface-18" title="18">        <span class="co">&quot;&quot;&quot;radix-log of FFT size&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="parity-splitting-interface-19" title="19">        <span class="cf">return</span> <span class="bu">int</span>(math.log(<span class="va">self</span>.N, <span class="va">self</span>.radix))</a>
<a class="sourceLine" id="parity-splitting-interface-20" title="20">    </a>
<a class="sourceLine" id="parity-splitting-interface-21" title="21">    <span class="at">@property</span></a>
<a class="sourceLine" id="parity-splitting-interface-22" title="22">    <span class="kw">def</span> M(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</a>
<a class="sourceLine" id="parity-splitting-interface-23" title="23">        <span class="co">&quot;&quot;&quot;N // radix&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="parity-splitting-interface-24" title="24">        <span class="cf">return</span> <span class="va">self</span>.N<span class="op">//</span><span class="va">self</span>.radix</a>
<a class="sourceLine" id="parity-splitting-interface-25" title="25">    </a>
<a class="sourceLine" id="parity-splitting-interface-26" title="26">    <span class="at">@property</span></a>
<a class="sourceLine" id="parity-splitting-interface-27" title="27">    <span class="kw">def</span> L(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</a>
<a class="sourceLine" id="parity-splitting-interface-28" title="28">        <span class="co">&quot;&quot;&quot;N // radix**2&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="parity-splitting-interface-29" title="29">        <span class="cf">return</span> <span class="va">self</span>.M<span class="op">//</span><span class="va">self</span>.radix</a>
<a class="sourceLine" id="parity-splitting-interface-30" title="30">    </a>
<a class="sourceLine" id="parity-splitting-interface-31" title="31">    <span class="at">@property</span></a>
<a class="sourceLine" id="parity-splitting-interface-32" title="32">    <span class="kw">def</span> factors(<span class="va">self</span>) <span class="op">-&gt;</span> List[<span class="bu">int</span>]:</a>
<a class="sourceLine" id="parity-splitting-interface-33" title="33">        <span class="co">&quot;&quot;&quot;Shape of FFT&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="parity-splitting-interface-34" title="34">        <span class="cf">return</span> [<span class="va">self</span>.radix] <span class="op">*</span> <span class="va">self</span>.depth</a>
<a class="sourceLine" id="parity-splitting-interface-35" title="35">    </a>
<a class="sourceLine" id="parity-splitting-interface-36" title="36">    <span class="at">@property</span></a>
<a class="sourceLine" id="parity-splitting-interface-37" title="37">    <span class="kw">def</span> channels(<span class="va">self</span>) <span class="op">-&gt;</span> Mapping[<span class="bu">int</span>, Iterator[<span class="bu">int</span>]]:</a>
<a class="sourceLine" id="parity-splitting-interface-38" title="38">        <span class="co">&quot;&quot;&quot;Pattern for memory chunks&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="parity-splitting-interface-39" title="39">        <span class="cf">return</span> channels(<span class="va">self</span>.N, <span class="va">self</span>.radix)</a>
<a class="sourceLine" id="parity-splitting-interface-40" title="40">    </a>
<a class="sourceLine" id="parity-splitting-interface-41" title="41">    <span class="at">@property</span></a>
<a class="sourceLine" id="parity-splitting-interface-42" title="42">    <span class="kw">def</span> channel_loc(<span class="va">self</span>) <span class="op">-&gt;</span> np.ndarray:</a>
<a class="sourceLine" id="parity-splitting-interface-43" title="43">        x <span class="op">=</span> np.zeros(shape<span class="op">=</span>(<span class="va">self</span>.N,), dtype<span class="op">=</span><span class="bu">int</span>)</a>
<a class="sourceLine" id="parity-splitting-interface-44" title="44">        <span class="cf">for</span> g, i <span class="kw">in</span> <span class="va">self</span>.channels:</a>
<a class="sourceLine" id="parity-splitting-interface-45" title="45">            x[<span class="bu">list</span>(i)] <span class="op">=</span> g</a>
<a class="sourceLine" id="parity-splitting-interface-46" title="46">        <span class="cf">return</span> x.reshape(<span class="va">self</span>.factors)</a>
<a class="sourceLine" id="parity-splitting-interface-47" title="47">    </a>
<a class="sourceLine" id="parity-splitting-interface-48" title="48">    <span class="at">@property</span></a>
<a class="sourceLine" id="parity-splitting-interface-49" title="49">    <span class="kw">def</span> index_loc(<span class="va">self</span>) <span class="op">-&gt;</span> np.ndarray:</a>
<a class="sourceLine" id="parity-splitting-interface-50" title="50">        x <span class="op">=</span> np.zeros(shape<span class="op">=</span>(<span class="va">self</span>.N,), dtype<span class="op">=</span><span class="bu">int</span>)</a>
<a class="sourceLine" id="parity-splitting-interface-51" title="51">        <span class="cf">for</span> g, i <span class="kw">in</span> <span class="va">self</span>.channels:</a>
<a class="sourceLine" id="parity-splitting-interface-52" title="52">            x[<span class="bu">list</span>(i)] <span class="op">=</span> np.arange(<span class="va">self</span>.M, dtype<span class="op">=</span><span class="bu">int</span>)</a>
<a class="sourceLine" id="parity-splitting-interface-53" title="53">        <span class="cf">return</span> x.reshape(<span class="va">self</span>.factors)</a>
<a class="sourceLine" id="parity-splitting-interface-54" title="54">    </a>
<a class="sourceLine" id="parity-splitting-interface-55" title="55">    <span class="kw">def</span> mix(<span class="va">self</span>, x: np.ndarray) <span class="op">-&gt;</span> List[np.ndarray]:</a>
<a class="sourceLine" id="parity-splitting-interface-56" title="56">        <span class="cf">return</span> [x[<span class="bu">list</span>(i)].copy() <span class="cf">for</span> g, i <span class="kw">in</span> <span class="va">self</span>.channels]</a>
<a class="sourceLine" id="parity-splitting-interface-57" title="57"></a>
<a class="sourceLine" id="parity-splitting-interface-58" title="58">    <span class="kw">def</span> unmix(<span class="va">self</span>, s: Sequence[np.ndarray]) <span class="op">-&gt;</span> np.ndarray:</a>
<a class="sourceLine" id="parity-splitting-interface-59" title="59">        x <span class="op">=</span> np.zeros(shape<span class="op">=</span>(<span class="va">self</span>.N,), dtype<span class="op">=</span><span class="st">&#39;complex64&#39;</span>)</a>
<a class="sourceLine" id="parity-splitting-interface-60" title="60">        <span class="cf">for</span> g, i <span class="kw">in</span> <span class="va">self</span>.channels:</a>
<a class="sourceLine" id="parity-splitting-interface-61" title="61">            x[<span class="bu">list</span>(i)] <span class="op">=</span> s[g]</a>
<a class="sourceLine" id="parity-splitting-interface-62" title="62">        <span class="cf">return</span> x</a></code></pre></div>
</div>
</div>
<h1 id="fused-multiply-add-codelets">Fused-Multiply-Add codelets</h1>
<p>Rewriting FFT codelets to contain <strong>more</strong> floating-point operations, but increase the fraction of FP operations inside an FMA operation can increase the efficiency on some architectures.</p>
<h2 id="twiddle-factors">Twiddle factors</h2>
<p>Only half of the twiddle factors are used.</p>
<h2 id="radix-2">Radix 2</h2>
<p>A normal implementation of the radix-2 butterfly</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode opencl"><code class="sourceCode opencl"><a class="sourceLine" id="cb4-1" title="1"><span class="dt">void</span> radix2(<span class="dt">float2</span> e, <span class="dt">float2</span> o, <span class="dt">float2</span> w, <span class="dt">float2</span>* xa, <span class="dt">float2</span>* xb)</a>
<a class="sourceLine" id="cb4-2" title="2">{</a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="dt">float2</span> t = w * o;</a>
<a class="sourceLine" id="cb4-4" title="4">    *xa = e + t;</a>
<a class="sourceLine" id="cb4-5" title="5">    *xb = e - t;</a>
<a class="sourceLine" id="cb4-6" title="6">}</a></code></pre></div>
<p>This contains one complex multiplication and two complex additions, totaling four floating point multiplications and six additions.</p>
<div class="annotated-code">
<p><span><em>«fma-radix2»=</em></span></p>
<div class="sourceCode" id="fma-radix2"><pre class="sourceCode opencl"><code class="sourceCode opencl"><a class="sourceLine" id="fma-radix2-1" title="1"><span class="dt">void</span> radix2_fma(<span class="dt">float2</span> e, <span class="dt">float2</span> o, <span class="dt">float2</span> w, <span class="dt">float2</span>* xa, <span class="dt">float2</span>* xb)</a>
<a class="sourceLine" id="fma-radix2-2" title="2">{</a>
<a class="sourceLine" id="fma-radix2-3" title="3">    <span class="dt">float2</span> a = (<span class="dt">float2</span>) (-w.y * o.y + e.x, w.y * o.x + e.y);</a>
<a class="sourceLine" id="fma-radix2-4" title="4">    a += (<span class="dt">float2</span>) (w.x * o.x, w.x * o.y);</a>
<a class="sourceLine" id="fma-radix2-5" title="5">    <span class="dt">float2</span> b = <span class="dv">2</span> * e - a;</a>
<a class="sourceLine" id="fma-radix2-6" title="6"></a>
<a class="sourceLine" id="fma-radix2-7" title="7">    *xa = a;</a>
<a class="sourceLine" id="fma-radix2-8" title="8">    *xb = b;</a>
<a class="sourceLine" id="fma-radix2-9" title="9">}</a></code></pre></div>
</div>
<p>Now we have six multiplications and six additions, but they are completely contained in six FMA operations.</p>
<h2 id="higher-radix">Higher radix</h2>
<div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#fftsynth-slash-opencl-slash-fma-codelets-dot-cl-container" aria-controls="fftsynth-slash-opencl-slash-fma-codelets-dot-cl-container">&lt;&lt;fftsynth/opencl/fma-codelets.cl&gt;&gt;=</button>
<div id="fftsynth-slash-opencl-slash-fma-codelets-dot-cl-container" class="collapse">
<div class="sourceCode" id="cb5" data-file="fftsynth/opencl/fma-codelets.cl" style="max-height: 50vh"><pre class="sourceCode opencl bootstrap-fold overflow-auto"><code class="sourceCode opencl"><a class="sourceLine" id="cb5-1" title="1">&lt;&lt;fma-radix2&gt;&gt;</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3"></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="dt">void</span> radix3_fma(<span class="dt">float2</span> t0, <span class="dt">float2</span> t1, <span class="dt">float2</span> t2, <span class="dt">float2</span> w0, <span class="dt">float2</span> w1, <span class="dt">float2</span>* xa, <span class="dt">float2</span>* xb, <span class="dt">float2</span>* xc) {</a>
<a class="sourceLine" id="cb5-5" title="5"></a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="dt">float2</span> z1, s1, s2, s3, s4, s5, s6;</a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="dt">const</span> <span class="dt">float</span> c1 = <span class="fl">-0.5</span>;</a>
<a class="sourceLine" id="cb5-8" title="8">    <span class="dt">const</span> <span class="dt">float</span> c2 = <span class="fl">-0.8660254037844386</span>;</a>
<a class="sourceLine" id="cb5-9" title="9"></a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="co">//z1 = w0 * t1</span></a>
<a class="sourceLine" id="cb5-11" title="11">    z1 = (<span class="dt">float2</span>) (w0.x * t1.x - w0.y * t1.y,</a>
<a class="sourceLine" id="cb5-12" title="12">                   w0.x * t1.y + w0.y * t1.x);</a>
<a class="sourceLine" id="cb5-13" title="13"></a>
<a class="sourceLine" id="cb5-14" title="14">    <span class="co">//s1 = z1 - w1 * t2</span></a>
<a class="sourceLine" id="cb5-15" title="15">    s1 = (<span class="dt">float2</span>) (z1.x - w1.x * t2.x + w1.y * t2.y,</a>
<a class="sourceLine" id="cb5-16" title="16">                   z1.y - w1.x * t2.y - w1.y * t2.x);</a>
<a class="sourceLine" id="cb5-17" title="17"></a>
<a class="sourceLine" id="cb5-18" title="18">    <span class="co">//s2 = 2*z1 - s1</span></a>
<a class="sourceLine" id="cb5-19" title="19">    s2 = (<span class="dt">float2</span>) (<span class="dv">2</span>*z1.x - s1.x,</a>
<a class="sourceLine" id="cb5-20" title="20">                   <span class="dv">2</span>*z1.y - s1.y);</a>
<a class="sourceLine" id="cb5-21" title="21"></a>
<a class="sourceLine" id="cb5-22" title="22">    <span class="co">//s3 = s2 + t0</span></a>
<a class="sourceLine" id="cb5-23" title="23">    s3 = (<span class="dt">float2</span>) (s2.x + t0.x,</a>
<a class="sourceLine" id="cb5-24" title="24">                   s2.y + t0.y);</a>
<a class="sourceLine" id="cb5-25" title="25"></a>
<a class="sourceLine" id="cb5-26" title="26">    <span class="co">//s4 = t0 + c1*s2</span></a>
<a class="sourceLine" id="cb5-27" title="27">    s4 = (<span class="dt">float2</span>) (t0.x + c1*s2.x,</a>
<a class="sourceLine" id="cb5-28" title="28">                   t0.y + c1*s2.y);</a>
<a class="sourceLine" id="cb5-29" title="29"></a>
<a class="sourceLine" id="cb5-30" title="30">    <span class="co">//s5 = s4-i*c2*s1</span></a>
<a class="sourceLine" id="cb5-31" title="31">    s5 = (<span class="dt">float2</span>) (s4.x - c2*s1.y,</a>
<a class="sourceLine" id="cb5-32" title="32">                   s4.y + c2*s1.x);</a>
<a class="sourceLine" id="cb5-33" title="33"></a>
<a class="sourceLine" id="cb5-34" title="34">    <span class="co">//s6 = 2*s4-s5</span></a>
<a class="sourceLine" id="cb5-35" title="35">    s6 = (<span class="dt">float2</span>) (<span class="dv">2</span>*s4.x - s5.x,</a>
<a class="sourceLine" id="cb5-36" title="36">                   <span class="dv">2</span>*s4.y - s5.y);</a>
<a class="sourceLine" id="cb5-37" title="37"></a>
<a class="sourceLine" id="cb5-38" title="38">    *xa = s3;</a>
<a class="sourceLine" id="cb5-39" title="39">    *xb = s5; <span class="co">//pseudo code in paper says s6</span></a>
<a class="sourceLine" id="cb5-40" title="40">    *xc = s6; <span class="co">//pseudo code in paper says s5</span></a>
<a class="sourceLine" id="cb5-41" title="41">}</a>
<a class="sourceLine" id="cb5-42" title="42"></a>
<a class="sourceLine" id="cb5-43" title="43"></a>
<a class="sourceLine" id="cb5-44" title="44"><span class="dt">float</span> radix4_fma(<span class="dt">float2</span> t0, <span class="dt">float2</span> t1, <span class="dt">float2</span> t2, <span class="dt">float2</span> t3,</a>
<a class="sourceLine" id="cb5-45" title="45">                <span class="dt">float2</span> w0, <span class="dt">float2</span> w1,</a>
<a class="sourceLine" id="cb5-46" title="46">                <span class="dt">float2</span>* x0, <span class="dt">float2</span>* x1, <span class="dt">float2</span> *x2, <span class="dt">float2</span>* x3) {</a>
<a class="sourceLine" id="cb5-47" title="47"></a>
<a class="sourceLine" id="cb5-48" title="48">    <span class="dt">float2</span> a, b, c, d;</a>
<a class="sourceLine" id="cb5-49" title="49"></a>
<a class="sourceLine" id="cb5-50" title="50">    a = t0;     b = t2;     c = t1;     d = t3;</a>
<a class="sourceLine" id="cb5-51" title="51"></a>
<a class="sourceLine" id="cb5-52" title="52">    b = (<span class="dt">float2</span>) (a.x - w1.x * b.x + w1.y * b.y,</a>
<a class="sourceLine" id="cb5-53" title="53">                  a.y - w1.x * b.y - w1.y * b.x);</a>
<a class="sourceLine" id="cb5-54" title="54">    a = (<span class="dt">float2</span>) (<span class="dv">2</span>*a.x - b.x,</a>
<a class="sourceLine" id="cb5-55" title="55">                  <span class="dv">2</span>*a.y - b.y);</a>
<a class="sourceLine" id="cb5-56" title="56">    d = (<span class="dt">float2</span>) (c.x - w1.x * d.x + w1.y * d.y,</a>
<a class="sourceLine" id="cb5-57" title="57">                  c.y - w1.x * d.y - w1.y * d.x);</a>
<a class="sourceLine" id="cb5-58" title="58">    c = (<span class="dt">float2</span>) (<span class="dv">2</span>*c.x - d.x,</a>
<a class="sourceLine" id="cb5-59" title="59">                  <span class="dv">2</span>*c.y - d.y);</a>
<a class="sourceLine" id="cb5-60" title="60"></a>
<a class="sourceLine" id="cb5-61" title="61">    c = (<span class="dt">float2</span>) (a.x - w0.x * c.x + w0.y * c.y,</a>
<a class="sourceLine" id="cb5-62" title="62">                  a.y - w0.x * c.y - w0.y * c.x);</a>
<a class="sourceLine" id="cb5-63" title="63">    *x2 = c;</a>
<a class="sourceLine" id="cb5-64" title="64">    *x0 = (<span class="dt">float2</span>) (<span class="dv">2</span>*a.x - c.x,</a>
<a class="sourceLine" id="cb5-65" title="65">                    <span class="dv">2</span>*a.y - c.y);</a>
<a class="sourceLine" id="cb5-66" title="66"></a>
<a class="sourceLine" id="cb5-67" title="67">    <span class="co">//d = b - i*w0*d</span></a>
<a class="sourceLine" id="cb5-68" title="68">    d = (<span class="dt">float2</span>) (b.x + w0.x * d.y + w0.y * d.x,</a>
<a class="sourceLine" id="cb5-69" title="69">                  b.y - w0.x * d.x + w0.y * d.y);</a>
<a class="sourceLine" id="cb5-70" title="70">    *x1 = d;</a>
<a class="sourceLine" id="cb5-71" title="71">    *x3 = (<span class="dt">float2</span>) (<span class="dv">2</span>*b.x - d.x,</a>
<a class="sourceLine" id="cb5-72" title="72">                    <span class="dv">2</span>*b.y - d.y);</a>
<a class="sourceLine" id="cb5-73" title="73"></a>
<a class="sourceLine" id="cb5-74" title="74">    <span class="kw">return</span> <span class="fl">0.0</span>;</a>
<a class="sourceLine" id="cb5-75" title="75">}</a>
<a class="sourceLine" id="cb5-76" title="76"></a>
<a class="sourceLine" id="cb5-77" title="77"></a>
<a class="sourceLine" id="cb5-78" title="78"></a>
<a class="sourceLine" id="cb5-79" title="79"><span class="dt">float</span> radix5_fma(<span class="dt">float2</span> t0, <span class="dt">float2</span> t1, <span class="dt">float2</span> t2, <span class="dt">float2</span> t3, <span class="dt">float2</span> t4,</a>
<a class="sourceLine" id="cb5-80" title="80">                 <span class="dt">float2</span> w0, <span class="dt">float2</span> w1, <span class="dt">float2</span> w2, <span class="dt">float2</span> w3,</a>
<a class="sourceLine" id="cb5-81" title="81">                 <span class="dt">float2</span>* x0, <span class="dt">float2</span>* x1, <span class="dt">float2</span> *x2, <span class="dt">float2</span>* x3, <span class="dt">float2</span> *x4) {</a>
<a class="sourceLine" id="cb5-82" title="82"></a>
<a class="sourceLine" id="cb5-83" title="83">    <span class="dt">const</span> <span class="dt">float</span> c1 = <span class="fl">0.25</span>;                  <span class="co">// 1/4</span></a>
<a class="sourceLine" id="cb5-84" title="84">    <span class="dt">const</span> <span class="dt">float</span> c2 = <span class="fl">0.5590169943749475</span>;      <span class="co">// sqrt(5)/4</span></a>
<a class="sourceLine" id="cb5-85" title="85">    <span class="dt">const</span> <span class="dt">float</span> c3 = <span class="fl">0.6180339887498949</span>;    <span class="co">// sqrt( (5-sqrt(5))/(5+sqrt(5)) )</span></a>
<a class="sourceLine" id="cb5-86" title="86">    <span class="dt">const</span> <span class="dt">float</span> c4 = <span class="fl">0.9510565162951535</span>;    <span class="co">// 1/2 * np.sqrt(5/2 + np.sqrt(5)/2)</span></a>
<a class="sourceLine" id="cb5-87" title="87"></a>
<a class="sourceLine" id="cb5-88" title="88">    <span class="dt">float2</span> z0, z1, z2;</a>
<a class="sourceLine" id="cb5-89" title="89">    <span class="dt">float2</span> s1, s2, s3, s4, s5, s6, s7, s8, s9, s10, s11;</a>
<a class="sourceLine" id="cb5-90" title="90">    <span class="dt">float2</span> q1, q2;</a>
<a class="sourceLine" id="cb5-91" title="91"></a>
<a class="sourceLine" id="cb5-92" title="92">    <span class="co">//z0 = t0</span></a>
<a class="sourceLine" id="cb5-93" title="93">    z0 = t0;</a>
<a class="sourceLine" id="cb5-94" title="94"></a>
<a class="sourceLine" id="cb5-95" title="95">    <span class="co">//z1 = w0*t1</span></a>
<a class="sourceLine" id="cb5-96" title="96">    z1 = (<span class="dt">float2</span>) (w0.x * t1.x - w0.y * t1.y,</a>
<a class="sourceLine" id="cb5-97" title="97">                   w0.x * t1.y + w0.y * t1.x);</a>
<a class="sourceLine" id="cb5-98" title="98"></a>
<a class="sourceLine" id="cb5-99" title="99">    <span class="co">//z2 = w1*t2</span></a>
<a class="sourceLine" id="cb5-100" title="100">    z2 = (<span class="dt">float2</span>) (w1.x * t2.x - w1.y * t2.y,</a>
<a class="sourceLine" id="cb5-101" title="101">                   w1.x * t2.y + w1.y * t2.x);</a>
<a class="sourceLine" id="cb5-102" title="102"></a>
<a class="sourceLine" id="cb5-103" title="103">    <span class="co">//s1 = z1 - w3*t4</span></a>
<a class="sourceLine" id="cb5-104" title="104">    s1 = (<span class="dt">float2</span>) (z1.x - w3.x * t4.x + w3.y * t4.y,</a>
<a class="sourceLine" id="cb5-105" title="105">                   z1.y - w3.x * t4.y - w3.y * t4.x);</a>
<a class="sourceLine" id="cb5-106" title="106"></a>
<a class="sourceLine" id="cb5-107" title="107">    <span class="co">//s2 = 2*z1-s1</span></a>
<a class="sourceLine" id="cb5-108" title="108">    s2 = (<span class="dt">float2</span>) (<span class="dv">2</span>*z1.x - s1.x,</a>
<a class="sourceLine" id="cb5-109" title="109">                   <span class="dv">2</span>*z1.y - s1.y);</a>
<a class="sourceLine" id="cb5-110" title="110"></a>
<a class="sourceLine" id="cb5-111" title="111">    <span class="co">//s3 = z2 - w2*t3</span></a>
<a class="sourceLine" id="cb5-112" title="112">    s3 = (<span class="dt">float2</span>) (z2.x - w2.x * t3.x + w2.y * t3.y,</a>
<a class="sourceLine" id="cb5-113" title="113">                   z2.y - w2.x * t3.y - w2.y * t3.x);</a>
<a class="sourceLine" id="cb5-114" title="114"></a>
<a class="sourceLine" id="cb5-115" title="115">    <span class="co">//s4 = 2*z2 - s3</span></a>
<a class="sourceLine" id="cb5-116" title="116">    s4 = (<span class="dt">float2</span>) (<span class="dv">2</span>*z2.x - s3.x,</a>
<a class="sourceLine" id="cb5-117" title="117">                   <span class="dv">2</span>*z2.y - s3.y);</a>
<a class="sourceLine" id="cb5-118" title="118"></a>
<a class="sourceLine" id="cb5-119" title="119">    <span class="co">//s5 = s2+s4</span></a>
<a class="sourceLine" id="cb5-120" title="120">    s5 = (<span class="dt">float2</span>) (s2.x + s4.x,</a>
<a class="sourceLine" id="cb5-121" title="121">                   s2.y + s4.y);</a>
<a class="sourceLine" id="cb5-122" title="122"></a>
<a class="sourceLine" id="cb5-123" title="123">    <span class="co">//s6 = s2-s4</span></a>
<a class="sourceLine" id="cb5-124" title="124">    s6 = (<span class="dt">float2</span>) (s2.x - s4.x,</a>
<a class="sourceLine" id="cb5-125" title="125">                   s2.y - s4.y);</a>
<a class="sourceLine" id="cb5-126" title="126"></a>
<a class="sourceLine" id="cb5-127" title="127">    <span class="co">//s7 = z0 - c1*s5</span></a>
<a class="sourceLine" id="cb5-128" title="128">    s7 = (<span class="dt">float2</span>) (z0.x - c1*s5.x,</a>
<a class="sourceLine" id="cb5-129" title="129">                   z0.y - c1*s5.y);</a>
<a class="sourceLine" id="cb5-130" title="130"></a>
<a class="sourceLine" id="cb5-131" title="131">    <span class="co">//s8 = s7 - c2*s6</span></a>
<a class="sourceLine" id="cb5-132" title="132">    s8 = (<span class="dt">float2</span>) (s7.x - c2*s6.x,</a>
<a class="sourceLine" id="cb5-133" title="133">                   s7.y - c2*s6.y);</a>
<a class="sourceLine" id="cb5-134" title="134"></a>
<a class="sourceLine" id="cb5-135" title="135">    <span class="co">//s9 = 2*s7 - s8</span></a>
<a class="sourceLine" id="cb5-136" title="136">    s9 = (<span class="dt">float2</span>) (<span class="dv">2</span>*s7.x - s8.x,</a>
<a class="sourceLine" id="cb5-137" title="137">                   <span class="dv">2</span>*s7.y - s8.y);</a>
<a class="sourceLine" id="cb5-138" title="138"></a>
<a class="sourceLine" id="cb5-139" title="139">    <span class="co">//s10 = s1 + c3*s3</span></a>
<a class="sourceLine" id="cb5-140" title="140">    s10 = (<span class="dt">float2</span>) (s1.x + c3*s3.x,</a>
<a class="sourceLine" id="cb5-141" title="141">                    s1.y + c3*s3.y);</a>
<a class="sourceLine" id="cb5-142" title="142"></a>
<a class="sourceLine" id="cb5-143" title="143">    <span class="co">//s11 = c3*s1 - s3</span></a>
<a class="sourceLine" id="cb5-144" title="144">    s11 = (<span class="dt">float2</span>) (c3*s1.x - s3.x,</a>
<a class="sourceLine" id="cb5-145" title="145">                    c3*s1.y - s3.y);</a>
<a class="sourceLine" id="cb5-146" title="146"></a>
<a class="sourceLine" id="cb5-147" title="147">    <span class="co">// *x0 = z0 + s5</span></a>
<a class="sourceLine" id="cb5-148" title="148">    *x0 = (<span class="dt">float2</span>) (z0.x + s5.x,</a>
<a class="sourceLine" id="cb5-149" title="149">                    z0.y + s5.y);</a>
<a class="sourceLine" id="cb5-150" title="150"></a>
<a class="sourceLine" id="cb5-151" title="151">    <span class="co">//q1 = s9 - i*c4*s10</span></a>
<a class="sourceLine" id="cb5-152" title="152">    q1 = (<span class="dt">float2</span>) (s9.x - c4*s10.y,</a>
<a class="sourceLine" id="cb5-153" title="153">                   s9.y + c4*s10.x);</a>
<a class="sourceLine" id="cb5-154" title="154"></a>
<a class="sourceLine" id="cb5-155" title="155">    <span class="co">// *x1 = 2*s9 - q1</span></a>
<a class="sourceLine" id="cb5-156" title="156">    *x1 = (<span class="dt">float2</span>) (<span class="dv">2</span>*s9.x - q1.x,</a>
<a class="sourceLine" id="cb5-157" title="157">                    <span class="dv">2</span>*s9.y - q1.y);</a>
<a class="sourceLine" id="cb5-158" title="158"></a>
<a class="sourceLine" id="cb5-159" title="159">    <span class="co">//q2 = s8 - i*c4*s11</span></a>
<a class="sourceLine" id="cb5-160" title="160">    q2 = (<span class="dt">float2</span>) (s8.x - c4*s11.y,</a>
<a class="sourceLine" id="cb5-161" title="161">                   s8.y + c4*s11.x);</a>
<a class="sourceLine" id="cb5-162" title="162"></a>
<a class="sourceLine" id="cb5-163" title="163">    <span class="co">// *x2 = 2*s8-q2</span></a>
<a class="sourceLine" id="cb5-164" title="164">    *x2 = (<span class="dt">float2</span>) (<span class="dv">2</span>*s8.x - q2.x,</a>
<a class="sourceLine" id="cb5-165" title="165">                    <span class="dv">2</span>*s8.y - q2.y);</a>
<a class="sourceLine" id="cb5-166" title="166"></a>
<a class="sourceLine" id="cb5-167" title="167">    <span class="co">// *x3 = q2</span></a>
<a class="sourceLine" id="cb5-168" title="168">    *x3 = q2;</a>
<a class="sourceLine" id="cb5-169" title="169"></a>
<a class="sourceLine" id="cb5-170" title="170">    <span class="co">// *x4 = q1 </span></a>
<a class="sourceLine" id="cb5-171" title="171">    *x4 = q1;</a>
<a class="sourceLine" id="cb5-172" title="172"></a>
<a class="sourceLine" id="cb5-173" title="173"></a>
<a class="sourceLine" id="cb5-174" title="174">}</a>
<a class="sourceLine" id="cb5-175" title="175"></a>
<a class="sourceLine" id="cb5-176" title="176">&lt;&lt;fma-codelet-tests&gt;&gt;</a></code></pre></div>
</div>
</div>
<h2 id="testing">Testing</h2>
<div>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#fma-codelet-tests-container" aria-controls="fma-codelet-tests-container">&lt;&lt;fma-codelet-tests&gt;&gt;=</button>
<div id="fma-codelet-tests-container" class="collapse">
<div class="sourceCode" id="fma-codelet-tests" style="max-height: 50vh"><pre class="sourceCode opencl bootstrap-fold overflow-auto"><code class="sourceCode opencl"><a class="sourceLine" id="fma-codelet-tests-1" title="1"><span class="kw">__kernel</span> <span class="dt">void</span> test_radix2(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</a>
<a class="sourceLine" id="fma-codelet-tests-2" title="2"></a>
<a class="sourceLine" id="fma-codelet-tests-3" title="3">    <span class="dt">float2</span> w = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</a>
<a class="sourceLine" id="fma-codelet-tests-4" title="4">    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>)*<span class="dv">2</span>;</a>
<a class="sourceLine" id="fma-codelet-tests-5" title="5"></a>
<a class="sourceLine" id="fma-codelet-tests-6" title="6">    <span class="co">//n is the number of radix2 ffts to perform</span></a>
<a class="sourceLine" id="fma-codelet-tests-7" title="7">    <span class="kw">if</span> (i&lt;<span class="dv">2</span>*n) {</a>
<a class="sourceLine" id="fma-codelet-tests-8" title="8">        <span class="dt">float2</span> y0, y1;</a>
<a class="sourceLine" id="fma-codelet-tests-9" title="9">        radix2_fma(x[i], x[i+<span class="dv">1</span>], w, &amp;y0, &amp;y1);</a>
<a class="sourceLine" id="fma-codelet-tests-10" title="10"></a>
<a class="sourceLine" id="fma-codelet-tests-11" title="11">        y[i] = y0; y[i+<span class="dv">1</span>] = y1;</a>
<a class="sourceLine" id="fma-codelet-tests-12" title="12">    }</a>
<a class="sourceLine" id="fma-codelet-tests-13" title="13">}</a>
<a class="sourceLine" id="fma-codelet-tests-14" title="14"></a>
<a class="sourceLine" id="fma-codelet-tests-15" title="15"></a>
<a class="sourceLine" id="fma-codelet-tests-16" title="16"><span class="kw">__kernel</span> <span class="dt">void</span> test_radix3(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</a>
<a class="sourceLine" id="fma-codelet-tests-17" title="17"></a>
<a class="sourceLine" id="fma-codelet-tests-18" title="18">    <span class="dt">float2</span> w0 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</a>
<a class="sourceLine" id="fma-codelet-tests-19" title="19">    <span class="dt">float2</span> w1 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</a>
<a class="sourceLine" id="fma-codelet-tests-20" title="20">    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>)*<span class="dv">3</span>;</a>
<a class="sourceLine" id="fma-codelet-tests-21" title="21"></a>
<a class="sourceLine" id="fma-codelet-tests-22" title="22">    <span class="co">//n is the number of radix3 ffts to perform</span></a>
<a class="sourceLine" id="fma-codelet-tests-23" title="23">    <span class="kw">if</span> (i&lt;<span class="dv">3</span>*n) {</a>
<a class="sourceLine" id="fma-codelet-tests-24" title="24">        <span class="dt">float2</span> y0, y1, y2;</a>
<a class="sourceLine" id="fma-codelet-tests-25" title="25"></a>
<a class="sourceLine" id="fma-codelet-tests-26" title="26">        radix3_fma(x[i], x[i+<span class="dv">1</span>], x[i+<span class="dv">2</span>], w0, w1, &amp;y0, &amp;y1, &amp;y2);</a>
<a class="sourceLine" id="fma-codelet-tests-27" title="27"></a>
<a class="sourceLine" id="fma-codelet-tests-28" title="28">        y[i] = y0;    y[i+<span class="dv">1</span>] = y1;    y[i+<span class="dv">2</span>] = y2;</a>
<a class="sourceLine" id="fma-codelet-tests-29" title="29">    }</a>
<a class="sourceLine" id="fma-codelet-tests-30" title="30">}</a>
<a class="sourceLine" id="fma-codelet-tests-31" title="31"></a>
<a class="sourceLine" id="fma-codelet-tests-32" title="32"></a>
<a class="sourceLine" id="fma-codelet-tests-33" title="33"><span class="kw">__kernel</span> <span class="dt">void</span> test_radix4(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</a>
<a class="sourceLine" id="fma-codelet-tests-34" title="34"></a>
<a class="sourceLine" id="fma-codelet-tests-35" title="35">    <span class="dt">float2</span> w0 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</a>
<a class="sourceLine" id="fma-codelet-tests-36" title="36">    <span class="dt">float2</span> w1 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</a>
<a class="sourceLine" id="fma-codelet-tests-37" title="37">    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>)*<span class="dv">4</span>;</a>
<a class="sourceLine" id="fma-codelet-tests-38" title="38"></a>
<a class="sourceLine" id="fma-codelet-tests-39" title="39">    <span class="co">//n is the number of radix4 ffts to perform</span></a>
<a class="sourceLine" id="fma-codelet-tests-40" title="40">    <span class="kw">if</span> (i&lt;<span class="dv">4</span>*n) {</a>
<a class="sourceLine" id="fma-codelet-tests-41" title="41">        <span class="dt">float2</span> y0, y1, y2, y3;</a>
<a class="sourceLine" id="fma-codelet-tests-42" title="42"></a>
<a class="sourceLine" id="fma-codelet-tests-43" title="43">        radix4_fma(x[i], x[i+<span class="dv">1</span>], x[i+<span class="dv">2</span>], x[i+<span class="dv">3</span>], w0, w1, &amp;y0, &amp;y1, &amp;y2, &amp;y3);</a>
<a class="sourceLine" id="fma-codelet-tests-44" title="44"></a>
<a class="sourceLine" id="fma-codelet-tests-45" title="45">        y[i] = y0;    y[i+<span class="dv">1</span>] = y1;    y[i+<span class="dv">2</span>] = y2;    y[i+<span class="dv">3</span>] = y3;</a>
<a class="sourceLine" id="fma-codelet-tests-46" title="46">    }</a>
<a class="sourceLine" id="fma-codelet-tests-47" title="47">}</a>
<a class="sourceLine" id="fma-codelet-tests-48" title="48"></a>
<a class="sourceLine" id="fma-codelet-tests-49" title="49"></a>
<a class="sourceLine" id="fma-codelet-tests-50" title="50"><span class="kw">__kernel</span> <span class="dt">void</span> test_radix5(<span class="kw">__global</span> <span class="dt">float2</span> *x, <span class="kw">__global</span> <span class="dt">float2</span> *y, <span class="dt">int</span> n) {</a>
<a class="sourceLine" id="fma-codelet-tests-51" title="51"></a>
<a class="sourceLine" id="fma-codelet-tests-52" title="52">    <span class="dt">float2</span> w0 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</a>
<a class="sourceLine" id="fma-codelet-tests-53" title="53">    <span class="dt">float2</span> w1 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</a>
<a class="sourceLine" id="fma-codelet-tests-54" title="54">    <span class="dt">float2</span> w2 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</a>
<a class="sourceLine" id="fma-codelet-tests-55" title="55">    <span class="dt">float2</span> w3 = (<span class="dt">float2</span>) (<span class="fl">1.0</span>, <span class="fl">0.0</span>);</a>
<a class="sourceLine" id="fma-codelet-tests-56" title="56">    <span class="dt">int</span> i = get_global_id(<span class="dv">0</span>)*<span class="dv">5</span>;</a>
<a class="sourceLine" id="fma-codelet-tests-57" title="57"></a>
<a class="sourceLine" id="fma-codelet-tests-58" title="58">    <span class="co">//n is the number of radix5 ffts to perform</span></a>
<a class="sourceLine" id="fma-codelet-tests-59" title="59">    <span class="kw">if</span> (i&lt;<span class="dv">5</span>*n) {</a>
<a class="sourceLine" id="fma-codelet-tests-60" title="60">        <span class="dt">float2</span> y0, y1, y2, y3, y4;</a>
<a class="sourceLine" id="fma-codelet-tests-61" title="61"></a>
<a class="sourceLine" id="fma-codelet-tests-62" title="62">        radix5_fma(x[i], x[i+<span class="dv">1</span>], x[i+<span class="dv">2</span>], x[i+<span class="dv">3</span>], x[i+<span class="dv">4</span>], w0, w1, w2, w3, &amp;y0, &amp;y1, &amp;y2, &amp;y3, &amp;y4);</a>
<a class="sourceLine" id="fma-codelet-tests-63" title="63"></a>
<a class="sourceLine" id="fma-codelet-tests-64" title="64">        y[i] = y0;    y[i+<span class="dv">1</span>] = y1;    y[i+<span class="dv">2</span>] = y2;    y[i+<span class="dv">3</span>] = y3;    y[i+<span class="dv">4</span>] = y4;</a>
<a class="sourceLine" id="fma-codelet-tests-65" title="65">    }</a>
<a class="sourceLine" id="fma-codelet-tests-66" title="66">}</a></code></pre></div>
</div>
</div>
</div></main>

<footer class="py-4 bg-dark text-white-50 footer"><div class="container">
2020-04-20 — version 0.1.0<br />
Generated from the Entangled Bootstrap template.
</div></footer>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script type="text/javascript" src="js/bootstrap.js"></script>
</body>
</html>
